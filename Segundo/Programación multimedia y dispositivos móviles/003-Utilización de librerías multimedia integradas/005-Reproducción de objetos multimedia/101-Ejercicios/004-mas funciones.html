<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pentagrama + Duraciones + 4/4 + Reproducci칩n Polif칩nica</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --ink:#111;
      --muted:#5b6270;
      --line:#e6e8ef;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
      --pad:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:var(--bg);
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .app{
      width:min(1200px, 100%);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }
    .top{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:260px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .title p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button, select{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      transition:transform .05s ease, box-shadow .15s ease;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    button:hover, select:hover{box-shadow:0 8px 18px rgba(0,0,0,.06)}
    button:active{transform:translateY(1px)}
    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 0 4px;
    }
    svg{
      width:min(1100px, 100%);
      height:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      user-select:none;
      touch-action:none;
    }
    .footer{
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    code{background:#f1f3f8;padding:2px 6px;border-radius:8px;color:#222}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="title">
        <h1>Pentagrama (Clave de Sol) 췅 4/4 췅 Editor de notas</h1>
        <p>
          Clic en vac칤o: crea nota (y suena). Clic y arrastrar sobre una nota: reubica (suena al pasar por alturas/tiempos).
          Clic derecho en una nota: eliminar.
        </p>
      </div>

      <div class="controls">
        <button id="activar">Activar audio</button>
        <button id="reproducir">Reproducir</button>
        <button id="parar">Parar</button>
        <button id="limpiar">Limpiar</button>

        <div class="pill">
          <span>Figura:</span>
          <select id="dur">
            <option value="whole">Redonda</option>
            <option value="half">Blanca</option>
            <option value="quarter" selected>Negra</option>
            <option value="eighth">Corchea</option>
            <option value="sixteenth">Semicorchea</option>
          </select>
        </div>

        <div class="pill">
          <span>Tempo:</span>
          <select id="bpm">
            <option>60</option><option>80</option><option selected>100</option><option>120</option><option>140</option>
          </select>
          <span>bpm</span>
        </div>
      </div>
    </div>

    <div class="stage">
      <svg id="score" viewBox="0 0 1100 280" role="img" aria-label="Pentagrama con compases">
        <!-- Dibujado por JS -->
      </svg>
    </div>

    <div class="footer">
      <span>Cuantizaci칩n: <code>semicorcheas</code> (rejilla de 16 por comp치s). Naturales (sin sostenidos/bemoles).</span>
      <span>Polifon칤a: s칤 (acordes y notas simult치neas).</span>
    </div>
  </div>

<script>
(() => {
  // ============================================================
  // Audio: sintetizador "piano-ish" polif칩nico (seno + parciales + filtro + ataque)
  // ============================================================
  let ctx = null;
  let master = null;
  let stopAllScheduled = null;

  function asegurarAudio() {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (ctx.state !== "running") ctx.resume();
    if (!master) {
      master = ctx.createGain();
      master.gain.value = 0.85;
      master.connect(ctx.destination);
    }
  }

  function midiAHz(m) { return 440 * Math.pow(2, (m - 69) / 12); }

  function vozPiano(midi, cuando, durSec, vel = 0.9) {
    asegurarAudio();
    const t0 = Math.max(cuando, ctx.currentTime + 0.005);
    const f0 = midiAHz(midi);

    // peque침o ataque tipo "martillo" con ruido
    const noiseDur = 0.02;
    const noiseBuf = ctx.createBuffer(1, Math.max(1, Math.floor(ctx.sampleRate * noiseDur)), ctx.sampleRate);
    {
      const data = noiseBuf.getChannelData(0);
      for (let i = 0; i < data.length; i++) data[i] = (Math.random()*2-1) * (1 - i/data.length);
    }
    const noise = ctx.createBufferSource();
    noise.buffer = noiseBuf;

    const gNoise = ctx.createGain();
    gNoise.gain.setValueAtTime(0.0001, t0);
    gNoise.gain.exponentialRampToValueAtTime(0.10 * vel, t0 + 0.003);
    gNoise.gain.exponentialRampToValueAtTime(0.0001, t0 + noiseDur);

    // banco de osciladores (m치s suave que diente de sierra)
    const o1 = ctx.createOscillator(); o1.type = "sine";     o1.frequency.setValueAtTime(f0, t0);
    const o2 = ctx.createOscillator(); o2.type = "sine";     o2.frequency.setValueAtTime(f0*2.0, t0);
    const o3 = ctx.createOscillator(); o3.type = "triangle"; o3.frequency.setValueAtTime(f0*3.0, t0);

    // leve desafinaci칩n para riqueza
    o2.detune.setValueAtTime(-4, t0);
    o3.detune.setValueAtTime(+3, t0);

    const mix = ctx.createGain();

    const g1 = ctx.createGain(); g1.gain.value = 0.90;
    const g2 = ctx.createGain(); g2.gain.value = 0.18;
    const g3 = ctx.createGain(); g3.gain.value = 0.10;

    o1.connect(g1); g1.connect(mix);
    o2.connect(g2); g2.connect(mix);
    o3.connect(g3); g3.connect(mix);

    noise.connect(gNoise);

    // envolvente
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);

    const attack = 0.004;
    const decay1  = Math.min(0.18, durSec * 0.45);
    const sustain = 0.20 * vel;
    const release = Math.min(0.12, Math.max(0.06, durSec * 0.28));

    g.gain.exponentialRampToValueAtTime(1.0 * vel, t0 + attack);
    g.gain.exponentialRampToValueAtTime(sustain, t0 + attack + decay1);

    const relStart = t0 + Math.max(0.05, durSec - release);
    g.gain.setValueAtTime(Math.max(sustain, 0.0002), relStart);
    g.gain.exponentialRampToValueAtTime(0.0001, relStart + release);

    // filtro paso bajo suave
    const filt = ctx.createBiquadFilter();
    filt.type = "lowpass";
    filt.frequency.setValueAtTime(Math.min(8000, Math.max(1200, f0 * 6)), t0);
    filt.Q.setValueAtTime(0.7, t0);

    mix.connect(g);
    gNoise.connect(g);
    g.connect(filt);
    filt.connect(master);

    noise.start(t0);
    noise.stop(t0 + noiseDur + 0.01);

    o1.start(t0); o2.start(t0); o3.start(t0);
    const tStop = relStart + release + 0.03;
    o1.stop(tStop); o2.stop(tStop); o3.stop(tStop);

    return { tStop };
  }

  // ============================================================
  // Geometr칤a del pentagrama + mapeo de altura (diat칩nico, naturales)
  // ============================================================
  const svg = document.getElementById("score");

  const W = 1100;
  const marginL = 90;
  const marginR = 30;
  const staffTop = 85;
  const spacing = 14;
  const stepH = spacing / 2;
  const staffBottomLineY = staffTop + 4 * spacing;

  // step 0 = MI4 (l칤nea inferior). Solo naturales.
  const LETRAS = ["C","D","E","F","G","A","B"];
  const SEMI = {C:0, D:2, E:4, F:5, G:7, A:9, B:11};

  function stepANota(step) {
    let letra = "E";
    let octava = 4;
    let idx = LETRAS.indexOf(letra);
    const dir = Math.sign(step);
    for (let i = 0; i < Math.abs(step); i++) {
      idx += dir;
      if (idx > 6) { idx = 0; octava += 1; }
      if (idx < 0) { idx = 6; octava -= 1; }
    }
    letra = LETRAS[idx];
    const midi = (octava + 1) * 12 + SEMI[letra];
    return { letra, octava, midi };
  }
  function stepAY(step){ return staffBottomLineY - step * stepH; }
  function yAStep(y){ return Math.round((staffBottomLineY - y) / stepH); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // ============================================================
  // Rejilla temporal: 4/4, semicorcheas (16 por comp치s)
  // ============================================================
  const subdivPorPulso = 4; // semicorcheas
  const pulsosPorCompas = 4;
  const subdivPorCompas = subdivPorPulso * pulsosPorCompas; // 16
  const gridPx = 20; // p칤xeles por semicorchea

  const usableW = (W - marginR) - marginL;
  const compasesVisibles = Math.floor(usableW / (gridPx * subdivPorCompas));
  const totalSubdivVisibles = compasesVisibles * subdivPorCompas;

  function xASubdiv(x){ return Math.round((x - marginL) / gridPx); }
  function subdivAX(sub){ return marginL + sub * gridPx; }

  const durBeats = { whole:4, half:2, quarter:1, eighth:0.5, sixteenth:0.25 };
  function beatsASeg(beats, bpm){ return (60 / bpm) * beats; }

  // ============================================================
  // Modelo de notas: {id, sub, step, dur}
  // ============================================================
  let notas = [];
  let nextId = 1;

  // ============================================================
  // Render SVG
  // ============================================================
  function limpiarSVG(){ while (svg.firstChild) svg.removeChild(svg.firstChild); }

  function el(name, attrs = {}) {
    const n = document.createElementNS("http://www.w3.org/2000/svg", name);
    for (const [k, v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    return n;
  }

  function dibujarPentagrama() {
    // l칤neas
    for (let i = 0; i < 5; i++) {
      const y = staffTop + i * spacing;
      svg.appendChild(el("line", { x1:marginL, y1:y, x2:W-marginR, y2:y, stroke:"#111", "stroke-width":1.4 }));
    }

    // clave
    const clave = el("text", { x:18, y: staffTop + 4.2*spacing, "font-size":72, "font-family":"serif", fill:"#111" });
    clave.textContent = "洧";
    svg.appendChild(clave);

    // 4/4
    const tsTop = el("text", { x:64, y: staffTop + 1.9*spacing, "font-size":28, "font-family":"serif", fill:"#111" });
    tsTop.textContent = "4";
    const tsBot = el("text", { x:64, y: staffTop + 3.8*spacing, "font-size":28, "font-family":"serif", fill:"#111" });
    tsBot.textContent = "4";
    svg.appendChild(tsTop); svg.appendChild(tsBot);

    // rejilla sutil
    for (let sub = 0; sub <= totalSubdivVisibles; sub++) {
      const x = subdivAX(sub);
      const esPulso = (sub % subdivPorPulso) === 0;
      svg.appendChild(el("line", {
        x1:x, y1:staffTop-24, x2:x, y2:staffTop + 4*spacing + 24,
        stroke:"#000",
        "stroke-opacity": esPulso ? 0.06 : 0.03,
        "stroke-width": 1
      }));
    }

    // barras de comp치s
    for (let c = 0; c <= compasesVisibles; c++) {
      const sub = c * subdivPorCompas;
      const x = subdivAX(sub);
      svg.appendChild(el("line", {
        x1:x, y1:staffTop-26, x2:x, y2:staffTop + 4*spacing + 26,
        stroke:"#111", "stroke-width": (c===0 ? 2.2 : 1.8)
      }));
    }
  }

  function dibujarLineasAdicionales(x, step) {
    const minStep = 0, maxStep = 8; // E4..F5
    const ledgers = [];
    if (step < minStep) for (let s=-2; s>=step; s-=2) ledgers.push(s);
    if (step > maxStep) for (let s=10; s<=step; s+=2) ledgers.push(s);

    for (const s of ledgers) {
      const y = stepAY(s);
      svg.appendChild(el("line", { x1:x-18, y1:y, x2:x+18, y2:y, stroke:"#111", "stroke-width":1.4 }));
    }
  }

  function dibujarBandera(xStem, yStemEnd, stemUp, cuantas) {
    for (let i=0; i<cuantas; i++) {
      const dy = i * 8;
      const y0 = stemUp ? (yStemEnd + dy) : (yStemEnd - dy);
      const path = el("path", {
        d: stemUp
          ? `M ${xStem} ${y0} Q ${xStem+10} ${y0+4} ${xStem+6} ${y0+14} Q ${xStem+2} ${y0+22} ${xStem+14} ${y0+26}`
          : `M ${xStem} ${y0} Q ${xStem-10} ${y0-4} ${xStem-6} ${y0-14} Q ${xStem-2} ${y0-22} ${xStem-14} ${y0-26}`,
        fill:"none", stroke:"#111", "stroke-width":2, "stroke-linecap":"round"
      });
      svg.appendChild(path);
    }
  }

  // --- Direcci칩n de plica mejorada (polifon칤a / agrupaci칩n por instante) ---
  // Regla simple y efectiva:
  // - Si hay acorde (varias notas en la misma subdivisi칩n): plica 칰nica seg칰n la "altura media" del acorde.
  // - Si es nota 칰nica: regla est치ndar (por debajo de la l칤nea central -> arriba; en/encima -> abajo).
  // L칈NEA CENTRAL en clave de sol: SI4 (step 4).
  function stemUpPara(step, grupoSteps) {
    if (grupoSteps && grupoSteps.length > 1) {
      const media = grupoSteps.reduce((a,b)=>a+b,0) / grupoSteps.length;
      return media < 4; // si el acorde queda "bajo", plica arriba; si "alto", plica abajo
    }
    return step < 4;
  }

  function dibujarNota(n, grupoSteps) {
    const x = subdivAX(n.sub);
    const y = stepAY(n.step);

    dibujarLineasAdicionales(x, n.step);

    const esRedonda = n.dur === "whole";
    const esBlanca  = n.dur === "half";
    const esNegra   = n.dur === "quarter";
    const esCorchea = n.dur === "eighth";
    const esSemi    = n.dur === "sixteenth";

    const rellena = esNegra || esCorchea || esSemi;

    const g = el("g", { "data-note-id": n.id, cursor:"grab" });

    const cabeza = el("ellipse", {
      cx:x, cy:y, rx:10.5, ry:7.2,
      fill: rellena ? "#111" : "#fff",
      stroke:"#111", "stroke-width":2,
      transform:`rotate(-18 ${x} ${y})`
    });

    const { letra, octava } = stepANota(n.step);
    const title = el("title");
    title.textContent = `${letra}${octava} 췅 ${n.dur}`;
    cabeza.appendChild(title);

    g.appendChild(cabeza);

    if (!esRedonda) {
      const stemUp = stemUpPara(n.step, grupoSteps);
      const xStem = stemUp ? (x + 9) : (x - 9);
      const y1 = y;
      const y2 = stemUp ? (y - 44) : (y + 44);

      const stem = el("line", {
        x1:xStem, y1:y1, x2:xStem, y2:y2,
        stroke:"#111", "stroke-width":2.2, "stroke-linecap":"round"
      });
      g.appendChild(stem);

      if (esCorchea) dibujarBandera(xStem, y2, stemUp, 1);
      if (esSemi)    dibujarBandera(xStem, y2, stemUp, 2);
    }

    // borrar con clic derecho
    g.addEventListener("contextmenu", (e) => {
      e.preventDefault();
      notas = notas.filter(x => x.id !== n.id);
      render();
    });

    svg.appendChild(g);
  }

  function render() {
    limpiarSVG();
    dibujarPentagrama();

    // Agrupar por "sub" para calcular direcci칩n de plica por acorde (polifon칤a)
    const grupoPorSub = new Map();
    for (const n of notas) {
      if (!grupoPorSub.has(n.sub)) grupoPorSub.set(n.sub, []);
      grupoPorSub.get(n.sub).push(n);
    }

    // Orden determinista
    const ordenadas = [...notas].sort((a,b)=> a.sub - b.sub || a.step - b.step);

    for (const n of ordenadas) {
      const grupo = grupoPorSub.get(n.sub) || [];
      const steps = grupo.map(x => x.step);
      dibujarNota(n, steps);
    }
  }

  // ============================================================
  // Interacci칩n: crear, arrastrar, previsualizar sonido al mover
  // ============================================================
  function puntoSVG(evt) {
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    const m = svg.getScreenCTM().inverse();
    return pt.matrixTransform(m);
  }

  function encontrarGrupoNota(target) {
    if (!target) return null;
    if (target.tagName === "g" && target.getAttribute("data-note-id")) return target;
    if (target.closest) return target.closest("g[data-note-id]");
    return null;
  }

  // Estado de arrastre
  let drag = null; // {id, offSub, offStep, lastKey, lastT}
  const PREVIEW_MIN_MS = 45;

  function previsualizar(nota) {
    const bpm = Number(document.getElementById("bpm").value);
    const beats = durBeats[nota.dur] ?? 1;
    const sec = Math.min(0.8, Math.max(0.12, beatsASeg(beats, bpm) * 0.45));
    const { midi } = stepANota(nota.step);
    vozPiano(midi, ctx ? ctx.currentTime : 0, sec, 0.85);
  }

  svg.addEventListener("mousedown", (e) => {
    const g = encontrarGrupoNota(e.target);
    if (!g) return;

    const id = Number(g.getAttribute("data-note-id"));
    const n = notas.find(nn => nn.id === id);
    if (!n) return;

    const p = puntoSVG(e);
    const subMouse = xASubdiv(p.x);
    const stepMouse = yAStep(p.y);

    drag = {
      id,
      offSub: n.sub - subMouse,
      offStep: n.step - stepMouse,
      lastKey: `${n.sub}:${n.step}`,
      lastT: performance.now()
    };

    g.setAttribute("cursor", "grabbing");
  });

  svg.addEventListener("mousemove", (e) => {
    if (!drag) return;

    const p = puntoSVG(e);
    let sub = xASubdiv(p.x) + drag.offSub;
    let step = yAStep(p.y) + drag.offStep;

    sub = clamp(sub, 0, totalSubdivVisibles);
    step = clamp(step, -2, 12);

    sub = Math.round(sub);
    step = Math.round(step);

    const n = notas.find(nn => nn.id === drag.id);
    if (!n) return;

    const changed = (n.sub !== sub) || (n.step !== step);
    if (changed) {
      n.sub = sub;
      n.step = step;
      render();

      // sonar al pasar por otra altura o instante (throttle)
      const key = `${n.sub}:${n.step}`;
      const now = performance.now();
      if (key !== drag.lastKey && (now - drag.lastT) >= PREVIEW_MIN_MS) {
        drag.lastKey = key;
        drag.lastT = now;
        previsualizar(n);
      }
    }
  });

  window.addEventListener("mouseup", () => { drag = null; });

  // Crear nota con clic en vac칤o
  svg.addEventListener("click", (e) => {
    const g = encontrarGrupoNota(e.target);
    if (g) return;     // si clicas en nota, no crear
    if (drag) return;  // si est치s arrastrando, no crear

    const p = puntoSVG(e);

    let sub = clamp(xASubdiv(p.x), 0, totalSubdivVisibles);
    let step = clamp(yAStep(p.y), -2, 12);

    const durSel = document.getElementById("dur").value;
    const n = { id: nextId++, sub: Math.round(sub), step: Math.round(step), dur: durSel };
    notas.push(n);
    render();

    // sonar al crear (polifon칤a)
    previsualizar(n);
  });

  // ============================================================
  // Reproducci칩n: polif칩nica, por rejilla temporal
  // ============================================================
  function reproducirTodo() {
    if (!notas.length) return;
    asegurarAudio();

    const bpm = Number(document.getElementById("bpm").value);
    const start = ctx.currentTime + 0.03;

    // agrupar por subdivisi칩n para acordes
    const porSub = new Map();
    for (const n of notas) {
      if (!porSub.has(n.sub)) porSub.set(n.sub, []);
      porSub.get(n.sub).push(n);
    }

    const subs = [...porSub.keys()].sort((a,b)=>a-b);
    let lastStop = start;

    for (const sub of subs) {
      const beatsDesdeInicio = sub / subdivPorPulso; // 4 subdiv = 1 pulso
      const cuando = start + beatsASeg(beatsDesdeInicio, bpm);

      for (const n of porSub.get(sub)) {
        const beats = durBeats[n.dur] ?? 1;
        const durSec = beatsASeg(beats, bpm);
        const { midi } = stepANota(n.step);

        const v = vozPiano(midi, cuando, durSec, 0.9);
        lastStop = Math.max(lastStop, v.tStop);
      }
    }

    stopAllScheduled = () => {
      if (!ctx || !master) return;
      const t = ctx.currentTime + 0.005;
      master.gain.cancelScheduledValues(t);
      master.gain.setValueAtTime(master.gain.value, t);
      master.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
      master.gain.setValueAtTime(0.85, t + 0.08);
    };
  }

  // ============================================================
  // Botones
  // ============================================================
  document.getElementById("activar").addEventListener("click", asegurarAudio);
  document.getElementById("limpiar").addEventListener("click", () => { notas = []; render(); });
  document.getElementById("reproducir").addEventListener("click", reproducirTodo);
  document.getElementById("parar").addEventListener("click", () => { if (stopAllScheduled) stopAllScheduled(); });

  // Render inicial
  render();
})();
</script>
</body>
</html>

