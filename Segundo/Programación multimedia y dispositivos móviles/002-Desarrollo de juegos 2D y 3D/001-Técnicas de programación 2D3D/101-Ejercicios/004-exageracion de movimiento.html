<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parallax Box with Head Tracking</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: sans-serif;
      color: #eee;
    }
    #video {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 220px;
      transform: scaleX(-1); /* mirror for natural feeling */
      opacity: 0.4;          /* set to 0 or display:none when you no longer need it */
      z-index: 10;
      border: 2px solid #444;
      border-radius: 4px;
    }
    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 20;
      background: rgba(0,0,0,0.6);
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #555;
      font-size: 14px;
    }
    #parallaxRange {
      width: 150px;
      vertical-align: middle;
    }
    label {
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <!-- Simple UI for parallax strength -->
  <div id="ui">
    <label for="parallaxRange">Parallax:</label>
    <input id="parallaxRange" type="range" min="0" max="2" step="0.05" value="1" />
    <span id="parallaxValue">1.00</span>
  </div>

  <!-- Debug webcam preview -->
  <video id="video" autoplay playsinline></video>

  <!-- 3D scene -->
  <a-scene>
    <!-- Camera rig INSIDE the box, slightly behind the window plane -->
    <!-- Window (pivot) at z = -1, camera base around z = -1.2 -->
    <a-entity id="rig" position="0 0 -1.2">
      <a-entity id="cam" camera look-controls="enabled: false"></a-entity>
    </a-entity>

    <!-- FRONT FRAME at z = -1: pivot plane / "window" (open center) -->
    <!-- Top bar -->
    <a-box position="0 1.5 -1"
           depth="0.03"
           height="0.1"
           width="4"
           color="#777"
           material="metalness:0.1; roughness:0.6">
    </a-box>
    <!-- Bottom bar -->
    <a-box position="0 -1.5 -1"
           depth="0.03"
           height="0.1"
           width="4"
           color="#777"
           material="metalness:0.1; roughness:0.6">
    </a-box>
    <!-- Left bar -->
    <a-box position="-2 0 -1"
           depth="0.03"
           height="3"
           width="0.1"
           color="#777"
           material="metalness:0.1; roughness:0.6">
    </a-box>
    <!-- Right bar -->
    <a-box position="2 0 -1"
           depth="0.03"
           height="3"
           width="0.1"
           color="#777"
           material="metalness:0.1; roughness:0.6">
    </a-box>

    <!-- BOX INTERIOR, open towards camera (no solid front wall) -->
    <!-- Back wall deeper inside -->
    <a-box position="0 0 -4"
           depth="0.05"
           height="3"
           width="4"
           color="#222">
    </a-box>

    <!-- Floor and ceiling -->
    <a-box position="0 -1.5 -2.4"
           rotation="90 0 0"
           depth="0.05"
           height="4"
           width="4"
           color="#333">
    </a-box> <!-- floor -->

    <a-box position="0 1.5 -2.4"
           rotation="-90 0 0"
           depth="0.05"
           height="4"
           width="4"
           color="#333">
    </a-box> <!-- ceiling -->

    <!-- Left and right walls -->
    <a-box position="-2 0 -2.4"
           rotation="0 90 0"
           depth="0.05"
           height="3"
           width="4"
           color="#444">
    </a-box> <!-- left wall -->

    <a-box position="2 0 -2.4"
           rotation="0 -90 0"
           depth="0.05"
           height="3"
           width="4"
           color="#444">
    </a-box> <!-- right wall -->

    <!-- PRIMITIVES: multiple rows and depths for strong parallax -->

    <!-- Row 1 (near camera, just behind the window) -->
    <a-sphere   position="-1.2 -0.4 -1.6" radius="0.25" color="#ff4444"></a-sphere>
    <a-box      position=" 0.0 -0.6 -1.8" depth="0.5" height="0.5" width="0.5" color="#44ff44"></a-box>
    <a-cylinder position=" 1.2 -0.4 -1.7" radius="0.2" height="0.7" color="#4444ff"></a-cylinder>

    <!-- Row 2 (mid) -->
    <a-torus-knot position="-0.8 0.4 -2.4" radius="0.25" radius-tubular="0.06" color="#ffcc00"></a-torus-knot>
    <a-octahedron position=" 0.6 0.2 -2.7" radius="0.2" color="#00ffcc"></a-octahedron>
    <a-dodecahedron position=" 1.4 0.5 -3.0" radius="0.25" color="#ff00aa"></a-dodecahedron>

    <!-- Row 3 (farther) -->
    <a-sphere   position="-1.5 0.9 -3.2" radius="0.18" color="#ffaa88"></a-sphere>
    <a-box      position="-0.2 1.0 -3.5" depth="0.4" height="0.4" width="0.4" color="#88ffaa"></a-box>
    <a-cylinder position=" 0.9 1.1 -3.7" radius="0.18" height="0.6" color="#88aaff"></a-cylinder>
    <a-torus    position=" 0.0 -1.0 -3.0" radius="0.4" radius-tubular="0.07" color="#ff8888"></a-torus>

    <!-- Path of small spheres going deeper -->
    <a-sphere position="-1.5 -1.0 -1.9" radius="0.06" color="#ffffff"></a-sphere>
    <a-sphere position="-1.0 -0.9 -2.3" radius="0.06" color="#ffffff"></a-sphere>
    <a-sphere position="-0.5 -0.8 -2.7" radius="0.06" color="#ffffff"></a-sphere>
    <a-sphere position=" 0.0 -0.7 -3.1" radius="0.06" color="#ffffff"></a-sphere>
    <a-sphere position=" 0.5 -0.6 -3.5" radius="0.06" color="#ffffff"></a-sphere>
    <a-sphere position=" 1.0 -0.5 -3.9" radius="0.06" color="#ffffff"></a-sphere>
    <a-sphere position=" 1.4 -0.4 -4.3" radius="0.06" color="#ffffff"></a-sphere>

    <!-- Extra primitives -->
    <a-ring position="-1.4 0.0 -2.8" radius-inner="0.1" radius-outer="0.25" color="#ffdddd"></a-ring>
    <a-ring position=" 1.3 -0.1 -2.5" radius-inner="0.1" radius-outer="0.25" color="#ddffdd"></a-ring>
    <a-cone position=" -0.9 -1.1 -3.1" radius-bottom="0.3" radius-top="0.0" height="0.7" color="#ddddff"></a-cone>
    <a-cone position="  0.9 -1.2 -3.5" radius-bottom="0.3" radius-top="0.0" height="0.7" color="#ffddff"></a-cone>

    <!-- Lights -->
    <a-entity light="type: point; intensity: 1.4; distance: 10" position="0 1 -1.2"></a-entity>
    <a-entity light="type: ambient; intensity: 0.3"></a-entity>
  </a-scene>

  <!-- All JS as an ES module (MediaPipe Tasks Vision) -->
  <script type="module">
    import {
      FaceLandmarker,
      FilesetResolver
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js";

    const video = document.getElementById("video");
    const parallaxRange = document.getElementById("parallaxRange");
    const parallaxValue = document.getElementById("parallaxValue");

    let faceLandmarker = null;
    let running = false;
    let lastVideoTime = -1;

    let parallaxFactor = 1.0; // multiplier for camera movement

    parallaxRange.addEventListener("input", (e) => {
      parallaxFactor = parseFloat(e.target.value);
      parallaxValue.textContent = parallaxFactor.toFixed(2);
    });

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480 }
      });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve();
      });
    }

    async function initFaceLandmarker() {
      const filesetResolver = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );

      faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
        baseOptions: {
          modelAssetPath:
            "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/latest/face_landmarker.task"
        },
        runningMode: "VIDEO",
        numFaces: 1
      });
    }

    function getHeadCenterFromLandmarks(landmarks) {
      if (!landmarks || !landmarks.length) return null;
      let sumX = 0;
      let sumY = 0;
      const n = landmarks.length;
      for (let i = 0; i < n; i++) {
        sumX += landmarks[i].x;
        sumY += landmarks[i].y;
      }
      return { x: sumX / n, y: sumY / n };
    }

    // head left  -> camera right
    // head right -> camera left
    // head up    -> camera down
    // head down  -> camera up
    //
    // Pivot plane is the window at z = -1.
    // Camera base position is around z = -1.2 (slightly inside box).
    function mapHeadToCamera(headCenter) {
      const nx = headCenter.x * 2 - 1;   // -1 = left, +1 = right
      const ny = headCenter.y * 2 - 1;   // -1 = top,  +1 = bottom

      // Base movement range in scene units
      const baseMaxX = 0.35;
      const baseMaxY = 0.25;
      const baseZ    = -1.2;  // camera depth relative to pivot
      const maxZOffset = 0.20;

      // Apply parallax multiplier from UI
      const maxX = baseMaxX * parallaxFactor;
      const maxY = baseMaxY * parallaxFactor;

      const camX = -nx * maxX;   // inversion for parallax
      const camY =  ny * maxY;   // ny=-1 (up) -> camY negative (down)

      // Optional: small Z variation depending on distance from screen center
      const distanceFromCenter = Math.min(Math.sqrt(nx * nx + ny * ny), 1.0);
      const camZ = baseZ + distanceFromCenter * maxZOffset * parallaxFactor;

      return { x: camX, y: camY, z: camZ };
    }

    function smooth(prev, next, factor) {
      if (!prev) return next;
      return {
        x: prev.x + (next.x - prev.x) * factor,
        y: prev.y + (next.y - prev.y) * factor,
        z: prev.z + (next.z - prev.z) * factor
      };
    }

    let smoothedCamPos = null;
    const rigEl = document.getElementById("rig");

    async function processVideoFrame() {
      if (!running) return;

      const nowMs = performance.now();
      const videoTime = video.currentTime;

      if (videoTime === lastVideoTime) {
        requestAnimationFrame(processVideoFrame);
        return;
      }
      lastVideoTime = videoTime;

      const results = faceLandmarker.detectForVideo(video, nowMs);

      if (results.faceLandmarks && results.faceLandmarks.length > 0) {
        const landmarks = results.faceLandmarks[0];
        const center = getHeadCenterFromLandmarks(landmarks);

        if (center) {
          const camPos = mapHeadToCamera(center);
          smoothedCamPos = smooth(smoothedCamPos, camPos, 0.18);

          rigEl.setAttribute(
            "position",
            smoothedCamPos.x + " " +
            smoothedCamPos.y + " " +
            smoothedCamPos.z
          );
        }
      }

      requestAnimationFrame(processVideoFrame);
    }

    (async function start() {
      try {
        await initCamera();
        await initFaceLandmarker();
        running = true;
        processVideoFrame();
      } catch (e) {
        console.error("Error initializing:", e);
      }
    })();
  </script>
</body>
</html>

