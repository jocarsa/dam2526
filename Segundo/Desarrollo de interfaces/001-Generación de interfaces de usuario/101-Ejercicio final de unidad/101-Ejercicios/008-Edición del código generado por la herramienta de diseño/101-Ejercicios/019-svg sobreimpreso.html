<!doctype html>
<html>
  <head>
    <title>Gráficas</title>
    <meta charset="utf-8">
    <style>
      /* Tamaño y forma comunes a todas las gráficas */
      .grafica1, .grafica2, .grafica3, .grafica4{
        position: relative;
        width: 240px;
        aspect-ratio: 1;
        border-radius: 50%;
        display: inline-block;
        margin: 8px;
      }
      /* SVG superpuesto para captar eventos sin alterar el look */
      .overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
      }
      .overlay path {
        fill: transparent;        /* No pinta nada: se ve el conic-gradient */
        pointer-events: all;      /* Pero sí captura el hover */
      }
      /* Tooltip */
      .tooltip {
        position: absolute;
        transform: translate(-50%, -120%);
        padding: 6px 10px;
        border-radius: 8px;
        background: rgba(17, 24, 39, 0.9); /* gris muy oscuro */
        color: white;
        font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
        white-space: nowrap;
        box-shadow: 0 6px 18px rgba(0,0,0,.25);
        pointer-events: none;     /* No interfiere con el ratón */
        opacity: 0;
        transition: opacity .12s ease;
        z-index: 2;
      }
      .tooltip b{ font-weight: 700; }
      .tooltip.visible{ opacity: 1; }
    </style>
  </head>
  <body>
    <div class="grafica1"></div>
    <div class="grafica2"></div>
    <div class="grafica3"></div>
    <div class="grafica4"></div>  
    <script>
      let datos1 = [
        {"Etiqueta":"España","Valor":34},
        {"Etiqueta":"Francia","Valor":78},
        {"Etiqueta":"Alemania","Valor":76},
        {"Etiqueta":"Austria","Valor":87},
        {"Etiqueta":"Italia","Valor":127}
      ];
      let datos2 = [
        {"Etiqueta":"Valencia","Valor":56},
        {"Etiqueta":"Madrid","Valor":102},
        {"Etiqueta":"Barcelona","Valor":88},
        {"Etiqueta":"Sevilla","Valor":74},
        {"Etiqueta":"Bilbao","Valor":61}
      ];
      let datos3 = [
        {"Etiqueta":"Python","Valor":120},
        {"Etiqueta":"JavaScript","Valor":98},
        {"Etiqueta":"C++","Valor":77},
        {"Etiqueta":"Java","Valor":110},
        {"Etiqueta":"Go","Valor":45}
      ];
      let datos4 = [
        {"Etiqueta":"Manzana","Valor":34},
        {"Etiqueta":"Plátano","Valor":52},
        {"Etiqueta":"Naranja","Valor":46},
        {"Etiqueta":"Uva","Valor":29},
        {"Etiqueta":"Sandía","Valor":67}
      ];

      function getRandomHexColor() {
        return "#" + Math.floor(Math.random() * 16777215).toString(16).padStart(6, "0");
      }
      function randomLightnessVariation(hex, min = 0.7, max = 1.3) {
        // Convert hex → RGB
        let r = parseInt(hex.slice(1, 3), 16) / 255;
        let g = parseInt(hex.slice(3, 5), 16) / 255;
        let b = parseInt(hex.slice(5, 7), 16) / 255;

        // RGB → HSL (para mantener el tono y variar la L)
        let maxC = Math.max(r, g, b), minC = Math.min(r, g, b);
        let l = (maxC + minC) / 2;
        let s, h;
        if (maxC === minC) {
          s = h = 0;
        } else {
          let d = maxC - minC;
          s = l > 0.5 ? d / (2 - maxC - minC) : d / (maxC + minC);
          switch (maxC) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
        }

        // Variación de luminosidad
        let L = l * (min + Math.random() * (max - min));
        L = Math.max(0, Math.min(1, L));

        // HSL → RGB
        function hue2rgb(p, q, t) {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        }
        let q = L < 0.5 ? L * (1 + s) : L + s - L * s;
        let p = 2 * L - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);

        return "#" +
          Math.round(r * 255).toString(16).padStart(2, "0") +
          Math.round(g * 255).toString(16).padStart(2, "0") +
          Math.round(b * 255).toString(16).padStart(2, "0");
      }

      // Utilidad para generar paths de arco en SVG
      function arcoPath(cx, cy, r, angInicio, angFin){
        // Angulos en radianes, 0 arriba (12h), sentido horario
        const a1 = angInicio - Math.PI/2;
        const a2 = angFin   - Math.PI/2;
        const x1 = cx + r * Math.cos(a1);
        const y1 = cy + r * Math.sin(a1);
        const x2 = cx + r * Math.cos(a2);
        const y2 = cy + r * Math.sin(a2);
        const largeArc = (angFin - angInicio) > Math.PI ? 1 : 0;
        // Pie (no donut): movemos al centro, trazamos línea y arco y cerramos
        return `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;
      }

      function jvgraficatarta(selector, datos, colorBase){
        const suma = datos.reduce((acc, d) => acc + d.Valor, 0);

        // 1) Construir paleta (variaciones de luminancia del color base) y gradiente
        const colores = datos.map(() => randomLightnessVariation(colorBase));
        let cursor = 0;
        let grad = "";
        for (let i=0;i<datos.length;i++){
          const inicio = (cursor * 100).toFixed(6) + "%";
          cursor += datos[i].Valor / suma;
          const fin = (cursor * 100).toFixed(6) + "%";
          grad += `${colores[i]} ${inicio} ${fin},`;
        }
        grad = grad.slice(0,-1);

        // 2) Pintar la tarta (conic-gradient) en el contenedor
        const grafica = document.querySelector(selector);
        grafica.style.background = `conic-gradient(${grad})`;

        // 3) Crear/colocar tooltip (una única instancia por grafica)
        let tooltip = grafica.querySelector(".tooltip");
        if(!tooltip){
          tooltip = document.createElement("div");
          tooltip.className = "tooltip";
          grafica.appendChild(tooltip);
        }

        // 4) Crear un SVG superpuesto con las cuñas para captar hover
        //    (lo regeneramos por si se llama de nuevo)
        let overlay = grafica.querySelector("svg.overlay");
        if(overlay) overlay.remove();

        const size = grafica.clientWidth || 240;    // 240px por CSS
        const cx = size/2, cy = size/2, r = size/2; // pie completo
        overlay = document.createElementNS("http://www.w3.org/2000/svg","svg");
        overlay.setAttribute("class","overlay");
        overlay.setAttribute("viewBox", `0 0 ${size} ${size}`);
        overlay.setAttribute("preserveAspectRatio","xMidYMid meet");

        // Eventos para tooltip
        overlay.addEventListener("mousemove", (e) => {
          const rect = grafica.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          tooltip.style.left = x + "px";
          tooltip.style.top  = y + "px";
        });
        overlay.addEventListener("mouseleave", () => {
          tooltip.classList.remove("visible");
        });

        // 5) Dibujar cuñas interactivas
        let angAcum = 0; // en radianes
        for (let i=0;i<datos.length;i++){
          const fraccion = datos[i].Valor / suma;
          const angInicio = angAcum;
          const angFin = angAcum + fraccion * Math.PI * 2;
          angAcum = angFin;

          const path = document.createElementNS("http://www.w3.org/2000/svg","path");
          path.setAttribute("d", arcoPath(cx, cy, r, angInicio, angFin));
          path.setAttribute("data-etiqueta", datos[i].Etiqueta);
          path.setAttribute("data-valor", datos[i].Valor);
          // (Opcional) usar el color para ampliar el área pintada a opacidad mínima:
          // path.setAttribute("fill", colores[i]); path.setAttribute("opacity", "0.001");
          // pero con fill: transparent + pointer-events: all (en CSS) ya funciona:
          overlay.appendChild(path);

          // Mostrar tooltip
          path.addEventListener("mouseenter", () => {
            tooltip.innerHTML = `<b>${datos[i].Etiqueta}</b><br>${datos[i].Valor}`;
            tooltip.classList.add("visible");
          });
          path.addEventListener("mouseleave", () => {
            tooltip.classList.remove("visible");
          });
        }

        grafica.appendChild(overlay);
      }

      // Render
      jvgraficatarta(".grafica1", datos1, "#c02424");
      jvgraficatarta(".grafica2", datos2, "#2acb71");
      jvgraficatarta(".grafica3", datos3, "#4e61cd");
      jvgraficatarta(".grafica4", datos4, "#cdab5a");
    </script>
  </body>
</html>

