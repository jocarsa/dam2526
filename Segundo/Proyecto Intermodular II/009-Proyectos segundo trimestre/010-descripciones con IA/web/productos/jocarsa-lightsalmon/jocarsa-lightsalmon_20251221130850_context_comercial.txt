TITLE: Calendario
H1: jocarsa | lightSalmon

# Reporte de proyecto
## Estructura del proyecto
## Código (intercalado)
# jocarsa-lightsalmon
# jocarsa-lightsalmon
* calendar_api.php (single-file PHP + SQLite)
* Endpoints (all JSON):
* POST ?action=register {username,password}
* POST ?action=login {username,password}
* POST ?action=logout {}
* GET ?action=me (session info)
* GET ?action=load (requires login) -> {data:{version,categories,holidays,events}}
* POST ?action=save (requires login) {data:{version,categories,holidays,events}}
* Notes:
* - This file is only the backend API. Your HTML will call it via fetch().
* - If user is not logged in: load/save return 401. Frontend should fall back to localStorage.
* Validate/normalize calendar payload:
* Expected shape:
* { version: 2, categories: [...], holidays: [...], events: [...] }
* Returns normalized array with those keys.
#jvcalendario{
#panel_vista{
#panel_vista .panel_body{
#panel_vista{
#panel_vista .panel_head{
#panel_vista .panel_head .ttl{
#panel_vista .panel_body{
## v1
#logo {
#auth-section {
#auth-section h2 {
#auth-section form {
#auth-section input {
#auth-section button {
#auth-section button:hover {
#contieneformularios {
#contieneformularios input,
#contieneformularios button {
#calendar-section {
#contienecalendario {
#sidebar {
#sidebar h3 {
#calendars-list {
#add-calendar-btn {
#add-calendar-btn:hover {
#event-form input,
#event-form textarea,
#event-form select,
#calendar-form input,
#calendar-form select {
#event-form button,
#calendar-form button,
#config-form button {
#event-form button:hover,
#calendar-form button:hover,
#config-form button:hover {
#close-modal,
#close-calendar-modal {
#close-modal:hover,
#close-calendar-modal:hover {
#recurrence-section {
#recurrence-section h4 {
#recurrence-days {
#recurrence-days legend {
#sidebar {
#calendar-title{
#repeat-checkbox{
#repeat-section{
#auth-section #logo{

# Reporte de proyecto

## Estructura del proyecto

```
/var/www/html/jocarsa-lightsalmon
├── README.md
├── calendar_api.php
├── index.html
└── v1
 ├── calendar.js
 ├── calendario.webp
 ├── endpoint.php
 ├── index.html
 └── styles.css
```

## Código (intercalado)

# jocarsa-lightsalmon
**README.md**
```markdown
# jocarsa-lightsalmon
```
**calendar_api.php**
```php
<?php
/**
 * calendar_api.php (single-file PHP + SQLite)
 *
 * Endpoints (all JSON):
 * POST ?action=register {username,password}
 * POST ?action=login {username,password}
 * POST ?action=logout {}
 * GET ?action=me (session info)
 * GET ?action=load (requires login) -> {data:{version,categories,holidays,events}}
 * POST ?action=save (requires login) {data:{version,categories,holidays,events}}
 *
 * Notes:
 * - This file is only the backend API. Your HTML will call it via fetch().
 * - If user is not logged in: load/save return 401. Frontend should fall back to localStorage.
 */

declare(strict_types=1);
session_start();

/* =========================
 CONFIG
 ========================= */
const DB_PATH = __DIR__ . '/calendar.sqlite';
const USERNAME_MIN = 3;
const USERNAME_MAX = 48;
const PASSWORD_MIN = 6;
const MAX_PAYLOAD_BYTES = 2_000_000; // 2MB safety limit

/* =========================
 HELPERS
 ========================= */
function json_out(array $payload, int $status = 200): void {
 http_response_code($status);
 header('Content-Type: application/json; charset=utf-8');
 header('Cache-Control: no-store');
 echo json_encode($payload, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
 exit;
}

function method(): string {
 return strtoupper($_SERVER['REQUEST_METHOD'] ?? 'GET');
}

function action(): string {
 return (string)($_GET['action'] ?? '');
}

function pdo(): PDO {
 static $pdo = null;
 if ($pdo instanceof PDO) return $pdo;

 $pdo = new PDO('sqlite:' . DB_PATH, null, null, [
 PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
 PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
 PDO::ATTR_EMULATE_PREPARES => false,
 ]);

 // Pragmas
 $pdo->exec("PRAGMA journal_mode = WAL;");
 $pdo->exec("PRAGMA foreign_keys = ON;");

 // Schema
 $pdo->exec("
 CREATE TABLE IF NOT EXISTS users (
 id INTEGER PRIMARY KEY AUTOINCREMENT,
 username TEXT NOT NULL UNIQUE,
 pass_hash TEXT NOT NULL,
 created_at TEXT NOT NULL DEFAULT (datetime('now'))
 );
 ");

 $pdo->exec("
 CREATE TABLE IF NOT EXISTS user_data (
 user_id INTEGER PRIMARY KEY,
 data_json TEXT NOT NULL,
 updated_at TEXT NOT NULL DEFAULT (datetime('now')),
 FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
 );
 ");

 return $pdo;
}

function read_body_json(): array {
 $raw = file_get_contents('php://input') ?: '';
 if (strlen($raw) > MAX_PAYLOAD_BYTES) {
 json_out(['ok' => false, 'error' => 'Payload demasiado grande'], 413);
 }
 if ($raw === '') return [];
 $data = json_decode($raw, true);
 if (!is_array($data)) {
 json_out(['ok' => false, 'error' => 'JSON inválido'], 400);
 }
 return $data;
}

function is_logged_in(): bool {
 return isset($_SESSION['uid']) && is_int($_SESSION['uid']) && $_SESSION['uid'] > 0;
}

function require_login(): int {
 if (!is_logged_in()) {
 json_out(['ok' => false, 'error' => 'No autenticado'], 401);
 }
 return (int)$_SESSION['uid'];
}

function normalize_username(string $u): string {
 $u = trim($u);
 // Keep simple: letters, digits, underscore, dash, dot
 $u = preg_replace('/\s+/', '', $u) ?? $u;
 return $u;
}

function valid_username(string $u): bool {
 if ($u === '') return false;
 $len = mb_strlen($u, 'UTF-8');
 if ($len < USERNAME_MIN || $len > USERNAME_MAX) return false;
 return (bool)preg_match('/^[a-zA-Z0-9_.-]+$/', $u);
}

function valid_password(string $p): bool {
 if ($p === '') return false;
 return mb_strlen($p, 'UTF-8') >= PASSWORD_MIN;
}

/**
 * Validate/normalize calendar payload:
 * Expected shape:
 * { version: 2, categories: [...], holidays: [...], events: [...] }
 *
 * Returns normalized array with those keys.
 */
function normalize_calendar_data($data): array {
 if (!is_array($data)) {
 json_out(['ok' => false, 'error' => 'Campo "data" inválido'], 400);
 }

 $version = isset($data['version']) ? (int)$data['version'] : 2;

 $categories = $data['categories'] ?? [];
 $holidays = $data['holidays'] ?? [];
 $events = $data['events'] ?? [];

 if (!is_array($categories) || !is_array($holidays) || !is_array($events)) {
 json_out(['ok' => false, 'error' => 'Estructura de calendario inválida'], 400);
 }

 // Normalize categories
 $catOut = [];
 foreach ($categories as $c) {
 if (!is_array($c)) continue;
 $id = trim((string)($c['id'] ?? ''));
 $name = trim((string)($c['name'] ?? $id));
 $color = trim((string)($c['color'] ?? '#94a3b8'));
 $trabajo = !empty($c['trabajo']);

 if ($id === '') continue;
 if ($name === '') $name = $id;

 // very light color validation (accept #RRGGBB)
 if (!preg_match('/^#[0-9a-fA-F]{6}$/', $color)) $color = '#94a3b8';

 $catOut[] = [
 'id' => $id,
 '