# Reporte de proyecto

## Estructura del proyecto

```
/var/www/html/jocarsa-salmon
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ admin.php
‚îú‚îÄ‚îÄ index.html
‚îî‚îÄ‚îÄ signaling.php
```

## C√≥digo (intercalado)

# jocarsa-salmon
**README.md**
```markdown
# jocarsa-salmon
```
**admin.php**
```php
<?php
declare(strict_types=1);
session_start();

/* =========================================
   CONFIGURACI√ìN
   ========================================= */
const ADMIN_USER = 'jocarsa';
const ADMIN_PASS = 'jocarsa';

/* Ajusta rutas si tu index.html no est√° en / */
const INVITE_USER_PATH      = '/';
const INVITE_PRESENTER_PATH = '/';

$dbFile = __DIR__ . '/signaling.db';

/* =========================================
   HELPERS
   ========================================= */
function out($s){ echo $s; }
function h(string $s): string { return htmlspecialchars($s, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'); }
function base_url(): string {
  $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
  $host   = $_SERVER['HTTP_HOST'] ?? 'localhost';
  return $scheme . '://' . $host;
}
function csrf_token(): string {
  if (empty($_SESSION['csrf'])) $_SESSION['csrf'] = bin2hex(random_bytes(16));
  return $_SESSION['csrf'];
}
function csrf_ok(string $t): bool { return isset($_SESSION['csrf']) && hash_equals($_SESSION['csrf'], $t); }
/* Base64 URL-safe (para data-atributos sin romper HTML) */
function b64e(string $s): string { return rtrim(strtr(base64_encode($s), '+/', '-_'), '='); }

/** Mensaje ‚Äútipo Zoom‚Äù (sin comillas tipogr√°ficas problem√°ticas) */
function make_invite_msg(string $role, string $title, string $roomId, ?string $password, string $url): string {
  $roleUpper = strtoupper($role);
  $pwLine = $password ? "Contrase√±a: $password" : "Contrase√±a: (no definida)";
  $lines = [
    "üîó Invitaci√≥n a la sala ¬´{$title}¬ª",
    "",
    "√önete como $roleUpper",
    "1) Abre: $url",
    "2) En ¬´ID de sala¬ª escribe: $roomId",
    "3) $pwLine",
    "",
    "üí° Usa tu nombre y apellidos como ¬´Nombre a mostrar¬ª.",
    "üìπ Permite c√°mara y micr√≥fono si te lo pide el navegador.",
    "‚ôªÔ∏è Si algo falla, actualiza la p√°gina o prueba otro navegador."
  ];
  return implode("\n", $lines);
}

/* =========================================
   LOGIN / LOGOUT
   ========================================= */
$login_error = null;
if (isset($_GET['action']) && $_GET['action']==='logout') {
  $_SESSION = []; session_destroy();
  header('Location: '.$_SERVER['PHP_SELF']); exit;
}
if (($_POST['__do'] ?? '') === 'login') {
  $u = $_POST['user'] ?? '';
  $p = $_POST['pass'] ?? '';
  if ($u === ADMIN_USER && $p === ADMIN_PASS) {
    $_SESSION['admin_auth'] = true;
    header('Location: '.$_SERVER['PHP_SELF']); exit;
  } else {
    $login_error = 'Credenciales incorrectas.';
  }
}
$authed = !empty($_SESSION['admin_auth']);

/* =========================================
   DB INIT + MIGRACIONES DEFENSIVAS
   ========================================= */
$ok=null; $err=null;
try {
  $db = new PDO('sqlite:' . $dbFile, '', '', [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
  ]);

  // Esquema compatible con signaling.php (usa passhash_user/passhash_presenter)
  $db->exec("CREATE TABLE IF NOT EXISTS rooms(
    id TEXT PRIMARY KEY,
    title TEXT,
    pass_user TEXT,            -- plano (para mostrar en invitaciones)
    pass_presenter TEXT,       -- plano (para mostrar en invitaciones)
    passhash_user TEXT,        -- hash (lo que valida signaling.php)
    passhash_presenter TEXT,   -- hash (lo que valida signaling.php)
    created_at INTEGER,
    updated_at INTEGER
  )");

  // Migraciones defensivas
  try { $db->exec("ALTER TABLE rooms ADD COLUMN pass_user TEXT"); } catch (Throwable $e) {}
  try { $db->exec("ALTER TABLE rooms ADD COLUMN pass_presenter TEXT"); } catch (Throwable $e) {}
  try { $db->exec("ALTER TABLE rooms ADD COLUMN passhash_user TEXT"); } catch (Throwable $e) {}
  try { $db->exec("ALTER TABLE rooms ADD COLUMN passhash_presenter TEXT"); } catch (Throwable $e) {}
  try { $db->exec("ALTER TABLE rooms ADD COLUMN created_at INTEGER"); } catch (Throwable $e) {}
  try { $db->exec("ALTER TABLE rooms ADD COLUMN updated_at INTEGER"); } catch (Throwable $e) {}

} catch (Throwable $e) {
  $err = 'DB error: '.$e->getMessage();
}

/* =========================================
   CRUD (solo si logado)
   ========================================= */
if ($authed && $_SERVER['REQUEST_METHOD']==='POST' && !$err) {
  if (!csrf_ok($_POST['csrf'] ?? '')) {
    $err = 'CSRF inv√°lido. Recarga la p√°gina.';
  } else {
    $do = $_POST['__do'] ?? '';
    switch ($do) {
      case 'create_update_room': {
        $room = trim($_POST['room'] ?? '');
        $title = trim($_POST['title'] ?? $room);
        $pass_user = $_POST['pass_user'] ?? '';
        $pass_presenter = $_POST['pass_presenter'] ?? '';

        if (!$room) { $err='Falta el ID de sala.'; break; }

        // Cargar estado previo
        $st = $db->prepare("SELECT * FROM rooms WHERE id=?");
        $st->execute([$room]);
        $old = $st->fetch();

        // Si creamos por primera vez, exigimos ambas contrase√±as
        if (!$old && ($pass_user === '' || $pass_presenter === '')) {
          $err = 'Debes indicar ambas contrase√±as al crear por primera vez.';
          break;
        }

        // Planas (mostrar en invitaci√≥n)
        $new_pass_user_plain      = $pass_user !== ''      ? $pass_user      : ($old['pass_user'] ?? null);
        $new_pass_presenter_plain = $pass_presenter !== '' ? $pass_presenter : ($old['pass_presenter'] ?? null);

        // Hashes (usa signaling.php -> password_verify)
        $new_passhash_user        = $pass_user !== ''      ? password_hash($pass_user, PASSWORD_DEFAULT)
                                                          : ($old['passhash_user'] ?? null);
        $new_passhash_presenter   = $pass_presenter !== '' ? password_hash($pass_presenter, PASSWORD_DEFAULT)
                                                          : ($old['passhash_presenter'] ?? null);

        if ($old) {
          $st = $db->prepare("
            UPDATE rooms
               SET title=?,
                   pass_user=?,
                   pass_presenter=?,
                   passhash_user=?,
                   passhash_presenter=?,
                   updated_at=strftime('%s','now')
             WHERE id=?
          ");
          $st->execute([
            $title ?: $room,
            $new_pass_user_plain,
            $new_pass_presenter_plain,
            $new_passhash_user,
            $new_passhash_presenter,
            $room
          ]);
          $ok = 'Sala actualizada correctamente.';
        } else {
          $st = $db->prepare("
            INSERT INTO rooms(id,title,pass_user,pass_presenter,passhash_user,passhash_presenter,created_at,updated_at)
                 VALUES(?,?,?,?,?,?,strftime('%s','now'),strftime('%s','now'))
          ");
          $st->execute([
            $room,
            $title ?: $room,
            $new_pass_user_plain,
            $new_pass_presenter_plain,
            $new_passhash_user,
            $new_passhash_presenter
          ]);
          $ok = 'Sala creada correctamente.';
        }
      } break;

      case 'delete_room': {
        $room = trim($_POST['room'] ?? '');
        if (!$room) { $err='ID inv√°lido.'; break; }
        $st = $db->prepare("DELETE FROM rooms WHERE id=?");
        $st->execute([$room]);
        $ok = 'Sala eliminada.';
      } break;
    }
  }
}

/* =========================================
   LISTADO / B√öSQUEDA
   ========================================= */
$rooms = [];
$search = '';
if($authed && !$err){
  $search = trim($_GET['q'] ?? '');
  if ($search!=='') {
    $st = $db->prepare("SELECT id,title,pass_user,pass_presenter,passhash_user,passhash_presenter,created_at,updated_at
                        FROM rooms
                        WHERE id LIKE ? OR title LIKE ?
                        ORDER BY updated_at DESC, created_at DESC");
    $like='%'.$search.'%';
    $st->execute([$like,$like]);
    $rooms = $st->fetchAll();
  } else {
    $rooms = $db->query("SELECT id,title,pass_user,pass_presenter,passhash_user,passhash_presenter,created_at,updated_at
                         FROM rooms
                         ORDER BY updated_at DESC, created_at DESC")->fetchAll();
  }
}

/* =========================================
   VISTA
   ========================================= */
?>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>jocarsa | salmon ¬∑ Admin salas</title>
<link rel="icon" type="image/png" href="salmonlogo.png">
<style>
  :root{
    --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#667085; --accent:#fa8072; --accent-ink:#5c0e08;
    --border:#e5e7eb; --danger:#dc2626; --ok:#16a34a; --input:#f1f5f9; --ring: rgba(250,128,114,.35);
    --shadow: 0 10px 30px rgba(2,6,23,.08);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#fff 0%, #fff 180px, #f9fafb 100%);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  header{height:56px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#ffb4a8,#fa8072)}
  .brand h1{font-size:18px;margin:0}
  .userbar{display:flex;align-items:center;gap:8px;color:#334155}
  .btn{display:inline-flex;align-items:center;gap:8px;border:none;background:var(--accent);color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:transform .05s ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.ghost{background:#fff;color:#0f172a;border:1px solid var(--border);box-shadow:none}
  .btn.warn{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 1.2fr;gap:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card h2{font-size:16px;margin:0 0 12px}
  label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
  input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--input);outline:none}
  input:focus{border-color:#fca5a5;box-shadow:0 0 0 4px var(--ring)}
  .row{display:flex;gap:10px}
  .row > *{flex:1}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.04em}
  tbody tr{background:#fff;border:1px solid var(--border);box-shadow:var(--shadow)}
  tbody td, thead th{padding:12px 12px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#334155;font-size:12px}
  .muted{color:#64748b}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .search{display:flex;gap:8px}
  .msg{padding:12px;border-radius:12px;margin-bottom:10px;border:1px solid transparent}
  .msg.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .msg.err{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  .help{font-size:12px;color:#64748b}
  .login{max-width:420px;margin:12vh auto}
  .footer{margin-top:24px;color:#94a3b8;font-size:12px;text-align:center}
  .nowrap{white-space:nowrap}
  .badge{display:inline-block;padding:3px 8px;border-radius:8px;font-size:11px;background:#f8fafc;border:1px solid var(--border);color:#475569}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <h1>jocarsa | salmon ¬∑ Admin de salas</h1>
    </div>
    <div class="userbar">
      <?php if($authed): ?>
        <span class="muted">Conectado como <strong>admin</strong></span>
        <a class="btn ghost small" href="?action=logout" title="Cerrar sesi√≥n">Salir</a>
      <?php endif; ?>
    </div>
  </header>

  <?php if(!$authed): ?>
    <div class="card login">
      <h2>Acceder</h2>
      <?php if($login_error) out('<div class="msg err">'.$login_error.'</div>'); ?>
      <form method="post" autocomplete="off">
        <input type="hidden" name="__do" value="login">
        <label>Usuario</label>
        <input name="user" placeholder="Usuario" required>
        <label>Contrase√±a</label>
        <input name="pass" type="password" placeholder="Contrase√±a" required>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn">Entrar</button>
          <div class="help">Pista: usuario <b>jocarsa</b>, contrase√±a <b>jocarsa</b></div>
        </div>
      </form>
    </div>
    <div class="footer">¬© <?php out(date('Y')); ?> jocarsa | salmon</div>

  <?php else: ?>

  <div class="grid">
    <!-- Formulario crear/editar -->
    <div class="card">
      <h2>Crear / editar sala</h2>
      <?php if($ok) out("<div class='msg ok'>$ok</div>"); if($err) out("<div class='msg err'>$err</div>"); ?>
      <form method="post" autocomplete="off">
        <input type="hidden" name="__do" value="create_update_room">
        <input type="hidden" name="csrf" value="<?php out(csrf_token()); ?>">
        <label>ID de sala <span class="help">p.ej. <code>dam1-aula</code></span></label>
        <input name="room" placeholder="dam1-aula" required>
        <label>T√≠tulo de sala</label>
        <input name="title" placeholder="DAM1 Aula">
        <div class="row">
          <div>
            <label>Contrase√±a USUARIO <span class="help">(deja vac√≠o para no cambiar en edici√≥n)</span></label>
            <input name="pass_user" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div>
            <label>Contrase√±a PRESENTADOR <span class="help">(deja vac√≠o para no cambiar en edici√≥n)</span></label>
            <input name="pass_presenter" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn">Guardar</button>
          <button type="reset" class="btn ghost">Limpiar</button>
        </div>
        <div class="help" style="margin-top:8px">
          Si la sala no existe se crear√°; si existe, se actualizar√°. Las contrase√±as solo cambian si escribes algo.
        </div>
      </form>
    </div>

    <!-- Listado / acciones -->
    <div class="card">
      <h2>Salas existentes</h2>
      <form class="search" method="get" action="">
        <input name="q" value="<?php out(h($search)); ?>" placeholder="Buscar por ID o t√≠tulo‚Ä¶">
        <button class="btn ghost" type="submit">Buscar</button>
        <?php if($search!==''): ?>
          <a class="btn ghost" href="<?php out(h($_SERVER['PHP_SELF'])); ?>">Quitar filtro</a>
        <?php endif; ?>
      </form>

      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>T√≠tulo</th>
              <th>Fechas</th>
              <th class="nowrap">Invitaciones</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody>
          <?php if(empty($rooms)): ?>
            <tr><td colspan="5" class="muted" style="padding:18px">No hay salas.</td></tr>
          <?php else: foreach($rooms as $r):
            $id = $r['id'] ?? '';
            $title = $r['title'] ?? '';
            $uUrl = base_url() . INVITE_USER_PATH;
            $pUrl = base_url() . INVITE_PRESENTER_PATH;

            // Invitaciones muestran la contrase√±a en claro (si est√° guardada en pass_user/pass_presenter)
            $userMsg = make_invite_msg('usuario', $title ?: $id, $id, $r['pass_user'] ?? null, $uUrl);
            $presMsg = make_invite_msg('presentador', $title ?: $id, $id, $r['pass_presenter'] ?? null, $pUrl);

            $userMsgB64 = b64e($userMsg);
            $presMsgB64 = b64e($presMsg);
          ?>
            <tr>
              <td><span class="pill"><?php out(h($id)); ?></span></td>
              <td><?php out(h($title)); ?></td>
              <td class="muted nowrap">
                <div><span class="badge">Creada</span> <?php out(!empty($r['created_at'])? date('Y-m-d H:i',$r['created_at']):'‚Äî'); ?></div>
                <div><span class="badge">Actualizada</span> <?php out(!empty($r['updated_at'])? date('Y-m-d H:i',$r['updated_at']):'‚Äî'); ?></div>
              </td>
              <td class="nowrap">
                <div class="toolbar">
                  <button class="btn small invite" type="button" data-msg="<?php out(h($userMsgB64)); ?>">Copiar usuario</button>
                  <button class="btn small invite" type="button" style="background:#111827" data-msg="<?php out(h($presMsgB64)); ?>">Copiar presentador</button>
                </div>
              </td>
              <td class="nowrap">
                <div class="toolbar">
                  <button class="btn ghost small" type="button" onclick="prefill('<?php out(h($id)); ?>','<?php out(h($title)); ?>')">Editar</button>
                  <form method="post" onsubmit="return confirmDel('<?php out(h($id)); ?>')" style="display:inline">
                    <input type="hidden" name="__do" value="delete_room">
                    <input type="hidden" name="csrf" value="<?php out(csrf_token()); ?>">
                    <input type="hidden" name="room" value="<?php out(h($id)); ?>">
                    <button class="btn warn small" type="submit">Borrar</button>
                  </form>
                </div>
              </td>
            </tr>
          <?php endforeach; endif; ?>
          </tbody>
        </table>
      </div>
      <div class="help" style="margin-top:6px">
        Las invitaciones apuntan a <code><?php out(INVITE_USER_PATH); ?></code> (usuario) y <code><?php out(INVITE_PRESENTER_PATH); ?></code> (presentador). Ajusta arriba si tus rutas son diferentes.
      </div>
    </div>
  </div>

  <div class="footer">¬© <?php out(date('Y')); ?> jocarsa | salmon</div>
  <?php endif; ?>
</div>

<script>
  // Prefill para edici√≥n
  function prefill(id, title){
    const form = document.querySelector('form[method="post"][autocomplete="off"]');
    if(!form) return;
    form.room.value = id;
    form.title.value = title || '';
    form.scrollIntoView({behavior:'smooth', block:'start'});
    flash('Modo edici√≥n: ' + id);
  }

  function confirmDel(id){
    return confirm('¬øBorrar la sala "' + id + '"? Esta acci√≥n no se puede deshacer.');
  }

  // Copiar invitaciones: botones con data-msg (base64 url-safe)
  function b64UrlToUtf8(b64url){
    // A√±adir padding y revertir URL-safe
    let b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
    while (b64.length % 4 !== 0) b64 += '=';
    const bin = atob(b64);
    // Convertir a UTF-8
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    try{ return new TextDecoder('utf-8').decode(bytes); }
    catch{ // fallback
      let s=''; for(let i=0;i<bytes.length;i++) s += String.fromCharCode(bytes[i]); return s;
    }
  }

  function copyText(text){
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(()=>flash('Invitaci√≥n copiada')).catch(()=>{
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }
  function fallbackCopy(text){
    const ta=document.createElement('textarea');
    ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove();
    flash('Invitaci√≥n copiada');
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.invite');
    if(!btn) return;
    const b64 = btn.dataset.msg || '';
    const msg = b64UrlToUtf8(b64);
    copyText(msg);
  });

  // Micro toasts
  let toastT=null;
  function flash(msg){
    let el = document.getElementById('toast');
    if(!el){
      el = document.createElement('div');
      el.id='toast';
      el.style.position='fixed';
      el.style.left='50%';
      el.style.bottom='20px';
      el.style.transform='translateX(-50%)';
      el.style.background='#0f172a';
      el.style.color='#fff';
      el.style.padding='10px 14px';
      el.style.borderRadius='12px';
      el.style.boxShadow='0 10px 30px rgba(2,6,23,.25)';
      el.style.zIndex='9999';
      el.style.transition='opacity .2s ease';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.opacity='1';
    clearTimeout(toastT);
    toastT = setTimeout(()=>{ el.style.opacity='0'; }, 1800);
  }
</script>
</body>
</html>


```
**index.html**
```html
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/png"  href="salmonlogo.png">
<title>jocarsa | salmon</title>
<style>
  :root{
    --bg:#f8fafc; --panel:#ffffff; --ink:#1b1f24; --muted:#6b7280; --accent:#fa8072; --accent-ink:#5c0e08;
    --border:#e5e7eb; --danger:#dc2626; --input:#f3f4f6; --ok:#16a34a;
    --header-h:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#fff 0%, #fff 160px, #f9fafb 100%);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}

  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);height:var(--header-h);background:#ffffffcc;backdrop-filter:blur(6px)}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .brand h1{font-size:16px;letter-spacing:.3px;margin:0}
  .sub{color:var(--muted);font-size:12px;margin-left:8px}
  .audio-banner{display:none;gap:10px;align-items:center}
  .audio-banner button{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#fff}

  /* Acceso */
  #acceso{position:absolute;inset:var(--header-h) 0 0 0;display:grid;place-items:start center;overflow:auto}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden;margin-top:48px;max-width:560px;width:100%;text-align:center;}
  .card .head{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .card .head h2{font-size:18px;margin:0}
  .chip{font-size:12px;color:var(--accent-ink);background:color-mix(in srgb, var(--accent) 18%, #fff);border:1px solid color-mix(in srgb, var(--accent) 40%, #fff);border-radius:999px;padding:4px 8px}
  .card .body{padding:18px;display:grid;gap:12px}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--input);color:var(--ink);outline:none}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 30%, transparent)}
  .acciones{display:flex;gap:10px;justify-content:flex-end;padding:12px 18px;border-top:1px solid var(--border);background:#fafafa}
  button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink);cursor:pointer}
  button.primario{background:var(--accent);border:none;color:#fff}
  button.peligro{background:var(--danger);border:none;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .error{background:#fff1f2;border:1px solid #fecdd3;color:#9f1239;padding:10px;border-radius:10px;font-size:13px;display:none}

  /* App layout (full viewport, no page scroll) */
  #app{position:absolute;inset:var(--header-h) 0 0 0;display:none}
  .wrap{height:100%;display:grid;grid-template-columns:320px 1fr;gap:16px;padding:12px;overflow:hidden;transition:grid-template-columns .2s ease}
  aside{background:var(--panel);border:1px solid var(--border);border-radius:16px;display:flex;flex-direction:column;min-width:260px;overflow:hidden}
  .sec{padding:12px;border-bottom:1px solid var(--border)}
  .sec:last-child{border-bottom:none}
  .fila{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .sidebar-top{display:flex;flex-direction:column;gap:12px}
  .sidebar-controls{display:flex;gap:10px;flex-wrap:wrap}
  .chat-sec{display:flex;flex-direction:column;min-height:0}
  #chatlog{flex:1 1 auto;min-height:120px;max-height:35vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
  #chat{margin-top:8px}

  /* Switch pills */
  .switches{display:flex;gap:10px;align-items:center}
  .switch{
    display:inline-flex;align-items:center;justify-content:center;
    width:48px;height:34px;border-radius:999px;border:1px solid var(--border);
    background:#fff;font-size:18px;line-height:1;cursor:pointer;user-select:none;
    transition:all .15s ease; position:relative;
  }
  .switch[aria-pressed="true"]{background:var(--accent);border-color:var(--accent);color:#fff}
  .switch:hover::after{content:""; position:absolute; inset:-4px; border-radius:999px; box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 25%, transparent);}
  .switch[disabled]{opacity:.6;cursor:not-allowed}

  main{display:grid;grid-template-rows:1fr auto 1fr;gap:12px;min-height:0;overflow:hidden;transition:all .2s ease}
  .stage{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px;display:grid;grid-template-rows:auto 1fr;gap:6px;min-height:0;overflow:hidden}
  .stage-head{display:flex;align-items:center;justify-content:space-between}
  .stage-title{font-weight:600}
  .stage-actions{display:flex;gap:8px;flex-wrap:wrap}
  .stage-actions button{border:none;background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px}
  .stage-video{position:relative;min-height:0;place-items:center;overflow:hidden}
  .stage-video video{width:100%;height:100%;max-height:100%;max-width:100%;object-fit:contain;background:#000;border-radius:10px}
  .nameplate{position:absolute;left:8px;bottom:8px;background:#000a;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;display:flex;gap:8px;align-items:center}
  .mic{display:inline-flex;align-items:center;gap:4px}
  .speaking{outline:2px solid var(--ok);outline-offset:2px}

  .kv{display:flex;justify-content:space-between;align-items:center}
  .grid{min-height:0;overflow:auto;display:grid;grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:10px;align-content:start}
  .tile{position:relative;min-width:0}
  .tile video{width:100%;height:100%;aspect-ratio:16/9;object-fit:contain;background:#000;border-radius:12px;border:1px solid #ddd;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .tile .nameplate{left:6px;bottom:6px}
  .tile .btn-pin{position:absolute;right:6px;top:6px;background:#000a;color:#fff;border:1px solid #ffffff55;border-radius:8px;padding:6px 8px;font-size:12px}
  .pill{font-size:12px;color:var(--accent-ink);background:color-mix(in srgb, var(--accent) 18%, #fff);border:1px solid color-mix(in srgb, var(--accent) 40%, #fff);border-radius:999px;padding:4px 8px}
  .hint{color:var(--muted);font-size:12px}
  footer.controles{display:flex;gap:8px}

  /* Participantes + acciones (presentador) */
  #peers{list-style:disc}
  #peers li{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:4px 0}
  .peer-actions{display:flex;gap:6px}
  .peer-actions button{
    width:32px;height:28px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer
  }
  .peer-actions .kick{border-color:#fecaca;background:#fff1f2}
  .peer-actions .mute{border-color:#fde68a;background:#fffbeb}

  /* THEATER MODE */
  body.theater .wrap{grid-template-columns:1fr}
  body.theater aside{display:none}
  body.theater main{grid-template-rows:1fr}
  body.theater .kv, body.theater .grid{display:none}
  body.theater .stage{height:100%}

  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
    aside{order:2;min-height:240px}
    main{order:1}
  }
  .logo{width:50%;}
  #enableAudio{background:var(--danger);color:white;}
</style>
</head>
<body>
<header>
  <div class="brand">
    <span class="dot"></span><h1>jocarsa | salmon</h1>
    <span class="sub">WebRTC ¬∑ PHP+SQLite ¬∑ salas con contrase√±a</span>
  </div>
  <div class="audio-banner" id="audioBanner">
    <span class="hint">Audio bloqueado por el navegador.</span>
    <button id="enableAudio">Activar audio</button>
  </div>
</header>

<!-- Acceso -->
<section id="acceso">
  <div class="card">
    <img src="salmonlogo.png" class="logo" alt="salmon logo">
    <div class="head">
      <h2>Entrar en una sala</h2>
      <span class="chip">Acceso protegido</span>
    </div>
    <div class="body">
      <div id="errAcceso" class="error"></div>
      <div><label>ID de sala</label><input id="a_sala" placeholder="p.ej. dam1-aula" autocomplete="off" /></div>
      <div>
        <label>Contrase√±a (usuario o presentador)</label>
        <input id="a_pass" placeholder="contrase√±a" type="password" autocomplete="current-password" />
      </div>
      <div><label>Tu nombre</label><input id="a_nombre" placeholder="Nombre visible" autocomplete="name" /></div>
    </div>
    <div class="acciones">
      <button id="btnEntrar" class="primario">Acceder</button>
    </div>
  </div>
</section>

<!-- App -->
<section id="app">
  <div class="wrap">
    <aside>
      <div class="sec sidebar-top">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="pill" id="tituloSala">Sin conexi√≥n</div>
            <div class="hint" id="estado">desconectado</div>
          </div>
          <button id="salir" class="peligro">Salir</button>
        </div>
      </div>

      <div class="sec">
        <div class="sidebar-controls switches">
          <!-- switches arrancan apagados; presentador se activa tras login -->
          <button id="cam"  class="switch" aria-pressed="false" title="C√°mara">üé•</button>
          <button id="mic"  class="switch" aria-pressed="false" title="Micr√≥fono">üéôÔ∏è</button>
          <button id="comp" class="switch" aria-pressed="false" title="Compartir pantalla">üñ•Ô∏è</button>
        </div>
      </div>

      <div class="sec chat-sec">
        <label>Chat</label>
        <div id="chatlog"></div>
        <input id="chat" placeholder="Escribe y pulsa Enter" />
      </div>

      <div class="sec" style="min-height:0">
        <label>Participantes</label>
        <ul id="peers" style="margin:0;padding-left:18px;max-height:20vh;overflow:auto"></ul>
      </div>
    </aside>

    <main>
      <div class="stage">
        <div class="stage-head">
          <div class="stage-title">Escenario (presentador)</div>
          <div class="stage-actions">
            <button id="toggleTheater" title="Vista amplia">Vista amplia</button>
            <button id="toggleFS" title="Pantalla completa">Pantalla completa</button>
            <button id="unpin" title="Volver al presentador">Quitar fijado</button>
            <!-- NUEVO: modo de audio -->
            <button id="toggleAudioMode" title="Cambiar modo de audio">Audio: foco</button>
          </div>
        </div>
        <div class="stage-video" id="stage"><!-- presenter video here --></div>
      </div>

      <div class="kv">
        <strong>Participantes</strong>
        <footer class="controles">
          <button id="pip">PiP (mi v√≠deo)</button>
        </footer>
      </div>

      <div class="grid" id="grid">
        <div class="tile" data-self="1">
          <video id="localVideo" autoplay playsinline muted title="Yo"></video>
          <div class="nameplate"><span id="localName">Yo</span><span class="mic" id="localMic">üîá</span></div>
          <button class="btn-pin" data-pin="local">üìå</button>
        </div>
      </div>
    </main>
  </div>
</section>

<script>
/* ---------------- Configuraci√≥n ---------------- */
const API = 'signaling.php';
const pcConfig = {
  iceServers: [
    { urls: ['stun:stun.l.google.com:19302'] },
    {
      urls: [
        'turn:jocarsa.com:3478?transport=udp',
        'turn:jocarsa.com:3478?transport=tcp',
        'turns:jocarsa.com:5349?transport=tcp'
      ],
      username: 'jocarsa',
      credential: 'supersecreto123'
    }
  ]
};

/* ---------------- Estado ---------------- */
let salaId='', salaPass='', miId='', miNombre='', miRol='user', tituloSala='';
let streamLocal=null, isSharing=false;
let screenShareStream = null; // para cortar displayMedia limpiamente
let peers = new Map(); // peerId -> { pc, dc, name, role, tile, video, micEl, nameEl }
let peerNames = new Map();
let lastId = 0;
let polling = false;
let hbTimer = null;
let pinnedPeer = null;        // explicit pin (user override)
let presenterPeer = null;     // current presenter's peerId (auto)

let userAudioEnabled = false;  // desbloqueado por gesto del usuario
let lastStagePeerId = null;
let audioMode = 'focus'; // 'focus' (solo escenario) | 'all' (todos los remotos)

const $ = s => document.querySelector(s);
function uid(){ return 'p_' + Math.random().toString(36).slice(2,10); }
function setEstado(t){ $('#estado').textContent = t; }
function limpiaHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function wirePeerLogging(peerId, pc){
  pc.onconnectionstatechange = ()=> console.log(`[${peerId}]`, pc.connectionState);
  pc.oniceconnectionstatechange = ()=> console.log(`[${peerId}] ice=`, pc.iceConnectionState);
  pc.onicegatheringstatechange = ()=> console.log(`[${peerId}] iceGather=`, pc.iceGatheringState);
  pc.onsignalingstatechange = ()=> console.log(`[${peerId}] signal=`, pc.signalingState);
}
function errorAcceso(msg){ const e=$('#errAcceso'); e.textContent = msg; e.style.display='block'; }
function isCaller(peerId){ return miId < peerId; }

/* ----- Audio unmute banner ----- */
const audioBanner = $('#audioBanner');
$('#enableAudio').onclick = () => {
  audioBanner.style.display = 'none';
  userAudioEnabled = true;
  enforceAudioFocus();
};

/* Also allow one-tap anywhere to unlock */
const oneTapHandler = (ev)=>{
  const tag = ev.target.tagName;
  if (['INPUT','BUTTON','SELECT','TEXTAREA','A'].includes(tag)) return;
  audioBanner.style.display='none';
  userAudioEnabled = true;
  enforceAudioFocus();
  document.removeEventListener('click', oneTapHandler, true);
  document.removeEventListener('keydown', oneTapKeyHandler, true);
};
const oneTapKeyHandler = ()=>{
  audioBanner.style.display='none';
  userAudioEnabled = true;
  enforceAudioFocus();
  document.removeEventListener('click', oneTapHandler, true);
  document.removeEventListener('keydown', oneTapKeyHandler, true);
};
document.addEventListener('click', oneTapHandler, true);
document.addEventListener('keydown', oneTapKeyHandler, true);

/* ---------------- Fullscreen + Theater ---------------- */
const fsBtn = $('#toggleFS');
fsBtn.onclick = async ()=>{
  const stage = $('#stage');
  try{
    if (!document.fullscreenElement) {
      await stage.requestFullscreen();
    } else {
      await document.exitFullscreen();
    }
  }catch(e){}
};
document.addEventListener('fullscreenchange', ()=>{
  fsBtn.textContent = document.fullscreenElement ? 'Salir de pantalla completa' : 'Pantalla completa';
});

const theaterBtn = $('#toggleTheater');
theaterBtn.onclick = ()=>{
  document.body.classList.toggle('theater');
  theaterBtn.textContent = document.body.classList.contains('theater') ? 'Salir de vista amplia' : 'Vista amplia';
};

/* ---------------- VAD (speaking indicator) ---------------- */
function attachVAD(videoEl, tile){
  try{
    if (!videoEl || !videoEl.srcObject) return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const src = ctx.createMediaStreamSource(videoEl.srcObject);
    const analyser = ctx.createAnalyser(); analyser.fftSize = 512;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    const loop = ()=>{
      analyser.getByteFrequencyData(data);
      const rms = Math.sqrt(data.reduce((a,b)=>a+b*b,0)/data.length);
      tile.classList.toggle('speaking', rms > 30);
      requestAnimationFrame(loop);
    };
    loop();
  }catch(e){}
}

/* ---------------- Tiles ---------------- */
function buildTile(peerId, name, role){
  const tile = document.createElement('div'); tile.className='tile'; tile.dataset.peer=peerId;
  const v = document.createElement('video');
  v.autoplay = true; v.playsInline = true; v.muted = true; // safe until user allows audio
  v.dataset.peer = peerId;

  const plate = document.createElement('div'); plate.className='nameplate';
  const nm = document.createElement('span'); nm.textContent = name || peerId;
  const mic = document.createElement('span'); mic.className='mic'; mic.textContent='üéôÔ∏è';
  plate.appendChild(nm); plate.appendChild(mic);

  const pin = document.createElement('button'); pin.className='btn-pin'; pin.textContent='üìå';
  pin.onclick = ()=> { pinnedPeer = (peerId==='local' ? 'local' : peerId); renderStage(); };

  tile.appendChild(v); tile.appendChild(plate); tile.appendChild(pin);
  $('#grid').appendChild(tile);
  return {tile, video:v, micEl:mic, nameEl:nm};
}
function setNameOnTile(peerId, name){
  const b = peers.get(peerId); if (!b) return;
  b.name = name;
  if (b.nameEl) b.nameEl.textContent = name;
}

/* ---------------- Stage logic + Audio focus ---------------- */
function currentStagePeer(){
  if (pinnedPeer) return pinnedPeer;
  if (presenterPeer) return presenterPeer;
  return null;
}
function enforceAudioFocus(){
  // Silenciar siempre el local (evitar loopback)
  const local = document.getElementById('localVideo');
  if (local) local.muted = true;

  // Si el usuario no ha desbloqueado el audio, forzar mute en remotos
  if (!userAudioEnabled) {
    audioBanner.style.display = 'flex';
    document.querySelectorAll('#grid video').forEach(v=>{
      if (!v.closest('[data-self]')) v.muted = true;
    });
    return;
  }

  if (audioMode === 'focus') {
    // Modo foco: solo suena el del escenario (si no es el local)
    const stageId = currentStagePeer();
    document.querySelectorAll('#grid video').forEach(v=>{
      if (!v.closest('[data-self]')) v.muted = true;
    });
    if (stageId && stageId !== 'local') {
      const b = peers.get(stageId);
      if (b && b.video) {
        try { b.video.muted = false; b.video.play().catch(()=>{}); } catch(e){}
      }
    }
  } else {
    // Modo todos: desmutear todos los remotos
    document.querySelectorAll('#grid video').forEach(v=>{
      if (!v.closest('[data-self]')) {
        try { v.muted = false; v.play().catch(()=>{}); } catch(e){}
      }
    });
  }
}
function renderStage(){
  const stage = $('#stage');
  stage.innerHTML = '';
  const id = currentStagePeer();
  if (!id) { lastStagePeerId=null; enforceAudioFocus(); return; }

  const wrap = document.createElement('div'); wrap.style.position='relative'; wrap.style.width='100%'; wrap.style.height='100%';

  if (id === 'local'){
    const v = $('#localVideo');
    const big = document.createElement('video');
    big.autoplay = true; big.playsInline = true; big.muted = true; // local muted
    big.srcObject = v.srcObject || null;
    big.style.width='100%'; big.style.height='100%'; big.style.objectFit='contain'; big.style.background='#000'; big.style.borderRadius='10px';
    big.play().catch(()=>{});
    const plate = document.createElement('div'); plate.className='nameplate';
    plate.innerHTML = `<span>${limpiaHtml($('#localName').textContent)}</span> <span class="mic">${$('#mic').getAttribute('aria-pressed')==='true'?'üéôÔ∏è':'üîá'}</span>`;
    wrap.appendChild(big); wrap.appendChild(plate);
    stage.appendChild(wrap);
    lastStagePeerId = 'local';
    enforceAudioFocus();
    return;
  }

  const b = peers.get(id); if (!b || !b.video) { lastStagePeerId=null; return; }
  const big = document.createElement('video');
  big.autoplay = true; big.playsInline = true; big.muted = !userAudioEnabled; // ser√° ajustado por enforceAudioFocus
  big.srcObject = b.video.srcObject;
  big.style.width='100%'; big.style.height='100%'; big.style.objectFit='contain'; big.style.background='#000'; big.style.borderRadius='10px';
  big.play().catch(()=>{ audioBanner.style.display='flex'; });
  const name = b.name || id;
  const plate = document.createElement('div'); plate.className='nameplate';
  plate.innerHTML = `<span>${limpiaHtml(name)}</span> <span class="mic">${big.muted?'üîá':'üéôÔ∏è'}</span>`;
  wrap.appendChild(big); wrap.appendChild(plate);
  stage.appendChild(wrap);
  lastStagePeerId = id;
  enforceAudioFocus();
}
$('#unpin').onclick = ()=>{ pinnedPeer=null; renderStage(); };

/* ---------------- Acceso ---------------- */
$('#btnEntrar').onclick = async ()=>{
  const id = $('#a_sala').value.trim();
  const pass = $('#a_pass').value;
  const nom = $('#a_nombre').value.trim() || 'An√≥nimo';
  if(!id || !pass){ errorAcceso('Debes indicar ID y contrase√±a de sala.'); return; }

  miId = uid(); miNombre = nom; salaId = id; salaPass = pass;

  const r = await fetch(API, {method:'POST', body:new URLSearchParams({
    action:'join', room:salaId, room_password:salaPass, peer:miId, name:miNombre
  })}).then(r=>r.json()).catch(e=>({ok:false,data:'error de red: '+(e?.message||e)}));

  if(!r.ok){
    miId = '';
    errorAcceso(typeof r.data==='string' ? r.data : 'Acceso denegado. Revisa la sala y la contrase√±a.');
    return;
  }

  tituloSala = (r.data && r.data.title) || salaId;
  miRol = (r.data && r.data.role) || 'user';
  $('#tituloSala').textContent = `${tituloSala} ‚Äî ${miRol==='presenter'?'Presentador':'Usuario'}`;
  $('#localName').textContent = miNombre + (miRol==='presenter'?' (presentador)':'');
  presenterPeer = (miRol==='presenter') ? 'local' : presenterPeer;
  $('#acceso').style.display = 'none';
  $('#app').style.display = 'block';
  setEstado('conectado');

  // Presentador entra con dispositivos ON; usuarios OFF (lazy)
  if (miRol === 'presenter'){
    $('#cam').setAttribute('aria-pressed','true');
    $('#mic').setAttribute('aria-pressed','true');
  } else {
    $('#cam').setAttribute('aria-pressed','false');
    $('#mic').setAttribute('aria-pressed','false');
  }

  await iniciarConexiones();
  renderStage();
};

async function iniciarConexiones(){
  if (miRol === 'presenter') {
    await ensureLocalMedia({audio:true, video:true});
  }
  await refrescarPeers();
  iniciarHeartbeat();
  iniciarPolling();
}

/* ---------------- Heartbeat (+ grid verify) ---------------- */
function iniciarHeartbeat(){
  if (hbTimer) clearInterval(hbTimer);
  hbTimer = setInterval(async ()=>{
    if (!salaId || !miId) return;
    try {
      await fetch(API, {method:'POST', body:new URLSearchParams({ action:'heartbeat', room:salaId, peer:miId })});
      await verifyGridAgainstServer(); // asegura tiles
    } catch (e) {}
  }, 10000);
}

/* ---------------- Media (incremental) ---------------- */
async function ensureLocalMedia({audio=false, video=false} = {}){
  let renegotiate = false;

  // helper para a√±adir/actualizar track en todos los peers
  const upsertSender = (kind, track, stream) => {
    for (const { pc } of peers.values()) {
      const sender = pc.getSenders().find(s => s.track && s.track.kind === kind);
      if (sender) {
        try { sender.replaceTrack(track); } catch {}
      } else if (track) {
        try { pc.addTrack(track, stream); } catch {}
        renegotiate = true;
      }
    }
  };

  if (streamLocal){
    const at = streamLocal.getAudioTracks()[0] || null;
    const vt = streamLocal.getVideoTracks()[0] || null;

    // AUDIO
    if (audio) {
      if (at) {
        at.enabled = true;
      } else {
        try{
          const aStream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:false },
            video: false
          });
          const aTrack = aStream.getAudioTracks()[0];
          if (!streamLocal) streamLocal = new MediaStream();
          streamLocal.addTrack(aTrack);
          upsertSender('audio', aTrack, streamLocal);
        }catch(e){ console.warn('No audio:', e); }
      }
    } else if (at) {
      at.enabled = false;
      upsertSender('audio', at, streamLocal);
    }

    // V√çDEO (solo c√°mara; la compartici√≥n de pantalla va por otra ruta)
    if (video) {
      if (vt) {
        vt.enabled = true;
      } else {
        try{
          const vStream = await navigator.mediaDevices.getUserMedia({
            audio: false,
            video: { width:{ideal:1280}, height:{ideal:720} }
          });
          const vTrack = vStream.getVideoTracks()[0];
          if (!streamLocal) streamLocal = new MediaStream();
          streamLocal.addTrack(vTrack);
          if (!screenShareStream) {
            const lv = document.getElementById('localVideo');
            lv.srcObject = streamLocal;
          }
          upsertSender('video', vTrack, streamLocal);
          const localTile = document.querySelector('.tile[data-self]');
          if (localTile) attachVAD(document.getElementById('localVideo'), localTile);
        }catch(e){ console.warn('No video:', e); }
      }
    } else if (vt) {
      vt.enabled = false;
      upsertSender('video', vt, streamLocal);
    }
  }
  else {
    // No existe streamLocal a√∫n ‚Üí pedir exactamente lo que haga falta
    if (!audio && !video) return;
    try{
      streamLocal = await navigator.mediaDevices.getUserMedia({
        audio: audio ? { echoCancellation:true, noiseSuppression:true, autoGainControl:false } : false,
        video: video ? { width:{ideal:1280}, height:{ideal:720} } : false
      });
      const at = streamLocal.getAudioTracks()[0] || null;
      const vt = streamLocal.getVideoTracks()[0] || null;

      if (!screenShareStream) {
        const lv = document.getElementById('localVideo');
        lv.srcObject = streamLocal;
      }
      if (vt) {
        const localTile = document.querySelector('.tile[data-self]');
        if (localTile) attachVAD(document.getElementById('localVideo'), localTile);
      }

      if (at) upsertSender('audio', at, streamLocal);
      if (vt) upsertSender('video', vt, streamLocal);
      renegotiate = true;
    }catch(e){
      alert('No se puede acceder a c√°mara/micro. Comprueba HTTPS, permisos y Permissions-Policy.\n\n' + (e.message||e));
      return;
    }
  }

  // Renegociaci√≥n si hemos a√±adido senders nuevos
  if (renegotiate){
    for (const [pid, bag] of peers.entries()){
      if (bag.pc.connectionState !== 'closed'){
        try{
          if (isCaller(pid)){
            const offer = await bag.pc.createOffer();
            await bag.pc.setLocalDescription(offer);
            await enviarSig({to:pid,type:'offer',payload:JSON.stringify(offer)});
          }
        }catch(e){}
      }
    }
  }

  // UI mic local
  const a = streamLocal?.getAudioTracks?.()[0];
  document.getElementById('localMic').textContent = (a && a.enabled) ? 'üéôÔ∏è' : 'üîá';

  renderStage();
  enforceAudioFocus();
}

/* ---------------- Peer creation ---------------- */
function getOrCreatePeer(peerId){
  let b = peers.get(peerId);
  if (b) return b;

  const pc = new RTCPeerConnection(pcConfig);
  const bag = { pc, dc:null, name: peerNames.get(peerId) || peerId, role:'user', tile:null, video:null, micEl:null, nameEl:null };
  peers.set(peerId, bag);
  wirePeerLogging(peerId, pc);

  pc.onicecandidate = e => { if(e.candidate) enviarSig({to:peerId,type:'candidate',payload:JSON.stringify(e.candidate)}); };

  pc.ontrack = e => {
    if (!bag.tile){
      const made = buildTile(peerId, bag.name, bag.role);
      bag.tile = made.tile; bag.video = made.video; bag.micEl = made.micEl; bag.nameEl = made.nameEl;
    }
    const stream = (e.streams && e.streams[0]) ? e.streams[0] : new MediaStream([e.track]);
    bag.video.srcObject = stream;
    bag.video.muted = true;
    bag.video.play().catch(()=>{ audioBanner.style.display='flex'; });
    attachVAD(bag.video, bag.tile);
    if (presenterPeer === peerId) renderStage();
    enforceAudioFocus();
  };

  if(streamLocal) streamLocal.getTracks().forEach(t=>pc.addTrack(t, streamLocal));
  return bag;
}

async function conectarConPeer(peerId, asCaller){
  const b = getOrCreatePeer(peerId);
  const pc = b.pc;

  if (asCaller){
    if (!b.dc){
      b.dc = pc.createDataChannel('chat');
      b.dc.onopen = ()=> log(`üü¢ Chat con ${b.name}`);
      b.dc.onmessage = e => onDCMessage(peerId, e.data);
    }
    if (pc.signalingState === 'stable'){
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await enviarSig({to:peerId,type:'offer',payload:JSON.stringify(offer)});
    }
  } else {
    if (!b.dc){
      pc.ondatachannel = ev=>{
        b.dc = ev.channel;
        b.dc.onopen = ()=>log(`üü¢ Chat con ${b.name}`);
        b.dc.onmessage = e => onDCMessage(peerId, e.data);
      };
    }
  }
}

function onDCMessage(fromPeerId, raw){
  try{
    const msg = JSON.parse(raw);
    if (msg.type === 'chat'){
      const name = peerNames.get(fromPeerId) || fromPeerId;
      log(`<b>${limpiaHtml(name)}</b>: ${limpiaHtml(msg.text)}`);
    } else if (msg.type === 'status' && msg.key === 'mic'){
      const b = peers.get(fromPeerId); if (b && b.micEl) b.micEl.textContent = msg.value ? 'üéôÔ∏è' : 'üîá';
    }
  }catch{
    const name = peerNames.get(fromPeerId) || fromPeerId;
    log(`<b>${limpiaHtml(name)}</b>: ${limpiaHtml(raw)}`);
  }
}

/* ------------ Signal handlers ------------ */
async function alRecibirOffer(from, payload){
  const desc = JSON.parse(payload);
  const b = getOrCreatePeer(from);
  const pc = b.pc;
  if (pc.signalingState === 'have-local-offer'){ try{ await pc.setLocalDescription({type:'rollback'});}catch{} }
  await pc.setRemoteDescription(desc);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await enviarSig({to:from,type:'answer',payload:JSON.stringify(answer)});
}

async function alRecibirAnswer(from, payload){
  const b = peers.get(from); if(!b) return;
  const pc = b.pc;
  if (pc.signalingState !== 'have-local-offer'){ console.warn('Ignoro answer (', pc.signalingState, ')'); return; }
  await pc.setRemoteDescription(JSON.parse(payload));
}

async function alRecibirCandidate(from, payload){
  const b = peers.get(from); if(!b) return;
  try{ const cand = JSON.parse(payload); if (cand) await b.pc.addIceCandidate(cand); }catch(e){}
}

async function enviarSig({to=null,type,payload}){
  try{ await fetch(API,{method:'POST', body:new URLSearchParams({ action:'signal', room:salaId, from:miId, to, type, payload })}); }catch(e){}
}

/* ---------------- Polling ---------------- */
function iniciarPolling(){
  if(polling) return; polling = true;
  (async function bucle(){
    try{
      const r = await fetch(`${API}?action=poll&room=${encodeURIComponent(salaId)}&peer=${encodeURIComponent(miId)}&since_id=${lastId}`).then(r=>r.json());
      const msgs = r.data || [];
      for(const m of msgs){
        lastId = Math.max(lastId, m.id);
        if (m.type==='join'){
          const p = JSON.parse(m.payload||'{}');
          peerNames.set(m.from_id, p.name || m.from_id);
          if (p.role === 'presenter'){ presenterPeer = m.from_id; if (!pinnedPeer) renderStage(); }
          await refrescarPeers();
        }
        else if (m.type==='leave'){
          if (presenterPeer === m.from_id){ presenterPeer = (miRol==='presenter') ? 'local' : null; if (!pinnedPeer) renderStage(); }
          await refrescarPeers();
        }
        else if (m.type==='offer'){ await alRecibirOffer(m.from_id, m.payload); }
        else if (m.type==='answer'){ await alRecibirAnswer(m.from_id, m.payload); }
        else if (m.type==='candidate'){ await alRecibirCandidate(m.from_id, m.payload); }
        else if (m.type==='chat'){
          const p = JSON.parse(m.payload||'{}');
          const name = peerNames.get(m.from_id) || p.name || m.from_id;
          log(`<b>${limpiaHtml(name)}</b>: ${limpiaHtml(p.text||'')}`);
        }
        else if (m.type==='status'){
          const p = JSON.parse(m.payload||'{}');
          if (p.key==='mic'){
            const b = peers.get(m.from_id); if (b && b.micEl) b.micEl.textContent = p.value ? 'üéôÔ∏è' : 'üîá';
          }
        }
        else if (m.type==='admin' && (m.to_id===miId)){ // acciones dirigidas
          const p = JSON.parse(m.payload||'{}');
          if (p.action==='force-mute'){
            const a = streamLocal?.getAudioTracks?.()[0];
            if (a){ a.enabled = false; $('#mic').setAttribute('aria-pressed','false'); $('#localMic').textContent = 'üîá'; renderStage(); }
            log(`<i class="hint">Has sido silenciado por el presentador.</i>`);
          } else if (p.action==='kick'){
            alert('Has sido expulsado de la sala por el presentador.');
            await salir();
          }
        }
        else if (m.type==='moderation'){ // broadcast para UI local (mute de v√≠deo remoto)
          const p = JSON.parse(m.payload||'{}');
          if (p.op==='mute' && p.target){
            const v = document.querySelector(`video[data-peer="${p.target}"]`);
            if (v){ v.muted = true; }
            log(`<i class="hint">Usuario ${p.target} ha sido silenciado.</i>`);
          }
        }
      }
    }catch(e){ /* ignore transient */ }
    setTimeout(bucle, 200);
  })();
}

/* ---------------- List/refresh peers ---------------- */
async function refrescarPeers(){
  const r = await fetch(`${API}?action=list_peers&room=${encodeURIComponent(salaId)}`).then(r=>r.json()).catch(()=>({ok:false,data:[]}));
  if(!r.ok) return;
  const lista = (r.data||[]).filter(p=>p.id!==miId);

  lista.forEach(p=>{ peerNames.set(p.id, p.name); const b=peers.get(p.id); if(b){ b.name=p.name; b.role=p.role; setNameOnTile(p.id, p.name + (p.role==='presenter'?' (presentador)':'')); } });
  const currentPresenter = lista.find(p=>p.role==='presenter');
  presenterPeer = currentPresenter ? currentPresenter.id : ((miRol==='presenter')?'local':null);
  if (!pinnedPeer) renderStage();

  // Participantes + acciones si presentador
  $('#peers').innerHTML = lista.map(p=>{
    const base = `${limpiaHtml(p.name)} <small class="hint">(${p.role})</small>`;
    if (miRol==='presenter'){
      return `<li>
        <span>${base}</span>
        <span class="peer-actions">
          <button class="mute" data-peer="${p.id}" title="Silenciar usuario">üîá</button>
          <button class="kick" data-peer="${p.id}" title="Expulsar de la sala">‚õî</button>
        </span>
      </li>`;
    }
    return `<li>${base}</li>`;
  }).join('');

  // Conectar nuevos
  const known = new Set(peers.keys());
  for(const p of lista){
    if (!peers.has(p.id)){
      const bag = getOrCreatePeer(p.id);
      bag.name = p.name; bag.role = p.role;
      await conectarConPeer(p.id, isCaller(p.id));
    }
  }
  // Limpiar los que ya no est√°n
  for (const pid of known){
    if (!lista.find(p=>p.id===pid)){
      const b = peers.get(pid);
      if (b?.pc) try{ b.pc.close(); }catch{}
      if (b?.tile) b.tile.remove();
      peers.delete(pid);
      if (pinnedPeer===pid) { pinnedPeer=null; renderStage(); }
    }
  }
  // ensure DOM grid mirrors peers map
  ensureAllTilesExist();
}

/* ---------------- Grid verification (used by heartbeat) ---------------- */
function ensureAllTilesExist(){
  for (const [pid, bag] of peers.entries()){
    if (!bag.tile){
      const made = buildTile(pid, bag.name, bag.role);
      bag.tile = made.tile; bag.video = made.video; bag.micEl = made.micEl; bag.nameEl = made.nameEl;
    }
  }
  // remove stray tiles without corresponding peer
  document.querySelectorAll('#grid .tile[data-peer]').forEach(tile=>{
    const pid = tile.dataset.peer;
    if (!peers.has(pid)){
      tile.remove();
    }
  });
}
async function verifyGridAgainstServer(){
  const r = await fetch(`${API}?action=list_peers&room=${encodeURIComponent(salaId)}`).then(r=>r.json()).catch(()=>({ok:false,data:[]}));
  if(!r.ok) return;
  const serverIds = new Set((r.data||[]).filter(p=>p.id!==miId).map(p=>p.id));
  for (const sid of serverIds){
    if (!peers.has(sid)){
      const bag = getOrCreatePeer(sid);
      await conectarConPeer(sid, isCaller(sid));
    }
  }
  for (const pid of [...peers.keys()]){
    if (!serverIds.has(pid)){
      const b = peers.get(pid);
      if (b?.pc) try{ b.pc.close(); }catch{}
      if (b?.tile) b.tile.remove();
      peers.delete(pid);
    }
  }
  ensureAllTilesExist();
}

/* ---------------- Stop ALL outgoing media ---------------- */
async function stopAllOutgoingMedia(){
  try{
    for (const {pc} of peers.values()){
      try{
        pc.getSenders().forEach(s=>{
          try{ s.replaceTrack(null); }catch{}
        });
      }catch{}
    }
    if (screenShareStream){
      try { screenShareStream.getTracks().forEach(t=>t.stop()); } catch {}
      screenShareStream = null;
    }
    if (streamLocal){
      try { streamLocal.getTracks().forEach(t=>t.stop()); } catch {}
      streamLocal = null;
    }
    isSharing = false;
    $('#comp')?.setAttribute('aria-pressed','false');
    $('#cam')?.setAttribute('aria-pressed','false');
    $('#mic')?.setAttribute('aria-pressed','false');
    const lm = document.querySelector('#localMic'); if (lm) lm.textContent = 'üîá';
    const lv = document.getElementById('localVideo');
    if (lv){ lv.srcObject = null; }
    pinnedPeer = null;
    renderStage();
    enforceAudioFocus();
  }catch(e){}
}

/* ---------------- Controles UI ---------------- */
$('#salir').onclick = salir;
async function salir(){
  if(salaId && miId){
    try{ await fetch(API,{method:'POST', body:new URLSearchParams({action:'leave', room:salaId, peer:miId})}); }catch(e){}
  }
  await stopAllOutgoingMedia();
  for(const {pc} of peers.values()) try{ pc.close(); }catch(e){}
  peers.clear(); lastId=0; polling=false;
  if (hbTimer) { clearInterval(hbTimer); hbTimer=null; }
  $('#grid').querySelectorAll('.tile[data-peer]').forEach(v=>v.remove());
  $('#chatlog').innerHTML = '';
  $('#tituloSala').textContent='Sin conexi√≥n'; setEstado('desconectado');
  $('#app').style.display='none'; $('#acceso').style.display='block';
  userAudioEnabled = false;
  document.addEventListener('click', oneTapHandler, true);
  document.addEventListener('keydown', oneTapKeyHandler, true);
}
window.addEventListener('beforeunload', salir);

/* Switch: C√°mara */
$('#cam').onclick = async ()=>{
  const btn = $('#cam');
  const want = btn.getAttribute('aria-pressed') !== 'true';
  await ensureLocalMedia({ video: want, audio: $('#mic').getAttribute('aria-pressed')==='true' });
  const v=streamLocal?.getVideoTracks?.()[0];
  if(!v){ btn.setAttribute('aria-pressed','false'); return; }
  v.enabled = want;
  btn.setAttribute('aria-pressed', v.enabled ? 'true' : 'false');
  for(const {pc} of peers.values()){
    const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
    if(sender && v) sender.replaceTrack(v);
    if(!sender && v) pc.addTrack(v, streamLocal);
  }
  renderStage();
};

/* Switch: Micr√≥fono */
$('#mic').onclick = async ()=>{
  const btn = $('#mic');
  const want = btn.getAttribute('aria-pressed') !== 'true';
  await ensureLocalMedia({ audio: want, video: $('#cam').getAttribute('aria-pressed')==='true' });
  const a=streamLocal?.getAudioTracks?.()[0];
  if(!a){ btn.setAttribute('aria-pressed','false'); $('#localMic').textContent='üîá'; return; }
  a.enabled = want;
  btn.setAttribute('aria-pressed', a.enabled ? 'true' : 'false');
  for (const {dc} of peers.values()) if(dc && dc.readyState==='open') dc.send(JSON.stringify({type:'status', key:'mic', value:a.enabled}));
  enviarSig({type:'status', payload: JSON.stringify({key:'mic', value:a.enabled})});
  $('#localMic').textContent = a.enabled ? 'üéôÔ∏è' : 'üîá';
  renderStage();
};

/* Switch: Compartir pantalla (toggle) */
$('#comp').onclick = async ()=>{
  const btn = $('#comp');
  try{
    if(!isSharing){
      const ss = await navigator.mediaDevices.getDisplayMedia({video:true, audio:false});
      screenShareStream = ss; // keep reference to stop later
      const newTrack = ss.getVideoTracks()[0];
      $('#localVideo').srcObject = ss;
      for(const {pc} of peers.values()){
        const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
        if(sender) sender.replaceTrack(newTrack);
        else pc.addTrack(newTrack, ss);
      }
      isSharing = true;
      btn.setAttribute('aria-pressed','true');
      newTrack.onended = ()=> revertToCamera();
      renderStage();
    }else{
      await revertToCamera();
      btn.setAttribute('aria-pressed','false');
    }
  }catch(e){}
};
async function revertToCamera(){
  if (screenShareStream){
    try { screenShareStream.getTracks().forEach(t=>t.stop()); } catch {}
    screenShareStream = null;
  }
  const camTrack = streamLocal?.getVideoTracks?.()[0] || null;
  if (camTrack){
    $('#localVideo').srcObject = streamLocal;
    for(const {pc} of peers.values()){
      const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
      if(sender) sender.replaceTrack(camTrack);
    }
  } else {
    $('#localVideo').srcObject = null;
    for(const {pc} of peers.values()){
      const sender = pc.getSenders().find(s=>s.track && s.track.kind==='video');
      if(sender) try{ sender.replaceTrack(null); }catch{}
    }
  }
  isSharing = false;
  $('#comp').setAttribute('aria-pressed','false');
  renderStage();
}

/* Chat */
$('#chat').addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){
    const txt = e.target.value.trim(); if(!txt) return;
    const payload = JSON.stringify({type:'chat', text:txt, name:miNombre});
    for(const {dc} of peers.values()) if(dc && dc.readyState==='open') dc.send(payload);
    enviarSig({type:'chat', payload});
    log(`<b>${limpiaHtml(miNombre)}</b>: ${limpiaHtml(txt)}`);
    e.target.value='';
  }
});
$('#pip').onclick = async ()=>{
  const v=$('#localVideo');
  if(document.pictureInPictureElement) document.exitPictureInPicture();
  else if(document.pictureInPictureEnabled && v.srcObject) await v.requestPictureInPicture();
};

/* NUEVO: bot√≥n modo audio */
const toggleAudioModeBtn = document.getElementById('toggleAudioMode');
toggleAudioModeBtn.onclick = ()=>{
  audioMode = (audioMode === 'focus') ? 'all' : 'focus';
  toggleAudioModeBtn.textContent = (audioMode === 'focus') ? 'Audio: foco' : 'Audio: todos';
  enforceAudioFocus();
};

/* Delegaci√≥n de acciones (presentador) */
$('#peers').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const pid = btn.dataset.peer; if(!pid) return;
  if (miRol !== 'presenter') return;

  if (btn.classList.contains('mute')){
    await enviarSig({type:'moderation', payload: JSON.stringify({op:'mute', target:pid})});
    await enviarSig({to:pid, type:'admin', payload: JSON.stringify({action:'force-mute'})});
  } else if (btn.classList.contains('kick')){
    await enviarSig({to:pid, type:'admin', payload: JSON.stringify({action:'kick'})});
  }
});

/* Chat autoscroll */
function log(html){
  const d=document.createElement('div'); d.innerHTML = html;
  const box=$('#chatlog'); const atBottom = Math.abs(box.scrollTop + box.clientHeight - box.scrollHeight) < 10;
  box.appendChild(d);
  if(atBottom) box.scrollTop = box.scrollHeight;
}

/* Prefill */
const url = new URL(location.href);
$('#a_sala').value = url.searchParams.get('sala') || '';
$('#a_nombre').value = url.searchParams.get('nombre') || '';
</script>
</body>
</html>


```
**signaling.php**
```php
<?php
declare(strict_types=1);
header('Content-Type: application/json; charset=utf-8');

function j($ok, $data = null, $code = 200) {
  http_response_code($code);
  echo json_encode(['ok'=>$ok,'data'=>$data], JSON_UNESCAPED_SLASHES);
  exit;
}
function now() { return (int)floor(microtime(true)); }

try {
  $dbFile = __DIR__ . '/signaling.db';
  $db = new PDO('sqlite:' . $dbFile, '', '', [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
  ]);
} catch (Throwable $e) {
  j(false, 'db open error: '.$e->getMessage(), 500);
}

/* ---------- Esquema e √≠ndices (migraciones simples) ---------- */
$db->exec("
CREATE TABLE IF NOT EXISTS rooms(
  id TEXT PRIMARY KEY,
  title TEXT,
  passhash_user TEXT,
  passhash_presenter TEXT,
  created_at INTEGER
);
CREATE TABLE IF NOT EXISTS participants(
  id TEXT PRIMARY KEY,
  room_id TEXT,
  name TEXT,
  role TEXT,
  joined_at INTEGER,
  last_seen INTEGER
);
CREATE TABLE IF NOT EXISTS signals(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  room_id TEXT,
  from_id TEXT,
  to_id TEXT,
  type TEXT,
  payload TEXT,
  created_at INTEGER
);
CREATE TABLE IF NOT EXISTS activity_logs(
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  ts INTEGER,
  room_id TEXT,
  peer_id TEXT,
  event TEXT,
  meta TEXT
);
CREATE INDEX IF NOT EXISTS idx_signals_room_id ON signals(room_id, id);
CREATE INDEX IF NOT EXISTS idx_participants_room ON participants(room_id, last_seen);
");

/* back-compat de columnas (por si ven√≠as del esquema antiguo) */
try { $db->exec("ALTER TABLE rooms ADD COLUMN passhash_user TEXT"); } catch(Throwable $e){}
try { $db->exec("ALTER TABLE rooms ADD COLUMN passhash_presenter TEXT"); } catch(Throwable $e){}
try { $db->exec("ALTER TABLE participants ADD COLUMN role TEXT"); } catch(Throwable $e){}

function get_room(PDO $db, string $roomId) {
  $st = $db->prepare('SELECT * FROM rooms WHERE id=?'); $st->execute([$roomId]); return $st->fetch();
}
function log_activity(PDO $db, string $room, string $peer, string $event, $meta=null) {
  $db->prepare('INSERT INTO activity_logs(ts, room_id, peer_id, event, meta) VALUES(?,?,?,?,?)')
     ->execute([now(), $room, $peer, $event, $meta ? (is_string($meta)?$meta:json_encode($meta)) : null]);
}
function signal_insert(PDO $db, string $room, string $from, ?string $to, string $type, string $payloadRaw) {
  $db->prepare('INSERT INTO signals(room_id, from_id, to_id, type, payload, created_at)
                VALUES (?,?,?,?,?,?)')->execute([$room, $from, $to, $type, $payloadRaw, now()]);
}

function prune_stale(PDO $db, string $room, int $staleSecs) {
  $threshold = now() - $staleSecs;
  $sel = $db->prepare('SELECT id FROM participants WHERE room_id=? AND last_seen < ?');
  $sel->execute([$room, $threshold]);
  $stales = $sel->fetchAll(PDO::FETCH_COLUMN);
  if (!$stales) return;
  $del = $db->prepare('DELETE FROM participants WHERE id=? AND room_id=?');
  foreach ($stales as $pid) {
    $del->execute([$pid, $room]);
    signal_insert($db, $room, $pid, null, 'leave', json_encode(['peer'=>$pid,'reason'=>'stale']));
    log_activity($db, $room, $pid, 'prune', ['reason'=>'stale','threshold'=>$threshold]);
  }
}

$STALE_SECS = 35;
$action = $_GET['action'] ?? $_POST['action'] ?? '';

try {

  if ($action === 'join') {
    $room = trim($_POST['room'] ?? '');
    $room_password = $_POST['room_password'] ?? '';
    $peer = trim($_POST['peer'] ?? '');
    $name = trim($_POST['name'] ?? $peer);
    if (!$room || !$peer) j(false, 'room/peer required', 400);

    $r = get_room($db, $room);
    if (!$r) j(false, 'room not found', 404);

    $role = null;
    if (!empty($r['passhash_presenter']) && password_verify($room_password, $r['passhash_presenter'])) {
      $role = 'presenter';
    } elseif (!empty($r['passhash_user']) && password_verify($room_password, $r['passhash_user'])) {
      $role = 'user';
    } else {
      j(false, 'invalid room password', 403);
    }

    $db->prepare('INSERT OR REPLACE INTO participants(id, room_id, name, role, joined_at, last_seen)
                  VALUES (?,?,?,?,?,?)')
       ->execute([$peer, $room, $name, $role, now(), now()]);

    signal_insert($db, $room, $peer, null, 'join', json_encode(['peer'=>$peer,'name'=>$name,'role'=>$role]));
    log_activity($db, $room, $peer, 'join', ['name'=>$name,'role'=>$role]);

    j(true, ['title'=>$r['title'], 'role'=>$role]);
  }

  if ($action === 'heartbeat') {
    $room = $_POST['room'] ?? '';
    $peer = $_POST['peer'] ?? '';
    if (!$room || !$peer) j(false, 'room/peer required', 400);
    $db->prepare('UPDATE participants SET last_seen=? WHERE id=? AND room_id=?')
       ->execute([now(), $peer, $room]);
    log_activity($db, $room, $peer, 'heartbeat');
    j(true, 'ok');
  }

  if ($action === 'leave') {
    $room = $_POST['room'] ?? '';
    $peer = $_POST['peer'] ?? '';
    if (!$room || !$peer) j(false, 'room/peer required', 400);
    $db->prepare('DELETE FROM participants WHERE id=? AND room_id=?')->execute([$peer, $room]);
    signal_insert($db, $room, $peer, null, 'leave', json_encode(['peer'=>$peer,'reason'=>'user']));
    log_activity($db, $room, $peer, 'leave');
    j(true, 'left');
  }

  if ($action === 'list_peers') {
    $room = $_GET['room'] ?? '';
    if (!$room) j(false, 'room required', 400);
    prune_stale($db, $room, $STALE_SECS);
    $stmt = $db->prepare('SELECT id,name,role FROM participants WHERE room_id=? ORDER BY joined_at');
    $stmt->execute([$room]);
    j(true, $stmt->fetchAll());
  }

  if ($action === 'signal') {
    $room = $_POST['room'] ?? '';
    $from = $_POST['from'] ?? '';
    $to   = $_POST['to']   ?? null;
    $type = $_POST['type'] ?? '';
    $payload = $_POST['payload'] ?? '';
    if (!$room || !$from || !$type || $payload==='') j(false, 'missing fields', 400);
    $db->prepare('INSERT INTO signals(room_id, from_id, to_id, type, payload, created_at)
                  VALUES (?,?,?,?,?,?)')->execute([$room, $from, $to, $type, $payload, now()]);
    log_activity($db, $room, $from, 'signal', ['type'=>$type, 'to'=>$to]);
    j(true, 'sent');
  }

  if ($action === 'poll') {
    $room = $_GET['room'] ?? '';
    $peer = $_GET['peer'] ?? '';
    $since_id = (int)($_GET['since_id'] ?? 0);
    if (!$room || !$peer) j(false, 'room/peer required', 400);

    prune_stale($db, $room, $STALE_SECS);

    $deadline = now() + 20;
    do {
      $st = $db->prepare('SELECT * FROM signals
                          WHERE room_id=?
                            AND id > ?
                            AND (to_id IS NULL OR to_id = ?)
                            AND from_id <> ?
                          ORDER BY id ASC');
      $st->execute([$room, $since_id, $peer, $peer]);
      $rows = $st->fetchAll();
      if ($rows) {
        log_activity($db, $room, $peer, 'poll_return', ['count'=>count($rows), 'since_id'=>$since_id]);
        j(true, $rows);
      }
      usleep(300000);
    } while (now() < $deadline);

    j(true, []);
  }

  // Crear/actualizar sala: POST room,title,pass_user,pass_presenter
  if ($action === 'create_room') {
    $room = trim($_POST['room'] ?? $_GET['room'] ?? '');
    $title = trim($_POST['title'] ?? $_GET['title'] ?? $room);
    $pu = $_POST['pass_user'] ?? $_GET['pass_user'] ?? '';
    $pp = $_POST['pass_presenter'] ?? $_GET['pass_presenter'] ?? '';
    if (!$room || !$pu || !$pp) j(false, 'room, pass_user, pass_presenter required', 400);

    $db->prepare("INSERT OR REPLACE INTO rooms(id,title,passhash_user,passhash_presenter,created_at)
                  VALUES(?,?,?,?,?)")
       ->execute([$room, $title, password_hash($pu, PASSWORD_DEFAULT), password_hash($pp, PASSWORD_DEFAULT), now()]);
    j(true, 'room created/updated');
  }

  j(false, 'unknown action', 404);

} catch (Throwable $e) {
  j(false, 'server error: '.$e->getMessage(), 500);
}


```