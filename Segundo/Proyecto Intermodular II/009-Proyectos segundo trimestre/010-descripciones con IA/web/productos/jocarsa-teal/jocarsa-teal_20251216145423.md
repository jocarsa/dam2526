# Reporte de proyecto

## Estructura del proyecto

```
/var/www/html/jocarsa-teal
├── .gitignore
├── README.md
├── auto_login.php
├── bloques
│   ├── cabeceraaplicacion.php
│   ├── cabeceratabla.php
│   ├── cabeza.php
│   ├── crearcarpeta.php
│   ├── definirtabla.php
│   ├── formulario.php
│   ├── listadoaplicaciones.php
│   ├── login.php
│   ├── navegacionaplicacion.php
│   ├── navegaciontabla.php
│   ├── paginador.php
│   └── tabla.php
├── clases
│   └── sqlite3.php
├── funciones
│   ├── Carpeta sin título
│   ├── construirCadenaRutaCarpeta.php
│   ├── construirRutaCarpeta.php
│   ├── construirTabla.php
│   ├── devolverNombreTabla.php
│   ├── devolverTablaAplicacion.php
│   ├── entrecomillar.php
│   ├── enviarmailsmtp.php
│   ├── funciones.php
│   ├── funcionesCodificacion.php
│   ├── inicializarDB.php
│   ├── logOperaciones.php
│   └── migasDePan.php
├── inc
│   ├── busqueda.php
│   ├── comprobarLogin.php
│   ├── css3colors.php
│   ├── errores.php
│   ├── informe.php
│   ├── log.php
│   └── manejadorPost.php
├── index.php
├── js
│   ├── camposdinamicoscreartabla.php
│   ├── creartabla.php
│   └── edit_fields.js
├── landing.html
├── log
│   └── log.csv
├── rutas
│   ├── aplicacion.php
│   ├── crearusuarios.php
│   ├── enviarmail.php
│   ├── gestionarusuarios.php
│   ├── mailsenviados.php
│   ├── parametroscompania.php
│   ├── tabla.php
│   └── whatsappsenviados.php
├── static
│   ├── logo.svg
│   ├── logoinvertido.svg
│   ├── report.css
│   ├── styles.css
│   └── uploads
│       ├── 1ºDAM Dist. exam 2nd term 24-25.docx.pdf
│       └── Empresa Tyris software - Alumno Albert Beltran DAM2.docx
└── update_field.php
```

## Código (intercalado)

# jocarsa-teal
**README.md**
```markdown
# jocarsa-teal
```
**auto_login.php**
```php
<?php
session_start();
header('Content-Type: application/json');
include "inc/errores.php";
include "clases/sqlite3.php";

$DATABASE = '../databases/teal.db';
$db = new MyDB($DATABASE);

// Assume the database has been initialized and the remember_tokens table exists.

$data = json_decode(file_get_contents('php://input'), true);
$token = $data['token'] ?? '';

if ($token) {
    $stmt = $db->prepare("SELECT user_id, expires_at FROM remember_tokens WHERE token = ?");
    $stmt->bindValue(1, $token, SQLITE3_TEXT);
    $row = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
    if ($row && strtotime($row['expires_at']) > time()) {
        // Token is valid; fetch the company record.
        $stComp = $db->prepare("SELECT id, company_name, company_color FROM company WHERE id=?");
        $stComp->bindValue(1, $row['user_id'], SQLITE3_INTEGER);
        $comp = $stComp->execute()->fetchArray(SQLITE3_ASSOC);
        if ($comp) {
            $_SESSION['user_id'] = $comp['id'];
            $_SESSION['company_name'] = $comp['company_name'];
            $_SESSION['company_color'] = $comp['company_color'];
            $_SESSION['role'] = 'admin';
            echo json_encode(['success' => true]);
            exit;
        }
    }
}
echo json_encode(['success' => false]);
exit;
?>


```
**index.php**
```php
<?php
session_start();
include "inc/log.php";
include "inc/errores.php";

$DATABASE = '../databases/teal.db';

include "clases/sqlite3.php";

// --- NEW PARAMS ---
$USE_NESTED_TABLES = false;
$NESTED_TABLES_HORIZONTAL = false;
$first_column_only = false;

include "funciones/construirCadenaRutaCarpeta.php";
include "funciones/migasDePan.php";
include "funciones/entrecomillar.php";
include "funciones/funcionesCodificacion.php";
include "funciones/inicializarDB.php";
include "funciones/logOperaciones.php";
include "funciones/construirTabla.php";
include "funciones/devolverNombreTabla.php";
include "funciones/devolverTablaAplicacion.php";
include "funciones/funciones.php";

// Create/open database and initialize if needed
if (!file_exists($DATABASE)) {
    $db = new MyDB($DATABASE);
    init_db($db);
} else {
    $db = new MyDB($DATABASE);
    init_db($db);
}
$db->exec("PRAGMA foreign_keys = ON;");

$logged_in = isset($_SESSION['user_id']);

// Build $foreignAppOptions + $allTablesJson.
$foreignAppOptions = '';
$allTablesJson = '{}';

include "inc/comprobarLogin.php";
include "inc/manejadorPost.php";
include "inc/informe.php";
include "inc/busqueda.php";

$route = $_GET['route'] ?? null;
$css_colors = ["Teal","Red","Blue","Green","Orange","Purple","Brown","Pink","Yellow","Gray"];
$user_color = ($logged_in && isset($_SESSION['company_color'])) ? $_SESSION['company_color'] : 'Teal';

/**
 * NEW: manual SMTP send function (using fsockopen and SSL).
 */
 
include "funciones/enviarmailsmtp.php";

include "rutas/enviarmail.php";

// --------------------- End API endpoints ---------------------


// The rest of the code outputs the full HTML page
include "bloques/cabeza.php";
?>
<body>
<?php
if ($logged_in && $route==='table' && isset($_GET['table_name']) && isset($_GET['app_id'])) {
    include "rutas/tabla.php";

    ?>
    <header>
        <?php include "bloques/cabeceratabla.php";?>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings" style="margin-left:10px; font-size:18px; text-decoration:none;">&#9881;</a>
    </header>
    <main>
        <nav>
            <?php include "bloques/navegaciontabla.php";?>
        </nav>
        <section class="dashboard">
            <?php include "bloques/tabla.php"; ?>
            <?php include "bloques/paginador.php"; ?>
            <?php if ($editing): ?>
                <h3>Editando el ID <?= (int)$edit_id ?></h3>
            <?php else: ?>
                <h3 style="display:none;" id="formtitle">Añadir registro</h3>
            <?php endif; ?>
            <?php include "bloques/formulario.php"; ?>
            <div id="nuevo" <?php if($editing){ echo 'style="display:none;"';}?> >+</div>
        </section>
    </main>
    <link rel="stylesheet" href="https://jocarsa.github.io/jocarsa-lightslateblue/jocarsa%20%7C%20lightslateblue.css">
    <script src="https://jocarsa.github.io/jocarsa-lightslateblue/jocarsa%20%7C%20lightslateblue.js"></script>
    <form method="post" id="rename-folder-form" style="display:none;">
        <input type="hidden" name="action" value="rename_folder">
        <input type="hidden" name="app_id" value="<?php echo (int)$app_id; ?>">
        <input type="hidden" name="folder_id" value="">
        <input type="hidden" name="new_folder_name" value="">
    </form>
    
    <?php
}
elseif ($logged_in && $route==='app' && isset($_GET['app_id'])) {
   
   include "rutas/aplicacion.php";
   ?>

    <?php include "js/camposdinamicoscreartabla.php"; ?>
<?php }
elseif ($logged_in && $route==='manage_users' && isset($_SESSION['role']) && $_SESSION['role']==='admin') {
     include "rutas/gestionarusuarios.php";
}
elseif ($logged_in && $route==='create_user') {
    include "rutas/crearusuarios.php";
}
elseif ($logged_in && $route==='company_settings') {
    include "rutas/parametroscompania.php";
}
elseif ($logged_in && $route==='sent_emails') {
    include "rutas/mailsenviados.php";
}
/**
 * NEW: route=sent_whatsapp: listing all records from sent_whatsapp
 */
elseif ($logged_in && $route === 'sent_whatsapp') {
    include "rutas/whatsappsenviados.php";
    exit;
}
elseif ($logged_in) {
    $apps = [];
    $st = $db->prepare("SELECT id, application_name FROM company_applications WHERE company_id=?");
    $st->bindValue(1, $_SESSION['user_id'], SQLITE3_INTEGER);
    $rs = $st->execute();
    while($a=$rs->fetchArray(SQLITE3_ASSOC)) {
        $apps[] = $a;
    }
    ?>
    <header>
        <h1 class="corporativo"><img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal</h1>
        <?php
        $crumbHTML = build_breadcrumbs($db, '', null);
        ?>
        <h1 id="nombretabla"><?= $crumbHTML ?></h1>
        <form method="get" style="margin-left:auto;">
            <input type="hidden" name="route" value="search">
            <input type="search" name="q" placeholder="Buscar en todas las tablas...">
            <button type="submit">Global</button>
        </form>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings" style="margin-left:10px; font-size:18px; text-decoration:none;">&#9881;</a>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=logout' ?>"><span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span></a>
    </header>
    <main>
        <nav>
            <h2>Aplicaciones</h2>
            <button id="create-application-btn">Crear Nueva Aplicación</button>
            <a href="<?= $_SERVER['PHP_SELF'] ?>?route=sent_emails"><button>Ver Emails Enviados</button></a>
            <a href="<?= $_SERVER['PHP_SELF'] ?>?route=sent_whatsapp">
            <button>Ver WhatsApp Enviados</button>
        </a>
        </nav>
        <?php include "bloques/listadoaplicaciones.php"; ?>
    </main>
    <script>
    const btnApp = document.getElementById("create-application-btn");
    const formApp= document.getElementById("create-application-form");
    if (btnApp && formApp) {
        btnApp.addEventListener("click", () => {
            formApp.style.display = (formApp.style.display==="none") ? "block" : "none";
        });
    }
    </script>
    <?php
}
else {
    include "bloques/login.php";
}

$db->close();
?>
<script>
document.addEventListener('DOMContentLoaded', function(){
    <?php if(!$logged_in): ?>
    const token = localStorage.getItem('remember_token');
    if (token) {
        fetch('auto_login.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: token })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                localStorage.removeItem('remember_token');
            }
        })
        .catch(err => console.error('Auto login error:', err));
    }
    <?php endif; ?>
});
</script>
<link rel="stylesheet" href="https://jocarsa.github.io/jocarsa-seashell/jocarsa%20%7C%20seashell2.css">
<script src="https://jocarsa.github.io/jocarsa-seashell/jocarsa%20%7C%20seashell2.js"></script>
<script src="https://jocarsa.github.io/jocarsa-silver/jocarsa-silver.js"></script>
<link rel="stylesheet" href="https://jocarsa.github.io/jocarsa-white/jocarsawhite.css">
</body>
</html>


```
**landing.html**
```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>jocarsa | teal - Software Dinámico de Gestión de Aplicaciones</title>
  <!-- Se puede utilizar la hoja de estilos estática del proyecto -->
  <link rel="stylesheet" href="static/styles.css">
  <style>
    /* Estilos personalizados para jocarsa | teal */
    body {
      font-family: 'Ubuntu', sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    header {
      background: teal;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    header img {
      width: 70px;
      vertical-align: middle;
    }
    header h1 {
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
      font-size: 2rem;
    }
    /* MENÚ: ahora se fija en la parte superior para mejorar la navegación */
    nav {
      background: #006666;
      padding: 10px 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    nav a {
      color: #fff;
      margin: 0 15px;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.3s;
    }
    nav a:hover {
      color: #b2d8d8;
    }
    /* Sección Hero */
    .hero {
      background: url('static/logo.svg') no-repeat center center/cover;
      padding: 100px 20px 60px; /* Se ajusta el padding inferior para compensar la altura del menú */
      color: #fff;
      text-align: center;
      position: relative;
    }
    .hero::after {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 0;
    }
    .hero-content {
      position: relative;
      z-index: 1;
    }
    .hero-content h2 {
      font-size: 2.8em;
      margin-bottom: 20px;
    }
    .hero-content p {
      font-size: 1.2em;
      max-width: 800px;
      margin: 0 auto 20px;
    }
    .cta {
      display: inline-block;
      background: #20B2AA;
      color: #fff;
      padding: 15px 30px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 1.2em;
      transition: background 0.3s;
    }
    .cta:hover {
      background: #008080;
    }
    /* Secciones generales */
    .section {
      padding: 60px 20px;
    }
    .section h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2em;
    }
    .info-section {
      max-width: 1000px;
      margin: auto;
    }
    .features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .feature {
      background: #fff;
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 4px;
      width: 300px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .feature h3 {
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    .feature p {
      font-size: 0.95em;
    }
    .beneficios ul {
      list-style: none;
      padding: 0;
      font-size: 1.1em;
    }
    .beneficios li {
      margin-bottom: 15px;
    }
    .beneficios li strong {
      color: teal;
    }
    /* Sección Demo */
    .demo-video {
      display: block;
      width: 100%;
      max-width: 800px;
      height: 450px;
      margin: 20px auto;
      border: none;
    }
    /* Sección de Contacto */
    .contact-form {
      max-width: 600px;
      margin: auto;
    }
    .contact-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .contact-form input, .contact-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .contact-form button {
      background: #20B2AA;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 1em;
      transition: background 0.3s;
    }
    .contact-form button:hover {
      background: #008080;
    }
    footer {
      background: teal;
      color: #fff;
      text-align: center;
      padding: 20px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <img src="static/logoinvertido.svg" alt="Logo jocarsa | teal">
    <h1>jocarsa | teal</h1>
  </header>
  <nav>
    <a href="#inicio">Inicio</a>
    <a href="#caracteristicas">Características</a>
    <a href="#beneficios">Beneficios</a>
    <a href="#demo">Demo</a>
    <a href="#contacto">Contacto</a>
  </nav>
  <!-- Sección Hero -->
  <section id="inicio" class="hero">
    <div class="hero-content">
      <h2>Gestiona tus Aplicaciones de Datos de Forma Dinámica</h2>
      <p>Con jocarsa | teal, crea y administra tablas, carpetas y aplicaciones empresariales de forma intuitiva. Desde la definición de esquemas personalizados hasta reportes interactivos, controla y organiza tus datos en un solo lugar.</p>
      <a href="index.php?route=login" class="cta">Accede Ahora</a>
    </div>
  </section>
  <!-- Sección de Características -->
  <section id="caracteristicas" class="section">
    <div class="info-section">
      <h2>Características Destacadas</h2>
      <div class="features">
        <div class="feature">
          <h3>Creación Dinámica de Tablas y Carpetas</h3>
          <p>Define esquemas personalizados y organiza tus datos en carpetas de forma visual, facilitando la gestión y consulta.</p>
        </div>
        <div class="feature">
          <h3>Gestión de Aplicaciones Empresariales</h3>
          <p>Crea múltiples aplicaciones para tu empresa y administra cada una con su propio conjunto de tablas y registros.</p>
        </div>
        <div class="feature">
          <h3>Interfaz Intuitiva y Flexible</h3>
          <p>Navega de forma sencilla por menús, paneles y breadcrumbs que te permiten acceder a cualquier registro o reporte al instante.</p>
        </div>
        <div class="feature">
          <h3>Reportes y Análisis en Tiempo Real</h3>
          <p>Genera informes interactivos y visualiza datos consolidados a través de gráficos y tablas dinámicas para tomar decisiones informadas.</p>
        </div>
        <div class="feature">
          <h3>Seguridad y Control de Usuarios</h3>
          <p>Administra el acceso mediante roles (admin y user) y protege tu información con un sistema de autenticación robusto.</p>
        </div>
        <div class="feature">
          <h3>Soporte para Múltiples Tipos de Datos</h3>
          <p>Desde texto y números hasta archivos, colores y campos múltiples, adapta cada tabla a las necesidades específicas de tu negocio.</p>
        </div>
      </div>
    </div>
  </section>
  <!-- Sección de Beneficios -->
  <section id="beneficios" class="section" style="background: #e9ecef;">
    <div class="info-section beneficios">
      <h2>Beneficios y Ventajas</h2>
      <ul>
        <li><strong>Eficiencia Operativa:</strong> Automatiza la gestión de datos y reduce la carga administrativa con herramientas intuitivas.</li>
        <li><strong>Flexibilidad Total:</strong> Personaliza cada aplicación, tabla y campo para adaptarlo a las necesidades específicas de tu empresa.</li>
        <li><strong>Visibilidad Completa:</strong> Accede a reportes y análisis en tiempo real para monitorizar el rendimiento de tu negocio.</li>
        <li><strong>Organización y Control:</strong> Utiliza carpetas y menús dinámicos que facilitan la navegación y la búsqueda de información.</li>
        <li><strong>Seguridad y Escalabilidad:</strong> Gestiona usuarios y roles de forma segura, garantizando el crecimiento y la confidencialidad de tus datos.</li>
      </ul>
    </div>
  </section>
  <!-- Sección Demo -->
  <section id="demo" class="section" style="background: #f0f2f5;">
    <div class="info-section">
      <h2>Demostración del Software</h2>
      <p>Descubre cómo jocarsa | teal transforma la gestión de tus datos empresariales. Observa en acción la creación dinámica de tablas, la organización en carpetas y la generación de reportes interactivos.</p>
      <!-- Video demo incrustado de YouTube -->
      <iframe class="demo-video" src="https://www.youtube.com/embed/VEu8hz-vdYs" title="Demo jocarsa | teal" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      <p style="text-align:center; font-size:1.1em;">Explora la demo interactiva y experimenta el poder de una gestión de datos completamente dinámica.</p>
    </div>
  </section>
  <!-- Sección de Contacto -->
  <section id="contacto" class="section">
    <div class="info-section">
      <h2>Contacto</h2>
      <p>¿Tienes preguntas o deseas obtener más información sobre jocarsa | teal? Nuestro equipo está listo para ayudarte a transformar la gestión de datos en tu empresa.</p>
      <form class="contact-form" action="mailto:soporte@jocarsa.com" method="post" enctype="text/plain">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" name="nombre" required>
        <label for="email">Correo Electrónico:</label>
        <input type="email" id="email" name="email" required>
        <label for="mensaje">Mensaje:</label>
        <textarea id="mensaje" name="mensaje" rows="5" required></textarea>
        <div style="text-align:center;">
          <button type="submit">Enviar Mensaje</button>
        </div>
      </form>
    </div>
  </section>
  <footer>
    <p>&copy; 2025 jocarsa | teal. Todos los derechos reservados.</p>
    <p>Contacto: soporte@jocarsa.com</p>
  </footer>
</body>
</html>


```
**update_field.php**
```php
<?php
session_start();
header('Content-Type: application/json');

$DATABASE = '../databases/teal.db';
$db = new SQLite3($DATABASE);

function get_prefixed_tablename($db, $table_id) {
    $stmt = $db->prepare("
        SELECT t.table_name, t.application_id, a.company_id
        FROM company_tables t
        JOIN company_applications a ON t.application_id = a.id
        WHERE t.id = :tid
    ");
    $stmt->bindValue(':tid', $table_id, SQLITE3_INTEGER);
    $row = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$row) return null;

    $uid         = $row['company_id'];
    $app_id      = $row['application_id'];
    $logicalName = $row['table_name'];
    $safeName    = preg_replace('/[^A-Za-z0-9_]/', '_', $logicalName);

    return "u{$uid}_a{$app_id}_{$safeName}";
}
function log_operation($db, $user_id, $operation_type, $operation_details) {
    $stm = $db->prepare("INSERT INTO operation_log (user_id, operation_type, operation_details) VALUES (?, ?, ?)");
    $stm->bindValue(1, $user_id, SQLITE3_INTEGER);
    $stm->bindValue(2, $operation_type, SQLITE3_TEXT);
    $stm->bindValue(3, $operation_details, SQLITE3_TEXT);
    $stm->execute();
}

// Include the file that contains the get_prefixed_tablename function
//include 'index.php'; // Replace with the actual path to your main script

$data = json_decode(file_get_contents('php://input'), true);
$fieldId = $data['fieldId'] ?? null;
$columnName = $data['columnName'] ?? null;
$newContent = $data['newContent'] ?? null;
$tableName = $data['tableName'] ?? null;
$appId = $data['appId'] ?? null;

error_log("Received data: " . json_encode($data));

if ($fieldId && $columnName && $newContent && $tableName && $appId) {
    // Get the actual table name using the table_id
    $stmt = $db->prepare("SELECT id FROM company_tables WHERE application_id = ? AND table_name = ?");
    $stmt->bindValue(1, $appId, SQLITE3_INTEGER);
    $stmt->bindValue(2, $tableName, SQLITE3_TEXT);
    $result = $stmt->execute();
    $tableRow = $result->fetchArray(SQLITE3_ASSOC);

    if ($tableRow) {
        $tableId = $tableRow['id'];
        $actualTableName = get_prefixed_tablename($db, $tableId);

        if ($actualTableName) {
            $stmt = $db->prepare("UPDATE $actualTableName SET $columnName = ? WHERE id = ?");
            $stmt->bindValue(1, $newContent, SQLITE3_TEXT);
            $stmt->bindValue(2, $fieldId, SQLITE3_INTEGER);
            $result = $stmt->execute();

            if ($result) {
                log_operation($db, $_SESSION['user_id'], 'update_field', "Updated field $columnName in table $actualTableName with new content: $newContent");
                echo json_encode(['success' => true]);
            } else {
                error_log("Failed to execute query: " . $db->lastErrorMsg());
                echo json_encode(['success' => false, 'error' => 'Failed to update field']);
            }
        } else {
            error_log("Failed to get actual table name");
            echo json_encode(['success' => false, 'error' => 'Failed to get actual table name']);
        }
    } else {
        error_log("Table not found");
        echo json_encode(['success' => false, 'error' => 'Table not found']);
    }
} else {
    error_log("Invalid data received");
    echo json_encode(['success' => false, 'error' => 'Invalid data']);
}
?>


```
## bloques
**cabeceraaplicacion.php**
```php
<h1 class="corporativo"><img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal</h1>
        <?php
        $crumbHTML = build_breadcrumbs($db, 'app', $app_id);
        ?>
        <h1 id="nombretabla"><?= $crumbHTML ?></h1>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=logout' ?>"><span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span></a>

```
**cabeceratabla.php**
```php
<h1 class="corporativo"><img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal</h1>
        <?php
        $crumbHTML = build_breadcrumbs($db, 'table', $app_id, $table_id);
        ?>
        <h1 id="nombretabla"><?= $crumbHTML ?></h1>
        <form method="get">
            <input type="hidden" name="route" value="table">
            <input type="hidden" name="app_id" value="<?= (int)$app_id ?>">
            <input type="hidden" name="table_name" value="<?= htmlspecialchars($table_name) ?>">
            <input type="search" name="search" placeholder="Buscar en esta tabla..." value="<?= htmlspecialchars($searchTerm) ?>">
            <button type="submit">Buscar</button>
        </form>
        <form method="get" style="margin-left:10px;">
            <input type="hidden" name="route" value="search">
            <input type="search" name="q" placeholder="Buscar en todas las tablas...">
            <button type="submit">Global</button>
        </form>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=logout' ?>"><span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span></a>

```
**cabeza.php**
```php
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jocarsa | teal</title>
    <link rel="icon" href="https://static.jocarsa.com/logos/teal.png" type="image/svg+xml">
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://jocarsa.github.io/jocarsawhite/jocarsawhite.css">
    <link rel="stylesheet" href="https://jocarsa.github.io/jocarsa-silver/jocarsa-silver.css" />
    <style>
      :root { --main-color: <?php echo htmlspecialchars($user_color); ?>; }
      @media print {
         nav {
          display: none !important;
        }
        main {
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
        }
        body {
          background: #fff !important;
        }
      }
    </style>
    <!-- NEW: Define global baseUrl variable from PHP -->
    <script>
      var baseUrl = "<?php echo $_SERVER['PHP_SELF']; ?>";
    </script>
    <script src="js/edit_fields.js" defer></script>
<?php if ($logged_in): ?>
<script>
function renameFolder(folderId, currentName) {
  const newName = prompt("Nuevo nombre de carpeta:", currentName);
  if (newName && newName.trim().length > 0) {
    const form = document.getElementById("rename-folder-form");
    form.folder_id.value = folderId;
    form.new_folder_name.value = newName;
    form.submit();
  }
}
</script>
<?php endif; ?>
</head>

<body>


```
**crearcarpeta.php**
```php
<div id="create-folder-form" style="display:none; margin-top:20px;">
                <h3>Crea una nueva carpeta</h3>
                <form method="post">
                    <input type="hidden" name="action" value="create_folder">
                    <input type="hidden" name="app_id" value="<?= (int)$app_id ?>">
                    <label>Carpeta padre (opcional)</label>
                    <select name="parent_folder_id">
                        <option value="0">(Raíz)</option>
                        <?php
                        $allF = $db->prepare("SELECT id, folder_name FROM company_folders WHERE application_id=? ORDER BY folder_name");
                        $allF->bindValue(1, $app_id, SQLITE3_INTEGER);
                        $fres = $allF->execute();
                        while($fd=$fres->fetchArray(SQLITE3_ASSOC)) {
                            echo '<option value="'.$fd['id'].'">'.htmlspecialchars($fd['folder_name']).'</option>';
                        }
                        ?>
                    </select><br><br>
                    <input type="text" name="folder_name" placeholder="Nombre de la carpeta" required>
                    <button type="submit">Crear carpeta</button>
                </form>
            </div>

```
**definirtabla.php**
```php
<div id="create-table-form" style="display:none; margin-top:20px;">
                <h3>Crea una nueva tabla</h3>
                <form method="post" action="<?= $_SERVER['PHP_SELF'] ?>">
                    <input type="hidden" name="application_id" value="<?= (int)$app_id ?>">
                    <label>Carpeta padre (opcional)</label>
                    <select name="folder_id">
                        <option value="0">(Raíz)</option>
                        <?php
                        $allF = $db->prepare("SELECT id, folder_name FROM company_folders WHERE application_id=? ORDER BY folder_name");
                        $allF->bindValue(1, $app_id, SQLITE3_INTEGER);
                        $fres = $allF->execute();
                        while($fd=$fres->fetchArray(SQLITE3_ASSOC)) {
                            echo '<option value="'.$fd['id'].'">'.htmlspecialchars($fd['folder_name']).'</option>';
                        }
                        ?>
                    </select><br><br>
                    <input type="text" name="table_name" placeholder="Nombre de la tabla" required>
                    <h4>Definir columnas</h4>
                    <div class="columns-container" id="columns-container">
                        <div class="column-group">
                            <label>Nombre de columna</label>
                            <input type="text" name="columns[]" placeholder="columna" required>

                            <label>Tipo de dato</label>
                            <select name="data_types[]" required>
                                <option value="TEXT">TEXT</option>
                                <option value="INTEGER">INTEGER</option>
                                <option value="REAL">REAL</option>
                                <option value="COLOR">COLOR</option>
                            </select>

                            <label>Tipo de input</label>
                            <select name="input_types[]" required>
                                <option value="text">Text</option>
                                <option value="number">Number</option>
                                <option value="color">Color</option>
                                <option value="textarea">Textarea</option>
                                <option value="checkbox">Checkbox</option>
                                <option value="date">Date</option>
                                <option value="email">Email</option>
                                <option value="file">File</option>
                                <option value="password">Password</option>
                                <option value="radio">Radio</option>
                                <option value="range">Range</option>
                                <option value="tel">Tel</option>
                                <option value="time">Time</option>
                                <option value="url">URL</option>
                                <option value="week">Week</option>
                            </select>

                            <input type="hidden" name="is_foreign[]" value="0" class="is-foreign-hidden">
                            <label>¿Es llave foránea?</label>
                            <input type="checkbox" class="is-foreign-checkbox" style="transform:scale(1.3); margin-bottom:8px;">

                            <div class="foreign-opts" style="display:none; margin-bottom:8px;">
                                <label>Tabla destino:</label>
                                <select name="foreign_target[]">
                                    <option value="" value="-">--Seleccione--</option>
                                    <?php
                                    foreach($allUserTables as $tinfo) {
                                        $appId  = $tinfo['app_id'];
                                        $tbl    = $tinfo['table_name'];
                                        $label  = $tinfo['app_name'];
                                        if ($tinfo['folder_path'] !== '') {
                                            $label .= ' - '.$tinfo['folder_path'];
                                        }
                                        $label .= ' - '.$tbl;
                                        $val = $appId.'__'.$tbl;
                                        echo '<option value="'.htmlspecialchars($val).'">'
                                             .htmlspecialchars($label).'</option>';
                                    }
                                    ?>
                                </select>
                            </div>

                            <input type="hidden" name="is_multiple[]" value="0" class="is-multiple-hidden">
                            <label>¿Multiple?</label>
                            <input type="checkbox" class="is-multiple-checkbox" style="transform:scale(1.3);">
                        </div>
                    </div>
                    <button type="button" id="add-column-btn">Agregar columna</button><br><br>
                    <button type="submit">Crear Tabla</button>
                </form>
            </div>

```
**formulario.php**
```php
<form method="post"
      enctype="multipart/form-data"
      action="<?= $_SERVER['PHP_SELF'].'?route=table&table_name='.urlencode($table_name)
               .'&app_id='.$app_id
               .'&sort_col='.urlencode($sort_col)
               .'&sort_dir='.urlencode($sort_dir)
               .'&page='.$page
               .'&search='.urlencode($searchTerm) ?>"
      <?php if(!isset($_GET['edit_id'])){ echo 'style="display:none;"'; } ?> id="formulariocrear">

    <h3><?= $editing ? 'Actualizar registro' : '' ?></h3>
    <fieldset class="conjuntocampos">
        <input type="hidden" name="action" value="<?= $editing ? 'update' : 'insert' ?>">
        <?php if ($editing): ?>
            <input type="hidden" name="row_id" value="<?= (int)$edit_id ?>">
        <?php endif; ?>

        <?php
            foreach ($colDefs as $cd) {
                $cName      = $cd['column_name'];
                if ($cName === 'id') continue;
                $isMult     = (int)$cd['is_multiple'];
                $isForeign  = (int)$cd['is_foreign'];
                $fAppId     = (int)$cd['foreign_app_id'];
                $fTblName   = $cd['foreign_table_name'];
                $dtype      = strtoupper($cd['data_type']);
                $inputType  = $cd['input_type'];

                $existingVal = '';
                if ($editing && isset($editData[$cName])) {
                    $existingVal = $editData[$cName];
                }
                $encodedCName = encode_col_name($cName);

                echo '<div class="controlformulario">';
                echo '<label>' . htmlspecialchars($cName) . '</label>';

                if ($isMult === 1) {
                    $currentArr = [];
                    if ($editing && $existingVal !== '') {
                        $decoded = json_decode($existingVal, true);
                        if (is_array($decoded)) {
                            $currentArr = $decoded;
                        }
                    }
                    if ($isForeign === 1 && $fAppId && $fTblName) {
                        echo '<div class="multiple-foreign-wrapper" data-col="' . htmlspecialchars($cName) . '">
                                <div class="multi-items-' . htmlspecialchars($cName) . '">';
                        if (count($currentArr) > 0) {
                            foreach ($currentArr as $oneVal) {
                                echo build_foreign_select($db, $fAppId, $fTblName, $encodedCName, true, $oneVal);
                            }
                        } else {
                            echo build_foreign_select($db, $fAppId, $fTblName, $encodedCName, true, '');
                        }
                        echo '</div>
                              <button type="button" class="add-more-foreign" data-col="' . htmlspecialchars($cName) . '">
                                Agregar otro
                              </button>
                              </div><br>';
                    } else {
                        echo '<div class="multiple-text-wrapper" data-col="' . htmlspecialchars($cName) . '">
                                <div class="multi-text-' . htmlspecialchars($cName) . '">';
                        if (count($currentArr) > 0) {
                            foreach ($currentArr as $oneTextVal) {
                                echo '<input type="text" name="multi_' . $encodedCName . '[]" value="' . htmlspecialchars($oneTextVal) . '">';
                            }
                        } else {
                            echo '<input type="text" name="multi_' . $encodedCName . '[]" value="">';
                        }
                        echo '</div>
                              <button type="button" class="add-more-text" data-col="' . htmlspecialchars($cName) . '">
                                Agregar otro
                              </button>
                              </div><br>';
                    }
                }
                else {
                    if ($isForeign === 1 && $fAppId && $fTblName) {
                        echo build_foreign_select($db, $fAppId, $fTblName, $encodedCName, false, $existingVal) . "<br>";
                    }
                    else if ($dtype === 'COLOR') {
                        echo '<select name="val_' . $encodedCName . '" value="' . htmlspecialchars($existingVal ?: '#ffffff') . '">';
                        include "inc/css3colors.php";
                        opcionesCss3($existingVal);
                        echo '</select>';
                    }
                    else if ($inputType === 'file') {
                        $encoded = encode_col_name($cName);
                        echo '<input type="file" name="val_' . $encoded . '"><br>';
                        if ($editing && !empty($existingVal)) {
                            echo '<input type="hidden" name="old_val_' . $encoded . '" value="' . htmlspecialchars($existingVal) . '">';
                            echo '<small>Archivo actual: <a href="' . htmlspecialchars($existingVal) . '" target="_blank">' . basename($existingVal) . '</a></small><br>';
                        }
                    }
                    else if ($inputType === 'textarea') {
                        echo '<textarea name="val_' . $encodedCName . '" rows="4" cols="50">' . htmlspecialchars($existingVal) . '</textarea><br>';
                    }
                    else if ($inputType === 'tel') {
                        // Telephone input with European format validation.
                        echo '<input type="tel" name="val_' . $encodedCName . '" value="' . htmlspecialchars($existingVal) . '" pattern="^(?:(?:\+|00)\d{1,3}\s?)?(?:\d[\s.-]?){6,14}\d$" title="Por favor ingrese un número de teléfono válido (ej. +34 600 123 456)"><br>';
                    }
                    else {
                        echo '<input type="' . $inputType . '" name="val_' . $encodedCName . '" value="' . htmlspecialchars($existingVal) . '"><br>';
                    }
                }
                echo '</div>';
            }
        ?>
        <button type="submit"><?= $editing ? 'Actualizar' : 'Insertar' ?></button>
    </fieldset>
</form>


```
**listadoaplicaciones.php**
```php
<section class="dashboard">
            <h2>Tus Aplicaciones</h2>
            <div style="display:flex; flex-wrap:wrap; gap:20px;">
            <?php foreach ($apps as $ap): ?>
                <div style="border:1px solid #ccc; border-radius:6px; padding:20px; background:#fafafa; width:200px; text-align:center;" class="aplicacion">
                    <h3><?= htmlspecialchars($ap['application_name'])[0] ?></h3>
                    <a href="<?= $_SERVER['PHP_SELF'].'?route=app&app_id='.$ap['id'] ?>">
                        <button><?= htmlspecialchars($ap['application_name']) ?></button>
                    </a>
                </div>
            <?php endforeach; ?>
            </div>
            <div id="create-application-form" style="display:none; margin-top:20px;">
                <h3>Crea una nueva aplicación</h3>
                <form method="post">
                    <input type="text" name="application_name" placeholder="Nombre de la Aplicación" required>
                    <button type="submit" name="action" value="create_application">Crear</button>
                </form>
            </div>
        </section>

```
**login.php**
```php
<?php
    $css_colors = ["Teal","Red","Blue","Green","Orange","Purple","Brown","Pink","Yellow","Gray"];
?>
<div class="formularios">
    <img src="https://static.jocarsa.com/logos/teal.png">
    <h1>jocarsa | Teal</h1>

    <div class="form-container" id="registrate">
        <h2>Regístrate</h2>
        <form method="post">
            <input type="email" name="signup_email" placeholder="Email" required>
            <input type="password" name="signup_password" placeholder="Contraseña" required>
            <input type="text" name="signup_company_name" placeholder="Nombre de la empresa" required>
            <label for="signup_company_color">Elige el color corporativo:</label>
            <select name="signup_company_color" id="signup_company_color" required>
                <?php
                foreach ($css_colors as $c) {
                    echo '<option value="'.htmlspecialchars($c).'">&#x25A0; '.htmlspecialchars($c).'</option>';
                }
                ?>
            </select>
            <button type="submit">Regístrate</button>
        </form>
    </div>
    <div class="form-container">
        <h2>Inicia sesión</h2>
        <form method="post">
            <input type="email" name="login_email" placeholder="Email" required>
            <input type="password" name="login_password" placeholder="Contraseña" required>
            <!-- Add the "Remember me" checkbox -->
            <label>
                <input type="checkbox" name="remember_me" value="1"> Recordarme
            </label>
            <button type="submit">Inicia sesión</button>
        </form>
    </div>
</div>
<?php
?>


```
**navegacionaplicacion.php**
```php
<div class="texto">
    <h2><?= htmlspecialchars($appRow['application_name']) ?></h2>
    <?php render_folder_tree($folderTree, $app_id); ?>
</div>
<?php 
    // Determine admin status
    $isAdmin = (isset($_SESSION['role']) && $_SESSION['role'] === 'admin'); 
?>
<div class="botonesacciones">
    <!-- Always show these creation buttons -->
    <button id="show-create-table-form">Crear nueva tabla (root)</button>
    <button id="show-create-folder-form">Crear carpeta (root)</button>
    <!-- Admin-only options for user management -->
    <?php if ($isAdmin): ?>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=create_user' ?>">
            <button>Crear Usuario</button>
        </a>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=manage_users">
            <button>Gestionar Usuarios</button>
        </a>
         <!-- NEW: link to see the "Sent Emails" list -->
    <a href="<?= $_SERVER['PHP_SELF'] ?>?route=sent_emails">
        <button>Ver Emails Enviados</button>
    </a>
    <?php endif; ?>
</div>
<?php include "js/creartabla.php"; ?>


```
**navegaciontabla.php**
```php
<?php
// File: /var/www/html/jocarsa-teal/bloques/navegaciontabla.php
?>
<div class="jerarquia">
    <h2><?= htmlspecialchars($appRow['application_name']) ?></h2>
    <?php render_folder_tree($folderTree, $app_id); ?>
</div>
<?php 
    // Determine if the logged-in user is an admin (this is still used later for user-management links)
    $isAdmin = (isset($_SESSION['role']) && $_SESSION['role'] === 'admin'); 
?>
<div class="botonesacciones">
    <!-- These two buttons are now always shown for all users -->
    <button id="show-create-table-form">Crear nueva tabla (root)</button>
    <button id="show-create-folder-form">Crear carpeta (root)</button>
    <!-- Only show these links if the user is admin -->
    <?php if ($isAdmin): ?>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=create_user' ?>">
            <button>Crear Usuario</button>
        </a>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=manage_users">
            <button>Gestionar Usuarios</button>
        </a>
        <!-- Existing link for sent emails -->
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=sent_emails">
            <button>Ver Emails Enviados</button>
        </a>
        <!-- NEW: link to see the "Sent WhatsApp" list -->
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=sent_whatsapp">
            <button>Ver WhatsApp Enviados</button>
        </a>
    <?php endif; ?> 
</div>
<?php include "js/creartabla.php"; ?>


```
**paginador.php**
```php
<div style="margin:10px 0;" <?php if(isset($_GET['edit_id'])){ echo 'style="display:none !important;"';}?>>
                <?php if ($page>1): ?>
                    <a href="<?= $_SERVER['PHP_SELF'].'?route=table&table_name='.urlencode($table_name)
                            .'&app_id='.$app_id
                            .'&sort_col='.urlencode($sort_col)
                            .'&sort_dir='.urlencode($sort_dir)
                            .'&search='.urlencode($searchTerm)
                            .'&page='.($page-1) ?>"
                       style="margin-right:10px;">&laquo; Anterior</a>
                <?php endif; ?>
                Página <?= $page ?> de <?= $totalPages ?: 1 ?>
                <?php if ($page<$totalPages): ?>
                    <a href="<?= $_SERVER['PHP_SELF'].'?route=table&table_name='.urlencode($table_name)
                            .'&app_id='.$app_id
                            .'&sort_col='.urlencode($sort_col)
                            .'&sort_dir='.urlencode($sort_dir)
                            .'&search='.urlencode($searchTerm)
                            .'&page='.($page+1) ?>"
                       style="margin-left:10px;">Siguiente &raquo;</a>
                <?php endif; ?>
            </div>

```
**tabla.php**
```php
<?php
/**
 * Shows the main table of rows, handles inline editing (for text/email fields),
 * and includes modals for sending email (existing) and WhatsApp messages (new for `tel` fields).
 */
?>
<table <?php if(isset($_GET['edit_id'])){ echo 'style="display:none;"';}?> >
    <thead>
        <tr>
        <?php
        foreach ($colDefs as $cd) {
            $cName = $cd['column_name'];
            $nextDir = 'ASC';
            if ($sort_col === $cName && $sort_dir==='ASC') {
                $nextDir = 'DESC';
            }
            $sortUrl = $_SERVER['PHP_SELF'].'?route=table&table_name='.urlencode($table_name)
                      .'&app_id='.$app_id
                      .'&sort_col='.urlencode($cName)
                      .'&sort_dir='.$nextDir
                      .'&search='.urlencode($searchTerm)
                      .'&page='.$page;
            echo '<th><a href="'.$sortUrl.'" style="color:#333;text-decoration:underline;">'
                 .htmlspecialchars($cName).'</a></th>';
        }
        ?>
        <th class="acciones">Acciones</th>
        </tr>
    </thead>
    <tbody>
    <?php foreach ($rows as $rrow): ?>
        <?php
        // If there's a "COLOR" column, we use it for background
        $rowColor = '';
        foreach ($colDefs as $cdCheck) {
            if (strtoupper($cdCheck['data_type']) === 'COLOR') {
                $cNameChk = $cdCheck['column_name'];
                $colorVal = trim($rrow[$cNameChk] ?? '');
                if ($colorVal !== '') {
                    $rowColor = $colorVal;
                    break;
                }
            }
        }
        ?>
        <tr <?php if ($rowColor) { echo 'style="background:'.$rowColor.';"'; } ?>>
            <?php
            foreach ($colDefs as $cd) {
                $colName    = $cd['column_name'];
                $val        = $rrow[$colName] ?? '';
                $isMult     = (int)$cd['is_multiple'];
                $isForeign  = (int)$cd['is_foreign'];
                $fAppId     = (int)$cd['foreign_app_id'];
                $fTableName = $cd['foreign_table_name'];
                $dtype      = strtoupper($cd['data_type']);
                $inputType  = $cd['input_type'];

                // Handle foreign references
                if ($isForeign===1 && $fAppId && $fTableName) {
                    $refp = get_prefixed_tablename_by_app($db, $fAppId, $fTableName);
                    if (!$refp) {
                        echo '<td>(Tabla ref no existe)</td>';
                        continue;
                    }
                    if ($isMult===1) {
                        // multiple foreign references => store as JSON
                        $arr = json_decode($val, true);
                        if (!is_array($arr)) {
                            echo '<td>(Sin datos)</td>';
                            continue;
                        }
                        $allSubs = '';
                        foreach ($arr as $oneId) {
                            $oneId = (int)$oneId;
                            $fkst = $db->prepare("SELECT * FROM " . quote_ident($refp)." WHERE \"id\"=?");
                            $fkst->bindValue(1, $oneId, SQLITE3_INTEGER);
                            $fkrow = $fkst->execute()->fetchArray(SQLITE3_ASSOC);
                            if ($fkrow) {
                                $allSubs .= render_foreign_row_data($fkrow, $NESTED_TABLES_HORIZONTAL, $USE_NESTED_TABLES, $first_column_only);
                            } else {
                                $allSubs .= '(Sin datos)';
                            }
                            $allSubs .= "<br>";
                        }
                        echo '<td>'.$allSubs.'</td>';
                    } else {
                        // single foreign reference
                        if ($val!=='') {
                            $fkst  = $db->prepare("SELECT * FROM " . quote_ident($refp)." WHERE \"id\"=?");
                            $fkst->bindValue(1, (int)$val, SQLITE3_INTEGER);
                            $fkrow = $fkst->execute()->fetchArray(SQLITE3_ASSOC);
                            if ($fkrow) {
                                echo '<td>'.render_foreign_row_data($fkrow, $NESTED_TABLES_HORIZONTAL, $USE_NESTED_TABLES, $first_column_only).'</td>';
                            } else {
                                echo '<td>(Sin datos)</td>';
                            }
                        } else {
                            echo '<td>(Sin datos)</td>';
                        }
                    }
                }
                else {
                    // Non-foreign fields
                    if ($dtype === 'COLOR') {
                        // Display color swatch + text
                        if (trim($val) !== '') {
                            echo '<td><div style="width:20px;height:20px;display:inline-block;margin-right:5px;border:1px solid #000;background:'
                                 .htmlspecialchars($val).'"></div>'
                                 .htmlspecialchars($val).'</td>';
                        } else {
                            echo '<td>(No color)</td>';
                        }
                    }
                    else if ($isMult===1) {
                        // multiple text fields => stored as JSON
                        $arr = json_decode($val, true);
                        if (is_array($arr)) {
                            echo '<td class="editable" data-id="'.(int)$rrow['id'].'" data-column="'.$colName.'" data-table="'.$table_name.'" data-app-id="'.$app_id.'" data-type="text">'
                                 .htmlspecialchars(implode(' | ', $arr)).'</td>';
                        } else {
                            echo '<td class="editable" data-id="'.(int)$rrow['id'].'" data-column="'.$colName.'" data-table="'.$table_name.'" data-app-id="'.$app_id.'" data-type="text">'
                                 .htmlspecialchars($val).'</td>';
                        }
                    }
                    else if ($inputType === 'file' && file_exists($val)) {
                        // Show a link to the file
                        echo '<td><a href="'.$val.'" target="_blank">'.basename($val).'</a></td>';
                    }
                    else if ($inputType === 'email') {
                        // Email field => show envelope icon
                        if (trim($val) === '') {
                            echo '<td class="editable" data-id="'.(int)$rrow['id'].'" data-column="'.$colName.'" data-table="'.$table_name.'" data-app-id="'.$app_id.'" data-type="email">(Sin email)</td>';
                        } else {
                            echo '<td>'
                                 . htmlspecialchars($val)
                                 . ' <span class="email-icon" style="cursor:pointer;" data-email="'.htmlspecialchars($val).'">📧</span>'
                                 . '</td>';
                        }
                    }
                    // ============= NEW TEL LOGIC =============
                    else if ($inputType === 'tel') {
                        // Phone field => show phone icon for WhatsApp
                        if (trim($val) === '') {
                            echo '<td class="editable" data-id="'.(int)$rrow['id'].'" data-column="'.$colName.'" data-table="'.$table_name.'" data-app-id="'.$app_id.'" data-type="tel">(Sin teléfono)</td>';
                        } else {
                            echo '<td>'
                                 . htmlspecialchars($val)
                                 . ' <span class="phone-icon" style="cursor:pointer;" data-phone="'.htmlspecialchars($val).'">📱</span>'
                                 . '</td>';
                        }
                    }
                    else {
                        // default text-like field => inline-editable
                        echo '<td class="editable" data-id="'.(int)$rrow['id'].'" data-column="'.$colName.'" data-table="'.$table_name.'" data-app-id="'.$app_id.'" data-type="'.$inputType.'">'
                             .htmlspecialchars($val).'</td>';
                    }
                }
            }
            ?>
            <td class="acciones">
              <div class="contieneacciones">
                <!-- Delete row form -->
                <form method="post"
                      action="<?= $_SERVER['PHP_SELF'].'?route=table&table_name='.urlencode($table_name)
                               .'&app_id='.$app_id.'&sort_col='.urlencode($sort_col)
                               .'&sort_dir='.urlencode($sort_dir)
                               .'&page='.$page.'&search='.urlencode($searchTerm) ?>">
                    <input type="hidden" name="row_id" value="<?= (int)$rrow['id'] ?>">
                    <button type="submit" name="action" value="delete" style="background:red;" class="botoneliminar">
                        <span class="jocarsa-icon jocarsa-icon-eliminar"></span>
                    </button>
                </form>

                <!-- Edit row button -->
                <form method="get" style="display:inline-block;">
                    <input type="hidden" name="route" value="table">
                    <input type="hidden" name="table_name" value="<?= htmlspecialchars($table_name) ?>">
                    <input type="hidden" name="app_id" value="<?= $app_id ?>">
                    <input type="hidden" name="edit_id" value="<?= (int)$rrow['id'] ?>">
                    <input type="hidden" name="sort_col" value="<?= htmlspecialchars($sort_col) ?>">
                    <input type="hidden" name="sort_dir" value="<?= htmlspecialchars($sort_dir) ?>">
                    <input type="hidden" name="page" value="<?= $page ?>">
                    <input type="hidden" name="search" value="<?= htmlspecialchars($searchTerm) ?>">
                    <button type="submit" style="background:orange;" class="botoneditar">
                        <span class="jocarsa-icon jocarsa-icon-editar"></span>
                    </button>
                </form>

                <!-- (Optional) Link to a "report" or "view" page if needed -->
                <a href="<?= $_SERVER['PHP_SELF'].'?route=report&table_name='.urlencode($table_name)
                           .'&app_id='.$app_id.'&row_id='.(int)$rrow['id'] ?>"
                   style="display:inline-block; background:#ccc; color:#000; padding:2px 5px; border-radius:3px; text-decoration:none; margin-left:5px;">
                   <span class="jocarsa-icon jocarsa-icon-buscar"></span>
                </a>
              </div>
            </td>
        </tr>
    <?php endforeach; ?>
    </tbody>
</table>

<!-- Pagination / others remain above -->

<!-- ================== EMAIL MODAL ================== -->
<div id="emailModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
     background:#fff; border:2px solid #333; padding:20px; z-index:9999; width:400px; box-shadow:0 0 10px rgba(0,0,0,0.4);">
    <h3>Enviar correo</h3>
    <form id="emailForm">
        <label>Para:</label>
        <input type="text" name="to_email" id="modalToEmail" readonly>

        <label>Asunto:</label>
        <input type="text" name="subject" id="modalSubject" required>

        <label>Mensaje:</label>
        <textarea name="message" id="modalMessage" rows="5" required></textarea>

        <button type="submit">Enviar</button>
        <button type="button" id="closeModal" style="background:gray;">Cerrar</button>
    </form>
</div>

<!-- ================== PHONE (WHATSAPP) MODAL ================== -->
<div id="phoneModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
     background:#fff; border:2px solid #333; padding:20px; z-index:9999; width:400px; box-shadow:0 0 10px rgba(0,0,0,0.4);">
    <h3>Enviar WhatsApp</h3>
    <form id="phoneForm">
        <label>Teléfono:</label>
        <input type="text" name="to_phone" id="modalToPhone" readonly>

        <label>Mensaje:</label>
        <textarea name="message" id="modalPhoneMessage" rows="5" required></textarea>

        <button type="submit">Enviar</button>
        <button type="button" id="closePhoneModal" style="background:gray;">Cerrar</button>
    </form>
</div>


```
## clases
**sqlite3.php**
```php
<?php
	class MyDB extends SQLite3 {
		 function __construct($filename) {
		     $this->open($filename);
		 }
	}
?>

```
## funciones
**construirCadenaRutaCarpeta.php**
```php
<?php

	include "funciones/construirRutaCarpeta.php";
	/**
	 * Build a "folder1/folder2/..." path string from root to the given folder_id
	 */
	function build_folder_path_string($db, $folder_id) {
		 $pathArr = get_folder_path($db, $folder_id);
		 $names = array_map(function($f){ return $f['folder_name']; }, $pathArr);
		 return implode('/', $names);
	}



?>

```
**construirRutaCarpeta.php**
```php
<?php

	/**
	 * Return array of (id, folder_name) from root to this folder.
	 */
	function get_folder_path($db, $folder_id) {
		 $path = [];
		 while ($folder_id && $folder_id > 0) {
		     $stmt = $db->prepare("SELECT id, folder_name, parent_folder_id FROM company_folders WHERE id=?");
		     $stmt->bindValue(1, $folder_id, SQLITE3_INTEGER);
		     $f = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
		     if (!$f) {
		         break;
		     }
		     array_unshift($path, [
		         'id' => $f['id'],
		         'folder_name' => $f['folder_name'],
		     ]);
		     $folder_id = (int)$f['parent_folder_id'];
		 }
		 return $path;
	}


?>

```
**construirTabla.php**
```php
<?php
	
	/**
 * Build or re-build the actual SQLite table for a given table_id.
 *  Includes logic for COLOR (stored as TEXT in SQLite).
 */
function build_real_table($db, $table_id) {
    $stmt = $db->prepare("SELECT * FROM company_table_columns WHERE table_id=? ORDER BY id ASC");
    $stmt->bindValue(1, $table_id, SQLITE3_INTEGER);
    $res  = $stmt->execute();
    $coldefs = [];
    while($r = $res->fetchArray(SQLITE3_ASSOC)) {
        $coldefs[] = $r;
    }
    $prefixed = get_prefixed_tablename($db, $table_id);
    if (!$prefixed) return;
    $prefixedQuoted = quote_ident($prefixed);

    $col_sql = [quote_ident('id') . " INTEGER PRIMARY KEY AUTOINCREMENT"];
    $fk_constraints = [];

    foreach ($coldefs as $cd) {
        $cName      = $cd['column_name'];
        $cType      = $cd['data_type'];
        $isMult     = (int)$cd['is_multiple'];
        $isForeign  = (int)$cd['is_foreign'];
        $fAppId     = (int)$cd['foreign_app_id'];
        $fTableName = $cd['foreign_table_name'];

        $quotedCName = quote_ident($cName);

        if ($isMult === 1) {
            // multiple => store JSON in TEXT
            $col_sql[] = "$quotedCName TEXT";
        } else {
            if ($isForeign === 1 && $fAppId && $fTableName) {
                $col_sql[] = "$quotedCName INTEGER";
                $refP = get_prefixed_tablename_by_app($db, $fAppId, $fTableName);
                if ($refP) {
                    $fk_constraints[] = "FOREIGN KEY($quotedCName) REFERENCES " . quote_ident($refP) . "(\"id\")";
                }
            } else {
                // normal or COLOR
                if (strtoupper($cType) === 'COLOR') {
                    $col_sql[] = "$quotedCName TEXT";
                } else {
                    $col_sql[] = "$quotedCName $cType";
                }
            }
        }
    }

    $create = "CREATE TABLE IF NOT EXISTS $prefixedQuoted (" . implode(", ", $col_sql);
    if (!empty($fk_constraints)) {
        $create .= ", " . implode(", ", $fk_constraints);
    }
    $create .= ")";
    $db->exec($create);
}
	
?>

```
**devolverNombreTabla.php**
```php
<?php
	/**
 * Return the physical SQLite table name for a user–defined table.
 */
function get_prefixed_tablename($db, $table_id) {
    $stmt = $db->prepare("
        SELECT t.table_name, t.application_id, a.company_id
        FROM company_tables t
        JOIN company_applications a ON t.application_id = a.id
        WHERE t.id = :tid
    ");
    $stmt->bindValue(':tid', $table_id, SQLITE3_INTEGER);
    $row = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$row) return null;

    $uid         = $row['company_id'];
    $app_id      = $row['application_id'];
    $logicalName = $row['table_name'];
    $safeName    = preg_replace('/[^A-Za-z0-9_]/', '_', $logicalName);

    return "u{$uid}_a{$app_id}_{$safeName}";
}
?>

```
**devolverTablaAplicacion.php**
```php
<?php

	/**
 * Same as above, but from (app_id + logical_name).
 */
function get_prefixed_tablename_by_app($db, $app_id, $logical_name) {
    $stmt = $db->prepare("SELECT company_id FROM company_applications WHERE id=?");
    $stmt->bindValue(1, $app_id, SQLITE3_INTEGER);
    $row = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$row) return null;

    $uid      = $row['company_id'];
    $safeName = preg_replace('/[^A-Za-z0-9_]/', '_', $logical_name);

    return "u{$uid}_a{$app_id}_{$safeName}";
}

?>

```
**entrecomillar.php**
```php
<?php

	function quote_ident($ident) {
    return '"' . str_replace('"', '""', $ident) . '"';
}

?>

```
**enviarmailsmtp.php**
```php
<?php
function manual_smtp_send($db, $companyId, $fromName, $toEmail, $subject, $messageBody) {
    // Fetch SMTP settings from the company table.
    $st = $db->prepare("SELECT smtp_server, smtp_port, smtp_user, smtp_pass FROM company WHERE id=?");
    $st->bindValue(1, $companyId, SQLITE3_INTEGER);
    $c = $st->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$c) {
        throw new Exception("No se encontró la configuración SMTP para la empresa (ID=$companyId).");
    }
    $smtpHost = $c['smtp_server'] ?: '';
    $smtpPort = (int)($c['smtp_port'] ?: 465);
    $smtpUser = $c['smtp_user'] ?: '';
    $smtpPass = $c['smtp_pass'] ?: '';
    if (!$smtpHost || !$smtpUser || !$smtpPass) {
        throw new Exception("La configuración SMTP está incompleta.");
    }

    // Connect via SSL.
    $fp = @fsockopen("ssl://".$smtpHost, $smtpPort, $errno, $errstr, 15);
    if (!$fp) {
        throw new Exception("Error conectando con SMTP ($smtpHost:$smtpPort): $errstr ($errno).");
    }
    $smtp_response = function() use ($fp) {
        $data = "";
        while ($str = fgets($fp, 515)) {
            $data .= $str;
            if (substr($str, 3, 1) == " ") { 
                break; 
            }
        }
        return $data;
    };

    // Read the initial response.
    $res = $smtp_response();
    if (substr($res,0,3) !== '220') {
        fclose($fp);
        throw new Exception("Respuesta inesperada al conectar: $res");
    }

    // EHLO
    fputs($fp, "EHLO localhost\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '250') {
        fclose($fp);
        throw new Exception("EHLO rechazado: $res");
    }

    // AUTH LOGIN
    fputs($fp, "AUTH LOGIN\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '334') {
        fclose($fp);
        throw new Exception("AUTH LOGIN no aceptado: $res");
    }
    fputs($fp, base64_encode($smtpUser)."\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '334') {
        fclose($fp);
        throw new Exception("Usuario SMTP no aceptado: $res");
    }
    fputs($fp, base64_encode($smtpPass)."\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '235') {
        fclose($fp);
        throw new Exception("Contraseña SMTP no aceptada: $res");
    }

    // MAIL FROM
    $fromEmail = $smtpUser; 
    fputs($fp, "MAIL FROM: <{$fromEmail}>\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '250') {
        fclose($fp);
        throw new Exception("MAIL FROM rechazado: $res");
    }

    // RCPT TO
    fputs($fp, "RCPT TO: <{$toEmail}>\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '250' && substr($res,0,3) !== '251') {
        fclose($fp);
        throw new Exception("RCPT TO rechazado: $res");
    }

    // DATA
    fputs($fp, "DATA\r\n");
    $res = $smtp_response();
    if (substr($res,0,3) !== '354') {
        fclose($fp);
        throw new Exception("DATA no aceptado: $res");
    }

    // Headers and message payload.
    $headers = "From: \"{$fromName}\" <{$fromEmail}>\r\n";
    $headers .= "Reply-To: {$fromEmail}\r\n";
    $headers .= "MIME-Version: 1.0\r\n";
    $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";

    $payload = "Subject: {$subject}\r\n{$headers}\r\n{$messageBody}\r\n.\r\n";
    fputs($fp, $payload);
    $res = $smtp_response();
    if (substr($res,0,3) !== '250') {
        fclose($fp);
        throw new Exception("Fallo al enviar el mensaje: $res");
    }

    // QUIT
    fputs($fp, "QUIT\r\n");
    fclose($fp);
}
?>

```
**funciones.php**
```php
<?php

	/**
 * Build label for a foreign reference row (excluding 'id').
 */
function build_foreign_option_label(array $row) {
    $parts = [];
    foreach ($row as $k => $v) {
        if ($k === 'id') continue;
        $parts[] = $v;
    }
    return implode(" - ", $parts);
}

/**
 * Renders the foreign row data as a joined string or nested table.
 */
function render_foreign_row_data(array $row, bool $horizontal, bool $nested, bool $first_column_only = false) {
    if (!$nested) {
        return htmlspecialchars(build_foreign_option_label($row));
    }
    if ($first_column_only) {
        foreach ($row as $k => $v) {
            if ($k === 'id') continue;
            return htmlspecialchars($v);
        }
        return '(Sin datos)';
    }
    unset($row['id']);
    if ($horizontal) {
        $th = '';
        $td = '';
        foreach($row as $k => $v) {
            $th .= '<th style="background:#f9f9f9;">'.htmlspecialchars($k).'</th>';
            $td .= '<td>'.htmlspecialchars($v).'</td>';
        }
        return '<table style="border:1px solid #ccc; font-size:0.8em; margin-bottom:5px;">
                  <thead><tr>'.$th.'</tr></thead>
                  <tbody><tr>'.$td.'</tr></tbody>
                </table>';
    } else {
        $tableRows = '';
        foreach($row as $k => $v) {
            $tableRows .= '<tr>
                             <th style="background:#f9f9f9;">'.htmlspecialchars($k).'</th>
                             <td>'.htmlspecialchars($v).'</td>
                           </tr>';
        }
        return '<table style="border:1px solid #ccc; font-size:0.8em; margin-bottom:5px;">'
               .$tableRows.'</table>';
    }
}

/**
 * Build a nested structure of folders + tables recursively.
 */
function build_folder_tree($db, $app_id, $parent_id=null) {
    $sql = "SELECT id, folder_name
            FROM company_folders
            WHERE application_id=:aid ";
    if (is_null($parent_id)) {
        $sql .= "AND (parent_folder_id IS NULL OR parent_folder_id=0) ";
    } else {
        $sql .= "AND parent_folder_id=:pid ";
    }
    $sql .= "ORDER BY folder_name";
    $st = $db->prepare($sql);
    $st->bindValue(':aid', $app_id, SQLITE3_INTEGER);
    if (!is_null($parent_id)) {
        $st->bindValue(':pid', $parent_id, SQLITE3_INTEGER);
    }
    $frs = $st->execute();

    $result = [];
    while ($f = $frs->fetchArray(SQLITE3_ASSOC)) {
        $folderChildren = build_folder_tree($db, $app_id, $f['id']);
        $result[] = [
            'type' => 'folder',
            'id'   => $f['id'],
            'name' => $f['folder_name'],
            'children' => $folderChildren
        ];
    }

    $sql2 = "SELECT id, table_name
             FROM company_tables
             WHERE application_id=:aid ";
    if (is_null($parent_id)) {
        $sql2 .= "AND (folder_id IS NULL OR folder_id=0) ";
    } else {
        $sql2 .= "AND folder_id=:pid ";
    }
    $sql2 .= "ORDER BY table_name";
    $st2 = $db->prepare($sql2);
    $st2->bindValue(':aid', $app_id, SQLITE3_INTEGER);
    if (!is_null($parent_id)) {
        $st2->bindValue(':pid', $parent_id, SQLITE3_INTEGER);
    }
    $trs = $st2->execute();
    while ($t = $trs->fetchArray(SQLITE3_ASSOC)) {
        $result[] = [
            'type' => 'table',
            'id'   => $t['id'],
            'name' => $t['table_name']
        ];
    }

    return $result;
}

/**
 * Display the folder tree in HTML <nav>.
 */
function render_folder_tree(array $tree, $app_id) {
    // check if admin
    $isAdmin = (isset($_SESSION['role']) && $_SESSION['role'] === 'admin');

    echo '<ul style="list-style:none; padding-left:15px;">';
    foreach ($tree as $item) {
        if ($item['type']==='folder') {
            echo '<li style="margin-bottom:8px;">';
            echo '<span style="font-weight:bold; color:#fafafa;">📁 '
                  .htmlspecialchars($item['name']).'</span>';

            // Wrap “delete folder” & “rename folder” in if($isAdmin)
            if ($isAdmin) {
                echo '<form method="post" style="display:inline-block;width:40px;"
                      onsubmit="return confirm(\'¿Eliminar carpeta y todo su contenido?\');">
                      <input type="hidden" name="action" value="delete_folder">
                      <input type="hidden" name="app_id" value="'.(int)$app_id.'">
                      <input type="hidden" name="folder_id" value="'.(int)$item['id'].'">
                      <button type="submit" style="background:none; margin-left:6px; padding:4px; font-size:0.8rem;" class="naveliminar">
                        <span class="jocarsa-icon jocarsa-icon-eliminar"></span>
                      </button>
                    </form>';

                echo '<button onclick="renameFolder('.(int)$item['id'].', \''.htmlspecialchars(addslashes($item['name'])).'\');"
                  style="background:orange; margin-left:6px; padding:4px 8px; font-size:0.8rem;display:inline-block;width:40px;" class="botoneditar">
                  <span class="jocarsa-icon jocarsa-icon-editar"></span>
                  </button>';
            }
            // Render subfolders
            if (!empty($item['children'])) {
                render_folder_tree($item['children'], $app_id);
            }
            echo '</li>';
        } else {
            // Table item
            echo '<li style="margin-bottom:8px;">';
            echo '<a href="'.$_SERVER['PHP_SELF'].'?route=table&table_name='
                 .urlencode($item['name']).'&app_id='.$app_id.'">
                  <button style="display:inline-block; width:auto; margin-right:4px;">📄 '
                  .htmlspecialchars($item['name'])
                  .'</button></a>';

            // Wrap “delete table” in if($isAdmin)
            if ($isAdmin) {
                echo '<form method="post" style="display:inline-block;width:40px;"
                       onsubmit="return confirm(\'¿Seguro de eliminar esta tabla?\');">
                    <input type="hidden" name="action" value="delete_table">
                    <input type="hidden" name="app_id" value="'.(int)$app_id.'">
                    <input type="hidden" name="table_id" value="'.(int)$item['id'].'">
                    <button type="submit" style="background:none; margin-left:6px; padding:4px; font-size:0.8rem;" class="naveliminar">
                      <span class="jocarsa-icon jocarsa-icon-eliminar"></span>
                    </button>
                   </form>';
            }
            echo '</li>';
        }
    }
    echo '</ul>';
}


/**
 * Build a nested, slash-separated folder path for each table, so we can list them as:
 * AppName - folder1/folder2 - tableName.
 * Returns an array of rows: [ 'app_id' => ..., 'table_name' => ..., 'app_name' => ..., 'folder_path' => ... ]
 */
function get_all_user_tables($db, $company_id) {
    $results = [];
    $qApp = $db->prepare("SELECT id, application_name FROM company_applications WHERE company_id=? ORDER BY application_name");
    $qApp->bindValue(1, $company_id, SQLITE3_INTEGER);
    $apps = $qApp->execute();
    while($a = $apps->fetchArray(SQLITE3_ASSOC)) {
        $appId   = (int)$a['id'];
        $appName = $a['application_name'];

        $tst = $db->prepare("SELECT id, table_name, folder_id FROM company_tables WHERE application_id=? ORDER BY table_name");
        $tst->bindValue(1, $appId, SQLITE3_INTEGER);
        $trs = $tst->execute();
        while($trow=$trs->fetchArray(SQLITE3_ASSOC)) {
            $folderId = (int)$trow['folder_id'];
            $fpath    = '';
            if ($folderId > 0) {
                $fpath = build_folder_path_string($db, $folderId);
            }
            $results[] = [
                'app_id'      => $appId,
                'app_name'    => $a['application_name'],
                'table_name'  => $trow['table_name'],
                'folder_path' => $fpath
            ];
        }
    }
    return $results;
}

/**
 * Build the <select> for a foreign field when adding/editing a row.
 */
function build_foreign_select($db, $appId, $tableName, $encodedCName, $multiple=false, $selectedVal=null) {
    // 1) Prepare the "selectedArr" if multiple
    $selectedArr = [];
    if ($multiple) {
        if (is_array($selectedVal)) {
            foreach ($selectedVal as $v) {
                $selectedArr[] = (int)$v;
            }
        } elseif (is_string($selectedVal) && $selectedVal !== '') {
            $selectedArr[] = (int)$selectedVal;
        }
    }

    $selectedValInt = 0;
    if (!$multiple && $selectedVal !== null && $selectedVal !== '') {
        $selectedValInt = (int)$selectedVal;
    }

    $stmt = $db->prepare("SELECT company_id FROM company_applications WHERE id=?");
    $stmt->bindValue(1, $appId, SQLITE3_INTEGER);
    $appRow = $stmt->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$appRow) {
        $n = $multiple ? "multi_{$encodedCName}[]" : "val_{$encodedCName}";
        return '<select name="'.htmlspecialchars($n).'"><option value="">(Tabla desconocida)</option></select>';
    }

    $uid      = $appRow['company_id'];
    $safeName = preg_replace('/[^A-Za-z0-9_]/', '_', $tableName);
    $pref     = "u{$uid}_a{$appId}_{$safeName}";

    $n = $multiple ? "multi_{$encodedCName}[]" : "val_{$encodedCName}";
    $q  = @$db->query("SELECT * FROM ".quote_ident($pref));
    if (!$q) {
        return '<select name="'.htmlspecialchars($n).'"><option value="">(Tabla desconocida)</option></select>';
    }

    $options = '';
    while($fr = $q->fetchArray(SQLITE3_ASSOC)) {
        $optVal   = (int)$fr['id'];
        $optLabel = build_foreign_option_label($fr);
        $selAttr  = '';
        if ($multiple) {
            if (in_array($optVal, $selectedArr, true)) {
                $selAttr = ' selected';
            }
        } else {
            if ($optVal === $selectedValInt) {
                $selAttr = ' selected';
            }
        }
        $options .= '<option value="'.htmlspecialchars($optVal).'"'.$selAttr.'>'
                    .htmlspecialchars($optLabel).'</option>';
    }

    $html = '<select name="'.htmlspecialchars($n).'">';
    $html .= '<option value="0">--Seleccione--</option>';
    $html .= $options;
    $html .= '</select>';
    return $html;
}

// -------------------------------------

?>

```
**funcionesCodificacion.php**
```php
<?php

	function encode_col_name($colName) {
    return base64_encode($colName);
}
function decode_col_name($encoded) {
    return base64_decode($encoded);
}

?>

```
**inicializarDB.php**
```php
<?php
/**
 * Create the basic schema if missing.
 */
function init_db($db) {
    // -- Existing tables --
    $db->exec("
        CREATE TABLE IF NOT EXISTS company (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            email TEXT UNIQUE,
            password TEXT,
            company_name TEXT,
            company_color TEXT
            -- We'll add new columns below by trying to ALTER the table
        )
    ");

    // Try to add new columns for SMTP/IMAP if not exist:
    // (Note: In production, you would check 'PRAGMA table_info(company)' etc. before altering.)
    /*
    $db->exec('ALTER TABLE company ADD COLUMN smtp_server TEXT');
    $db->exec('ALTER TABLE company ADD COLUMN smtp_port INTEGER');
    $db->exec('ALTER TABLE company ADD COLUMN smtp_user TEXT');
    $db->exec('ALTER TABLE company ADD COLUMN smtp_pass TEXT');
    $db->exec('ALTER TABLE company ADD COLUMN imap_server TEXT');
    */

    $db->exec("
        CREATE TABLE IF NOT EXISTS company_applications (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            company_id INTEGER,
            application_name TEXT,
            FOREIGN KEY(company_id) REFERENCES company(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS company_tables (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            application_id INTEGER,
            table_name TEXT,
            folder_id INTEGER,
            FOREIGN KEY(application_id) REFERENCES company_applications(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS company_table_columns (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            table_id INTEGER,
            column_name TEXT,
            data_type TEXT,
            input_type TEXT,
            is_multiple INTEGER DEFAULT 0,
            is_foreign INTEGER DEFAULT 0,
            foreign_app_id INTEGER DEFAULT 0,
            foreign_table_name TEXT DEFAULT '',
            FOREIGN KEY(table_id) REFERENCES company_tables(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS company_folders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            application_id INTEGER,
            folder_name TEXT,
            parent_folder_id INTEGER,
            FOREIGN KEY(application_id) REFERENCES company_applications(id),
            FOREIGN KEY(parent_folder_id) REFERENCES company_folders(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            email TEXT UNIQUE,
            password TEXT,
            role TEXT,
            company_id INTEGER,
            FOREIGN KEY(company_id) REFERENCES company(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS operation_log (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            operation_type TEXT,
            operation_details TEXT,
            operation_time TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES users(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS remember_tokens (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            token TEXT UNIQUE,
            expires_at TEXT,
            FOREIGN KEY(user_id) REFERENCES company(id)
        )
    ");

    $db->exec("
        CREATE TABLE IF NOT EXISTS sent_emails (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            company_id INTEGER,
            user_id INTEGER,
            recipient_email TEXT,
            subject TEXT,
            message TEXT,
            date_sent TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(company_id) REFERENCES company(id),
            FOREIGN KEY(user_id) REFERENCES users(id)
        )
    ");

    /**
     * NEW TABLE: sent_whatsapp
     */
    $db->exec("
        CREATE TABLE IF NOT EXISTS sent_whatsapp (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            company_id INTEGER,
            user_id INTEGER,
            phone TEXT,
            message TEXT,
            date_sent TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(company_id) REFERENCES company(id),
            FOREIGN KEY(user_id) REFERENCES users(id)
        )
    ");
}


```
**logOperaciones.php**
```php
<?php
	/**
	 * Log operations in the database.
	 */
	function log_operation($db, $user_id, $operation_type, $operation_details) {
		 $stm = $db->prepare("INSERT INTO operation_log (user_id, operation_type, operation_details) VALUES (?, ?, ?)");
		 $stm->bindValue(1, $user_id, SQLITE3_INTEGER);
		 $stm->bindValue(2, $operation_type, SQLITE3_TEXT);
		 $stm->bindValue(3, $operation_details, SQLITE3_TEXT);
		 $stm->execute();
	}
?>

```
**migasDePan.php**
```php
<?php

	/**
 * Build breadcrumbs as an HTML string.
 */
function build_breadcrumbs($db, $route, $appId=null, $tableId=null, $rowId=null) {
    $companyName = $_SESSION['company_name'] ?? 'My Company';
    $crumbs = [];
    $crumbs[] = '<a href="'.$_SERVER['PHP_SELF'].'">'.htmlspecialchars($companyName).'</a>';

    if ($appId) {
        $st = $db->prepare("SELECT id, application_name FROM company_applications WHERE id=?");
        $st->bindValue(1, $appId, SQLITE3_INTEGER);
        $appRow = $st->execute()->fetchArray(SQLITE3_ASSOC);
        if ($appRow) {
            $crumbs[] = '<a href="'.$_SERVER['PHP_SELF'].'?route=app&app_id='.$appId.'">'
                      .htmlspecialchars($appRow['application_name']).'</a>';
        }
    }

    if ($tableId) {
        $stmtT = $db->prepare("SELECT folder_id, table_name FROM company_tables WHERE id=?");
        $stmtT->bindValue(1, $tableId, SQLITE3_INTEGER);
        $tbl = $stmtT->execute()->fetchArray(SQLITE3_ASSOC);
        if ($tbl) {
            $folderId  = (int)$tbl['folder_id'];
            $tableName = $tbl['table_name'];
            if ($folderId > 0) {
                $folderPath = get_folder_path($db, $folderId);
                foreach ($folderPath as $f) {
                    $crumbs[] = '<a href="'.$_SERVER['PHP_SELF'].'?route=app&app_id='.$appId.'#folder-'
                              .$f['id'].'">'.htmlspecialchars($f['folder_name']).'</a>';
                }
            }
            $crumbs[] = '<a href="'.$_SERVER['PHP_SELF'].'?route=table&app_id='.$appId
                      .'&table_name='.urlencode($tableName).'">'.htmlspecialchars($tableName).'</a>';
        }
    }

    if ($route === 'report' && $rowId) {
        $crumbs[] = 'Report #'.(int)$rowId;
    }

    return implode(' &raquo; ', $crumbs);
}

?>

```
### Carpeta sin título
## inc
**busqueda.php**
```php
<?php

	if ($logged_in && isset($_GET['route']) && $_GET['route']==='search') {
    $query = trim($_GET['q'] ?? '');
    if ($query==='') {
        echo "No search query.";
        exit;
    }
    $tableList = [];
    $stApp = $db->prepare("SELECT id FROM company_applications WHERE company_id=?");
    $stApp->bindValue(1, $_SESSION['user_id'], SQLITE3_INTEGER);
    $resApp = $stApp->execute();
    while($a = $resApp->fetchArray(SQLITE3_ASSOC)) {
        $appId = $a['id'];
        $stTab = $db->prepare("SELECT id, table_name FROM company_tables WHERE application_id=?");
        $stTab->bindValue(1, $appId, SQLITE3_INTEGER);
        $rTab = $stTab->execute();
        while($tb = $rTab->fetchArray(SQLITE3_ASSOC)) {
            $tb['app_id'] = $appId;
            $tableList[] = $tb;
        }
    }
    ?>
    <header>
        <h1 class="corporativo"><img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal</h1>
        <?php
        $crumbHTML = build_breadcrumbs($db, '', null);
        ?>
        <h1 id="nombretabla"><?= $crumbHTML ?></h1>
        <a href="<?= $_SERVER['PHP_SELF'] ?>">Volver</a>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=logout' ?>"><span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span></a>
    </header>
    <main style="padding:20px;">
    <h2>Resultados de búsqueda en todas las tablas</h2>
    <?php
    foreach($tableList as $tbl) {
        $table_id   = $tbl['id'];
        $table_name = $tbl['table_name'];
        $prefixed   = get_prefixed_tablename($db, $table_id);

        $sdef = $db->prepare("SELECT column_name FROM company_table_columns WHERE table_id=?");
        $sdef->bindValue(1, $table_id, SQLITE3_INTEGER);
        $dres = $sdef->execute();
        $colArr = [];
        while($cd=$dres->fetchArray(SQLITE3_ASSOC)) {
            $colArr[] = $cd['column_name'];
        }
        if (empty($colArr)) continue;

        $searchSQL = [];
        foreach($colArr as $cn) {
            if ($cn==='id') continue;
            $searchSQL[] = quote_ident($cn)." LIKE :search";
        }
        if (empty($searchSQL)) continue;

        $where = implode(" OR ", $searchSQL);
        $sql = "SELECT * FROM ".quote_ident($prefixed)." WHERE ($where)";
        $stmtSearch = $db->prepare($sql);
        $stmtSearch->bindValue(':search','%'.$query.'%', SQLITE3_TEXT);
        $resSearch = $stmtSearch->execute();

        $foundRows = [];
        while($rw=$resSearch->fetchArray(SQLITE3_ASSOC)) {
            $foundRows[] = $rw;
        }
        if (count($foundRows)>0) {
            echo "<h3>Tabla: ".htmlspecialchars($table_name)."</h3>";
            echo "<table style='border:1px solid #ccc; margin-bottom:20px;'>";
            echo "<thead><tr>";
            foreach($colArr as $c) {
                echo "<th>".htmlspecialchars($c)."</th>";
            }
            echo "</tr></thead><tbody>";
            foreach($foundRows as $fr) {
                echo "<tr>";
                foreach($colArr as $c) {
                    echo "<td>".htmlspecialchars($fr[$c] ?? '')."</td>";
                }
                echo "</tr>";
            }
            echo "</tbody></table>";
        }
    }
    ?>
    </main>
    <?php
    exit;
}

?>

```
**comprobarLogin.php**
```php
<?php
	
	if ($logged_in) {
    $allApps = [];
    $as = $db->prepare("SELECT id, application_name FROM company_applications WHERE company_id=?");
    $as->bindValue(1, $_SESSION['user_id'], SQLITE3_INTEGER);
    $ars = $as->execute();
    while($ar = $ars->fetchArray(SQLITE3_ASSOC)) {
        $allApps[$ar['id']] = [
            'appName' => $ar['application_name'],
            'tables'  => []
        ];
    }

    foreach ($allApps as $aid => &$inf) {
        $st2 = $db->prepare("SELECT id, table_name FROM company_tables WHERE application_id=?");
        $st2->bindValue(1, $aid, SQLITE3_INTEGER);
        $r2 = $st2->execute();
        while($ttb=$r2->fetchArray(SQLITE3_ASSOC)) {
            $inf['tables'][] = $ttb;
        }
    }

    foreach ($allApps as $aid => $info) {
        $foreignAppOptions .= '<option value="'.$aid.'">'
            . htmlspecialchars($info['appName'])
            . '</option>';
    }

    $tmpArr = [];
    foreach ($allApps as $aid => $inf) {
        $arrTables = [];
        foreach ($inf['tables'] as $ttb) {
            $arrTables[] = $ttb['table_name'];
        }
        $tmpArr[$aid] = $arrTables;
    }
    $allTablesJson = json_encode($tmpArr, JSON_UNESCAPED_UNICODE);
}
	
?>

```
**css3colors.php**
```php
<?php
function opcionesCss3($colorbase){


$css3_colors = array(
	"None",
    "AliceBlue",
    "AntiqueWhite",
    "Aqua",
    "Aquamarine",
    "Azure",
    "Beige",
    "Bisque",
    "Black",
    "BlanchedAlmond",
    "Blue",
    "BlueViolet",
    "Brown",
    "BurlyWood",
    "CadetBlue",
    "Chartreuse",
    "Chocolate",
    "Coral",
    "CornflowerBlue",
    "Cornsilk",
    "Crimson",
    "Cyan",
    "DarkBlue",
    "DarkCyan",
    "DarkGoldenRod",
    "DarkGray",
    "DarkGreen",
    "DarkKhaki",
    "DarkMagenta",
    "DarkOliveGreen",
    "DarkOrange",
    "DarkOrchid",
    "DarkRed",
    "DarkSalmon",
    "DarkSeaGreen",
    "DarkSlateBlue",
    "DarkSlateGray",
    "DarkTurquoise",
    "DarkViolet",
    "DeepPink",
    "DeepSkyBlue",
    "DimGray",
    "DodgerBlue",
    "FireBrick",
    "FloralWhite",
    "ForestGreen",
    "Fuchsia",
    "Gainsboro",
    "GhostWhite",
    "Gold",
    "GoldenRod",
    "Gray",
    "Green",
    "GreenYellow",
    "HoneyDew",
    "HotPink",
    "IndianRed",
    "Indigo",
    "Ivory",
    "Khaki",
    "Lavender",
    "LavenderBlush",
    "LawnGreen",
    "LemonChiffon",
    "LightBlue",
    "LightCoral",
    "LightCyan",
    "LightGoldenRodYellow",
    "LightGray",
    "LightGreen",
    "LightPink",
    "LightSalmon",
    "LightSeaGreen",
    "LightSkyBlue",
    "LightSlateGray",
    "LightSteelBlue",
    "LightYellow",
    "Lime",
    "LimeGreen",
    "Linen",
    "Magenta",
    "Maroon",
    "MediumAquaMarine",
    "MediumBlue",
    "MediumOrchid",
    "MediumPurple",
    "MediumSeaGreen",
    "MediumSlateBlue",
    "MediumSpringGreen",
    "MediumTurquoise",
    "MediumVioletRed",
    "MidnightBlue",
    "MintCream",
    "MistyRose",
    "Moccasin",
    "NavajoWhite",
    "Navy",
    "OldLace",
    "Olive",
    "OliveDrab",
    "Orange",
    "OrangeRed",
    "Orchid",
    "PaleGoldenRod",
    "PaleGreen",
    "PaleTurquoise",
    "PaleVioletRed",
    "PapayaWhip",
    "PeachPuff",
    "Peru",
    "Pink",
    "Plum",
    "PowderBlue",
    "Purple",
    "RebeccaPurple",
    "Red",
    "RosyBrown",
    "RoyalBlue",
    "SaddleBrown",
    "Salmon",
    "SandyBrown",
    "SeaGreen",
    "SeaShell",
    "Sienna",
    "Silver",
    "SkyBlue",
    "SlateBlue",
    "SlateGray",
    "Snow",
    "SpringGreen",
    "SteelBlue",
    "Tan",
    "Teal",
    "Thistle",
    "Tomato",
    "Turquoise",
    "Violet",
    "Wheat",
    "White",
    "WhiteSmoke",
    "Yellow",
    "YellowGreen"
);

foreach($css3_colors as $color){
	if($color == $colorbase){
		echo '<option value="'.$color.'" style="background: '.$color.';" selected>'.$color.'</option>';
	}else{
		echo '<option value="'.$color.'" style="background: '.$color.';">'.$color.'</option>';
	}
}
}
?>

  

```
**errores.php**
```php
<?php
	ini_set('display_errors', '1');
	ini_set('display_startup_errors', '1');
	error_reporting(E_ALL);
?>

```
**informe.php**
```php
<?php
// File: /var/www/html/jocarsa-teal/inc/informe.php

if ($logged_in && isset($_GET['route']) && $_GET['route'] === 'report') {
    $table_name = $_GET['table_name'] ?? '';
    $app_id     = (int)($_GET['app_id'] ?? 0);
    $row_id     = (int)($_GET['row_id'] ?? 0);

    // 1) Validate app & table ownership
    $checkApp = $db->prepare("SELECT id FROM company_applications WHERE id=? AND company_id=?");
    $checkApp->bindValue(1, $app_id, SQLITE3_INTEGER);
    $checkApp->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
    $appInfo = $checkApp->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$appInfo) exit("No permission or invalid app.");

    $checkTab = $db->prepare("SELECT id FROM company_tables WHERE application_id=? AND table_name=?");
    $checkTab->bindValue(1, $app_id, SQLITE3_INTEGER);
    $checkTab->bindValue(2, $table_name, SQLITE3_TEXT);
    $tinfo = $checkTab->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$tinfo) exit("Table not found.");

    $table_id = $tinfo['id'];
    $prefixed = get_prefixed_tablename($db, $table_id);
    if (!$prefixed) exit("Physical table not found.");

    // 2) Fetch column definitions
    $colDefs = [];
    $cs = $db->prepare("SELECT * FROM company_table_columns WHERE table_id=?");
    $cs->bindValue(1, $table_id, SQLITE3_INTEGER);
    $cres = $cs->execute();
    while ($cd = $cres->fetchArray(SQLITE3_ASSOC)) {
        $colDefs[] = $cd;
    }

    // 3) Fetch this row’s data
    $stmtRow = $db->prepare("SELECT * FROM ".quote_ident($prefixed)." WHERE \"id\"=?");
    $stmtRow->bindValue(1, $row_id, SQLITE3_INTEGER);
    $rowData = $stmtRow->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$rowData) {
        echo "<h2>Registro no encontrado</h2>";
        exit;
    }

    // 4) Header + breadcrumbs
    ?>
    <header>
        <?php
        $crumbHTML = build_breadcrumbs($db, 'report', $app_id, $table_id, $row_id);
        ?>
        <h1 id="nombretabla"><?= $crumbHTML ?></h1>
        <h1><img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal</h1>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=table&table_name='.urlencode($table_name).'&app_id='.$app_id ?>">Volver</a>
        <a href="<?= $_SERVER['PHP_SELF'].'?route=logout' ?>">
            <span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span>
        </a>
        <link rel="stylesheet" href="static/report.css">
    </header>

    <main style="padding:20px;">
        <h2>Reporte (Vista de solo lectura)</h2>

        <!-- 5) Main record table -->
        <table style="width:50%; border-collapse:collapse; margin-bottom:20px;">
            <?php foreach ($colDefs as $cd): 
                $colName    = $cd['column_name'];
                $val        = $rowData[$colName] ?? '';
                $isMult     = (int)$cd['is_multiple'];
                $isForeign  = (int)$cd['is_foreign'];
                $fAppId     = (int)$cd['foreign_app_id'];
                $fTableName = $cd['foreign_table_name'];
                $dtype      = strtoupper($cd['data_type']);
                $inputType  = $cd['input_type'];
                ?>
                <tr style="border-bottom:1px solid #ccc;">
                    <th style="padding:8px; background:#f9f9f9; text-align:left;">
                        <?= htmlspecialchars($colName) ?>
                    </th>
                    <td style="padding:8px;">
                        <?php
                        if ($isForeign && $fAppId && $fTableName) {
                            $refP = get_prefixed_tablename_by_app($db, $fAppId, $fTableName);
                            if ($refP) {
                                // Multiple foreign
                                if ($isMult) {
                                    $arr = json_decode($val, true);
                                    if (!is_array($arr)) {
                                        echo '(Sin datos)';
                                    } else {
                                        foreach ($arr as $oneId) {
                                            $oneId = (int)$oneId;
                                            $fkst = $db->prepare("SELECT * FROM " . quote_ident($refP) ." WHERE \"id\"=?");
                                            $fkst->bindValue(1, $oneId, SQLITE3_INTEGER);
                                            $fkrow = $fkst->execute()->fetchArray(SQLITE3_ASSOC);
                                            if ($fkrow) {
                                                echo render_foreign_row_data(
                                                    $fkrow, 
                                                    $NESTED_TABLES_HORIZONTAL, 
                                                    $USE_NESTED_TABLES,
                                                    false
                                                );
                                            } else {
                                                echo '(Sin datos)<br>';
                                            }
                                        }
                                    }
                                }
                                // Single foreign
                                else {
                                    if ($val !== '') {
                                        $fkst = $db->prepare("SELECT * FROM " . quote_ident($refP)." WHERE \"id\"=?");
                                        $fkst->bindValue(1, (int)$val, SQLITE3_INTEGER);
                                        $fkrow = $fkst->execute()->fetchArray(SQLITE3_ASSOC);
                                        if ($fkrow) {
                                            echo render_foreign_row_data(
                                                $fkrow, 
                                                $NESTED_TABLES_HORIZONTAL, 
                                                $USE_NESTED_TABLES, 
                                                false
                                            );
                                        } else {
                                            echo '(Sin datos)';
                                        }
                                    } else {
                                        echo '(Sin datos)';
                                    }
                                }
                            } else {
                                echo '(Tabla ref no existe)';
                            }
                        }
                        else {
                            // Color, multiple or normal text/file
                            if ($dtype === 'COLOR') {
                                $colorVal = htmlspecialchars($val);
                                if ($colorVal) {
                                    echo '<div style="display:inline-block;width:20px;height:20px;background:'
                                         .$colorVal.';border:1px solid #000;margin-right:8px;"></div>';
                                    echo $colorVal;
                                } else {
                                    echo '(Sin datos)';
                                }
                            }
                            else if ($isMult) {
                                $arr = json_decode($val, true);
                                if (is_array($arr)) {
                                    echo htmlspecialchars(implode(' | ', $arr));
                                } else {
                                    echo htmlspecialchars($val);
                                }
                            }
                            else if ($inputType === 'file' && file_exists($val)) {
                                echo '<a href="'.$val.'" target="_blank">'.basename($val).'</a>';
                            } else {
                                echo htmlspecialchars($val);
                            }
                        }
                        ?>
                    </td>
                </tr>
            <?php endforeach; ?>
        </table>

        <hr>
        <h3>Tablas que referencian este registro</h3>
        <?php
        // 6) Find any child tables referencing $table_name / $app_id
        $qsRef = $db->prepare("
            SELECT c.table_id,
                   c.column_name,
                   c.is_multiple,
                   t.table_name AS referencing_table
            FROM company_table_columns c
            JOIN company_tables t
              ON c.table_id = t.id
            JOIN company_applications a
              ON t.application_id = a.id
            WHERE c.is_foreign=1
              AND c.foreign_app_id = :aid
              AND c.foreign_table_name = :tname
        ");
        $qsRef->bindValue(':aid', $app_id,   SQLITE3_INTEGER);
        $qsRef->bindValue(':tname', $table_name, SQLITE3_TEXT);
        $resRef = $qsRef->execute();

        $refs = [];
        while ($rr = $resRef->fetchArray(SQLITE3_ASSOC)) {
            $refs[] = $rr;
        }

        if (empty($refs)) {
            echo "<p>Ninguna otra tabla hace referencia a “$table_name”.</p>";
        } else {
            foreach ($refs as $rf) {
                $child_table_id    = $rf['table_id'];
                $child_column      = $rf['column_name'];
                $child_is_multiple = (int)$rf['is_multiple'];
                $child_table_name  = $rf['referencing_table'];
                $child_prefixed    = get_prefixed_tablename($db, $child_table_id);

                if (!$child_prefixed) {
                    continue;
                }

                // Build a query to find rows referencing $row_id
                if ($child_is_multiple) {
                    // JSON array containing "$row_id"
                    $qchild = $db->prepare("
                        SELECT *
                        FROM ".quote_ident($child_prefixed)."
                        WHERE ".quote_ident($child_column)." LIKE ?
                    ");
                    $qchild->bindValue(1, '%"'.$row_id.'"%', SQLITE3_TEXT);
                } else {
                    // Single int
                    $qchild = $db->prepare("
                        SELECT *
                        FROM ".quote_ident($child_prefixed)."
                        WHERE ".quote_ident($child_column)." = ?
                    ");
                    $qchild->bindValue(1, $row_id, SQLITE3_INTEGER);
                }

                $rcRes    = $qchild->execute();
                $childRows = [];
                while ($rw = $rcRes->fetchArray(SQLITE3_ASSOC)) {
                    $childRows[] = $rw;
                }

                // Child table columns
                $stCols = $db->prepare("SELECT column_name FROM company_table_columns WHERE table_id=?");
                $stCols->bindValue(1, $child_table_id, SQLITE3_INTEGER);
                $colsRes = $stCols->execute();
                $childColNames = [];
                while ($cinfo = $colsRes->fetchArray(SQLITE3_ASSOC)) {
                    $childColNames[] = $cinfo['column_name'];
                }

                echo "<h4>Tabla: <em>".htmlspecialchars($child_table_name)."</em></h4>";

                if (empty($childRows)) {
                    echo "<p style='margin-left:20px;'>No se encontraron filas en “{$child_table_name}” que hagan referencia a ID=$row_id.</p>";
                    continue;
                }

                // Render referencing rows with same style as main table
                echo "<table style='width:50%; border-collapse:collapse; margin-bottom:20px;'>";

                // Table header
                echo "<thead>";
                echo "<tr style='border-bottom:1px solid #ccc;'>";
                foreach ($childColNames as $ccn) {
                    echo "<th style='padding:8px; background:#f9f9f9; text-align:left;'>"
                         .htmlspecialchars($ccn)."</th>";
                }
                echo "</tr>";
                echo "</thead>";

                // Table body
                echo "<tbody>";
                foreach ($childRows as $cr) {
                    echo "<tr style='border-bottom:1px solid #ccc;'>";
                    foreach ($childColNames as $ccn) {
                        $val = $cr[$ccn] ?? '';
                        echo "<td style='padding:8px;'>".htmlspecialchars($val)."</td>";
                    }
                    echo "</tr>";
                }
                echo "</tbody>";
                echo "</table>";
            } // end foreach $refs
        } // end if empty($refs)
        ?>
    </main>
    <?php
    exit;
}
?>


```
**log.php**
```php
<?php
function logtexto($text) {
    // Get current timestamp
    $epoch = time();
    $readable = date("Y-m-d H:i:s", $epoch);

    // Prepare the CSV row
    $row = [$epoch, $readable, $text];

    // Open file for appending
    $file = fopen("log/log.csv", 'a');
    if ($file === false) {
        throw new Exception("Unable to open file: $filename");
    }

    // Write CSV row
    fputcsv($file, $row);

    // Close the file
    fclose($file);
}
?>

```
**manejadorPost.php**
```php
<?php
// -------------------------------------
// 4) HANDLE POST
// -------------------------------------
if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    // SIGNUP
    if (isset($_POST['signup_email'])) {
        $email = $_POST['signup_email'] ?? '';
        $passw = $_POST['signup_password'] ?? '';
        $cname = $_POST['signup_company_name'] ?? '';
        $ccolr = $_POST['signup_company_color'] ?? 'Teal';
        if ($email && $passw && $cname) {
            $stm = $db->prepare("INSERT INTO company (email, password, company_name, company_color) VALUES (?,?,?,?)");
            $stm->bindValue(1, $email, SQLITE3_TEXT);
            $stm->bindValue(2, $passw, SQLITE3_TEXT);
            $stm->bindValue(3, $cname, SQLITE3_TEXT);
            $stm->bindValue(4, $ccolr, SQLITE3_TEXT);
            $ok = @$stm->execute();
            if ($ok) {
                $nid = $db->lastInsertRowID();
                $_SESSION['user_id'] = $nid;
                $_SESSION['company_name'] = $cname;
                $_SESSION['company_color'] = $ccolr;
                log_operation($db, $nid, 'signup', "Signed up with email: $email");
            }
        }
        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
    // LOGIN
    elseif (isset($_POST['login_email'])) {
        $email = $_POST['login_email'] ?? '';
        $passw = $_POST['login_password'] ?? '';

        // 1) Check "users" table:
        $stmUsers = $db->prepare("SELECT id, password, role, company_id
                                  FROM users
                                  WHERE email=?");
        $stmUsers->bindValue(1, $email, SQLITE3_TEXT);
        $userRow = $stmUsers->execute()->fetchArray(SQLITE3_ASSOC);

        if ($userRow) {
            if ($userRow['password'] === $passw) {
                // Retrieve the company record associated with this user’s company_id
                $companyId = $userRow['company_id'];
                $stComp = $db->prepare("SELECT id, company_name, company_color
                                        FROM company
                                        WHERE id=?");
                $stComp->bindValue(1, $companyId, SQLITE3_INTEGER);
                $comp = $stComp->execute()->fetchArray(SQLITE3_ASSOC);
                if ($comp) {
                    $_SESSION['user_id']       = $comp['id'];
                    $_SESSION['company_name']  = $comp['company_name'];
                    $_SESSION['company_color'] = $comp['company_color'];
                    $_SESSION['role']          = $userRow['role']; // 'admin' or 'user'
                    log_operation($db, $userRow['id'], 'login', "Logged in (users table): $email");
                }
            }
        } else {
            // 2) Fallback to the "company" table:
            $stm = $db->prepare("SELECT id, password, company_name, company_color
                                 FROM company
                                 WHERE email=?");
            $stm->bindValue(1, $email, SQLITE3_TEXT);
            $companyRow = $stm->execute()->fetchArray(SQLITE3_ASSOC);
            if ($companyRow && $companyRow['password'] === $passw) {
                $_SESSION['user_id']       = $companyRow['id'];
                $_SESSION['company_name']  = $companyRow['company_name'];
                $_SESSION['company_color'] = $companyRow['company_color'];
                $_SESSION['role']          = 'admin';
                log_operation($db, $companyRow['id'], 'login', "Logged in (company table): $email");
            }
        }

        // If login is successful and "remember me" was checked, generate and store a token.
        if (isset($_SESSION['user_id']) && isset($_POST['remember_me']) && $_POST['remember_me'] === '1') {
            $token = bin2hex(random_bytes(32)); // Generate a secure token.
            $expires = date("Y-m-d H:i:s", strtotime("+30 days")); // Token valid for 30 days.

            $stmtToken = $db->prepare("INSERT INTO remember_tokens (user_id, token, expires_at) VALUES (?, ?, ?)");
            $stmtToken->bindValue(1, $_SESSION['user_id'], SQLITE3_INTEGER);
            $stmtToken->bindValue(2, $token, SQLITE3_TEXT);
            $stmtToken->bindValue(3, $expires, SQLITE3_TEXT);
            $stmtToken->execute();

            // Set a cookie with the token for 30 days (accessible site-wide)
            setcookie('remember_token', $token, time() + (30 * 24 * 60 * 60), "/");
        }

        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
    // CREATE APPLICATION
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'create_application') {
        $appName = trim($_POST['application_name'] ?? '');
        if ($appName !== '') {
            $st = $db->prepare("INSERT INTO company_applications (company_id, application_name) VALUES (?,?)");
            $st->bindValue(1, $_SESSION['user_id'], SQLITE3_INTEGER);
            $st->bindValue(2, $appName, SQLITE3_TEXT);
            $st->execute();
            log_operation($db, $_SESSION['user_id'], 'create_application', "Created application: $appName");
        }
        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
    // DELETE APPLICATION
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'delete_application') {
        $app_id = (int)($_POST['application_id'] ?? 0);
        $st = $db->prepare("SELECT id FROM company_tables WHERE application_id=?");
        $st->bindValue(1, $app_id, SQLITE3_INTEGER);
        $ts = $st->execute();
        while ($tb = $ts->fetchArray(SQLITE3_ASSOC)) {
            $tid = $tb['id'];
            $pref = get_prefixed_tablename($db, $tid);
            $db->exec("DROP TABLE IF EXISTS " . quote_ident($pref));
            $db->exec("DELETE FROM company_table_columns WHERE table_id=$tid");
        }
        $db->exec("DELETE FROM company_tables WHERE application_id=$app_id");
        $db->exec("DELETE FROM company_folders WHERE application_id=$app_id");

        $del = $db->prepare("DELETE FROM company_applications WHERE id=? AND company_id=?");
        $del->bindValue(1, $app_id, SQLITE3_INTEGER);
        $del->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
        $del->execute();
        log_operation($db, $_SESSION['user_id'], 'delete_application', "Deleted application with ID: $app_id");

        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
    // CREATE FOLDER
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'create_folder') {
        $app_id       = (int)($_POST['app_id'] ?? 0);
        $folderName   = trim($_POST['folder_name'] ?? '');
        $parentFolder = (int)($_POST['parent_folder_id'] ?? 0);

        $chk = $db->prepare("SELECT id FROM company_applications WHERE id=? AND company_id=?");
        $chk->bindValue(1, $app_id, SQLITE3_INTEGER);
        $chk->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
        $ok = $chk->execute()->fetchArray(SQLITE3_ASSOC);
        if ($ok && $folderName !== '') {
            $st = $db->prepare("
              INSERT INTO company_folders (application_id, folder_name, parent_folder_id)
              VALUES (?,?,?)
            ");
            $st->bindValue(1, $app_id, SQLITE3_INTEGER);
            $st->bindValue(2, $folderName, SQLITE3_TEXT);
            if ($parentFolder > 0) {
                $st->bindValue(3, $parentFolder, SQLITE3_INTEGER);
            } else {
                $st->bindValue(3, null, SQLITE3_NULL);
            }
            $st->execute();
            log_operation($db, $_SESSION['user_id'], 'create_folder', "Created folder: $folderName in application ID: $app_id");
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=app&app_id=" . $app_id);
        exit;
    }
    // RENAME FOLDER
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'rename_folder') {
        $app_id    = (int)($_POST['app_id'] ?? 0);
        $folder_id = (int)($_POST['folder_id'] ?? 0);
        $newName   = trim($_POST['new_folder_name'] ?? '');
        if ($folder_id > 0 && $newName !== '') {
            $ch = $db->prepare("
                SELECT f.id
                FROM company_folders f
                JOIN company_applications a ON f.application_id=a.id
                WHERE f.id=? AND a.company_id=?
            ");
            $ch->bindValue(1, $folder_id, SQLITE3_INTEGER);
            $ch->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
            $row = $ch->execute()->fetchArray(SQLITE3_ASSOC);
            if ($row) {
                $up = $db->prepare("UPDATE company_folders SET folder_name=? WHERE id=?");
                $up->bindValue(1, $newName, SQLITE3_TEXT);
                $up->bindValue(2, $folder_id, SQLITE3_INTEGER);
                $up->execute();
                log_operation($db, $_SESSION['user_id'], 'rename_folder', "Renamed folder ID: $folder_id to $newName");
            }
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=app&app_id=" . $app_id);
        exit;
    }
    // DELETE FOLDER
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'delete_folder') {
        $app_id    = (int)($_POST['app_id'] ?? 0);
        $folder_id = (int)($_POST['folder_id'] ?? 0);
        $ch = $db->prepare("
            SELECT f.id
            FROM company_folders f
            JOIN company_applications a ON f.application_id=a.id
            WHERE f.id=? AND a.company_id=?
        ");
        $ch->bindValue(1, $folder_id, SQLITE3_INTEGER);
        $ch->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
        $row = $ch->execute()->fetchArray(SQLITE3_ASSOC);
        if ($row) {
            $folderQueue = [$folder_id];
            $toDelete = [];
            while (!empty($folderQueue)) {
                $fid = array_pop($folderQueue);
                $toDelete[] = $fid;
                $cst = $db->prepare("SELECT id FROM company_folders WHERE parent_folder_id=?");
                $cst->bindValue(1, $fid, SQLITE3_INTEGER);
                $crs = $cst->execute();
                while ($cf = $crs->fetchArray(SQLITE3_ASSOC)) {
                    $folderQueue[] = $cf['id'];
                }
                $tbl = $db->prepare("SELECT id FROM company_tables WHERE folder_id=?");
                $tbl->bindValue(1, $fid, SQLITE3_INTEGER);
                $trs = $tbl->execute();
                while ($tb = $trs->fetchArray(SQLITE3_ASSOC)) {
                    $tid = $tb['id'];
                    $pref = get_prefixed_tablename($db, $tid);
                    $db->exec("DROP TABLE IF EXISTS " . quote_ident($pref));
                    $db->exec("DELETE FROM company_table_columns WHERE table_id=$tid");
                    $db->exec("DELETE FROM company_tables WHERE id=$tid");
                }
            }
            foreach ($toDelete as $dfid) {
                $db->exec("DELETE FROM company_folders WHERE id=$dfid");
            }
            log_operation($db, $_SESSION['user_id'], 'delete_folder', "Deleted folder ID: $folder_id and its contents");
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=app&app_id=" . $app_id);
        exit;
    }
    // DELETE TABLE
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'delete_table') {
        $table_id = (int)($_POST['table_id'] ?? 0);
        $checkSt = $db->prepare("
            SELECT t.id, a.company_id
            FROM company_tables t
            JOIN company_applications a ON t.application_id = a.id
            WHERE t.id = ?
        ");
        $checkSt->bindValue(1, $table_id, SQLITE3_INTEGER);
        $check = $checkSt->execute()->fetchArray(SQLITE3_ASSOC);
        if ($check && $check['company_id'] == $_SESSION['user_id']) {
            $pref = get_prefixed_tablename($db, $table_id);
            if ($pref) {
                $db->exec("DROP TABLE IF EXISTS " . quote_ident($pref));
            }
            $db->exec("DELETE FROM company_table_columns WHERE table_id=$table_id");
            $db->exec("DELETE FROM company_tables WHERE id=$table_id");
            log_operation($db, $_SESSION['user_id'], 'delete_table', "Deleted table ID: $table_id");
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=app&app_id=" . $_POST['app_id']);
        exit;
    }
    // RENAME APPLICATION
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'rename_application') {
        $app_id = (int)($_POST['application_id'] ?? 0);
        $newN   = trim($_POST['new_application_name'] ?? '');
        if ($newN !== '') {
            $st = $db->prepare("UPDATE company_applications SET application_name=? WHERE id=? AND company_id=?");
            $st->bindValue(1, $newN, SQLITE3_TEXT);
            $st->bindValue(2, $app_id, SQLITE3_INTEGER);
            $st->bindValue(3, $_SESSION['user_id'], SQLITE3_INTEGER);
            $st->execute();
            log_operation($db, $_SESSION['user_id'], 'rename_application', "Renamed application ID: $app_id to $newN");
        }
        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
    // CREATE NEW TABLE (defining columns)
    elseif ($logged_in && isset($_POST['application_id']) && isset($_POST['table_name']) && !isset($_POST['action'])) {
        $app_id = (int)$_POST['application_id'];
        $chk = $db->prepare("SELECT id FROM company_applications WHERE id=? AND company_id=?");
        $chk->bindValue(1, $app_id, SQLITE3_INTEGER);
        $chk->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
        $ok = $chk->execute()->fetchArray(SQLITE3_ASSOC);
        if (!$ok) {
            header("Location: " . $_SERVER['PHP_SELF']);
            exit;
        }
        $tName       = trim($_POST['table_name'] ?? '');
        $folder_id   = (int)($_POST['folder_id'] ?? 0);
        $columns     = $_POST['columns'] ?? [];
        $types       = $_POST['data_types'] ?? [];
        $inputTypes  = $_POST['input_types'] ?? [];
        $isForeign   = $_POST['is_foreign'] ?? [];
        $isMultiple  = $_POST['is_multiple'] ?? [];
        $foreignTargets = $_POST['foreign_target'] ?? [];
        if ($tName && count($columns) === count($types)) {
            $stT = $db->prepare("
                INSERT INTO company_tables(application_id, table_name, folder_id)
                VALUES(?,?,?)
            ");
            $stT->bindValue(1, $app_id, SQLITE3_INTEGER);
            $stT->bindValue(2, $tName, SQLITE3_TEXT);
            if ($folder_id > 0) {
                $stT->bindValue(3, $folder_id, SQLITE3_INTEGER);
            } else {
                $stT->bindValue(3, null, SQLITE3_NULL);
            }
            $stT->execute();
            $table_id = $db->lastInsertRowID();
            for ($i = 0; $i < count($columns); $i++) {
                $cName = trim($columns[$i]);
                $cType = $types[$i];
                $cInputType = $inputTypes[$i];
                $cF    = ($isForeign[$i] === '1') ? 1 : 0;
                $cM    = ($isMultiple[$i] === '1') ? 1 : 0;
                $cFA   = 0;
                $cFT   = '';
                if ($cF) {
                    $ftVal = $foreignTargets[$i] ?? '';
                    if ($ftVal !== '' && strpos($ftVal, '__') !== false) {
                        list($cFA, $cFT) = explode('__', $ftVal, 2);
                        $cFA = (int)$cFA;
                    }
                }
                if ($cName !== '') {
                    $stC = $db->prepare("
                        INSERT INTO company_table_columns
                        (table_id, column_name, data_type, input_type, is_multiple, is_foreign, foreign_app_id, foreign_table_name)
                        VALUES(?,?,?,?,?,?,?,?)
                    ");
                    $stC->bindValue(1, $table_id, SQLITE3_INTEGER);
                    $stC->bindValue(2, $cName, SQLITE3_TEXT);
                    $stC->bindValue(3, $cType, SQLITE3_TEXT);
                    $stC->bindValue(4, $cInputType, SQLITE3_TEXT);
                    $stC->bindValue(5, $cM, SQLITE3_INTEGER);
                    $stC->bindValue(6, $cF, SQLITE3_INTEGER);
                    $stC->bindValue(7, $cFA, SQLITE3_INTEGER);
                    $stC->bindValue(8, $cFT, SQLITE3_TEXT);
                    $stC->execute();
                }
            }
            build_real_table($db, $table_id);
            log_operation($db, $_SESSION['user_id'], 'create_table', "Created table: $tName in application ID: $app_id");
            header("Location: " . $_SERVER['PHP_SELF'] . "?route=table&table_name=" . urlencode($tName) . "&app_id=" . $app_id);
            exit;
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=app&app_id=" . $app_id);
        exit;
    }
    // CREATE USER
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'create_user') {
        $email = $_POST['user_email'] ?? '';
        $password = $_POST['user_password'] ?? '';
        $role = $_POST['user_role'] ?? '';
        if ($email && $password && $role) {
            $stm = $db->prepare("INSERT INTO users (email, password, role, company_id) VALUES (?, ?, ?, ?)");
            $stm->bindValue(1, $email, SQLITE3_TEXT);
            $stm->bindValue(2, $password, SQLITE3_TEXT);
            $stm->bindValue(3, $role, SQLITE3_TEXT);
            $stm->bindValue(4, $_SESSION['user_id'], SQLITE3_INTEGER);
            $stm->execute();
            log_operation($db, $_SESSION['user_id'], 'create_user', "Created user with email: $email");
        }
        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
    // CREATE a new user (via "manage users" page).
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'create_user_admin'
        && isset($_SESSION['role']) && $_SESSION['role'] === 'admin') {

        $email    = $_POST['user_email'] ?? '';
        $password = $_POST['user_password'] ?? '';
        $role     = $_POST['user_role'] ?? 'user';
        $companyId = (int)$_SESSION['user_id']; // The company's ID

        if ($email && $password) {
            $stm = $db->prepare("INSERT INTO users (email, password, role, company_id) VALUES (?,?,?,?)");
            $stm->bindValue(1, $email, SQLITE3_TEXT);
            $stm->bindValue(2, $password, SQLITE3_TEXT);
            $stm->bindValue(3, $role, SQLITE3_TEXT);
            $stm->bindValue(4, $companyId, SQLITE3_INTEGER);
            $stm->execute();
            log_operation($db, $companyId, 'create_user', "Admin created user with email: $email");
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=manage_users");
        exit;
    }
    // UPDATE a user
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'update_user'
        && isset($_SESSION['role']) && $_SESSION['role'] === 'admin') {

        $uid = (int)($_POST['user_id'] ?? 0);
        $newEmail = $_POST['user_email'] ?? '';
        $newPass  = $_POST['user_password'] ?? '';
        $newRole  = $_POST['user_role'] ?? 'user';
        $companyId = (int)$_SESSION['user_id']; // Admin's company

        // Ensure that the user belongs to the same company
        $checkSt = $db->prepare("SELECT id FROM users WHERE id=? AND company_id=?");
        $checkSt->bindValue(1, $uid, SQLITE3_INTEGER);
        $checkSt->bindValue(2, $companyId, SQLITE3_INTEGER);
        $foundUser = $checkSt->execute()->fetchArray(SQLITE3_ASSOC);
        if ($foundUser && $newEmail) {
            if ($newPass !== '') {
                // Update email, password, and role
                $upd = $db->prepare("UPDATE users SET email=?, password=?, role=? WHERE id=?");
                $upd->bindValue(1, $newEmail, SQLITE3_TEXT);
                $upd->bindValue(2, $newPass, SQLITE3_TEXT);
                $upd->bindValue(3, $newRole, SQLITE3_TEXT);
                $upd->bindValue(4, $uid, SQLITE3_INTEGER);
            } else {
                // Update only email and role (keep old password)
                $upd = $db->prepare("UPDATE users SET email=?, role=? WHERE id=?");
                $upd->bindValue(1, $newEmail, SQLITE3_TEXT);
                $upd->bindValue(2, $newRole, SQLITE3_TEXT);
                $upd->bindValue(3, $uid, SQLITE3_INTEGER);
            }
            $upd->execute();
            log_operation($db, $companyId, 'update_user', "Admin updated user #$uid ($newEmail)");
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=manage_users");
        exit;
    }
    // DELETE a user
    elseif ($logged_in && isset($_POST['action']) && $_POST['action'] === 'delete_user'
        && isset($_SESSION['role']) && $_SESSION['role'] === 'admin') {

        $uid = (int)($_POST['user_id'] ?? 0);
        $companyId = (int)$_SESSION['user_id'];

        // Confirm the user is in the same company
        $checkSt = $db->prepare("SELECT id FROM users WHERE id=? AND company_id=?");
        $checkSt->bindValue(1, $uid, SQLITE3_INTEGER);
        $checkSt->bindValue(2, $companyId, SQLITE3_INTEGER);
        $found = $checkSt->execute()->fetchArray(SQLITE3_ASSOC);
        if ($found) {
            $del = $db->prepare("DELETE FROM users WHERE id=?");
            $del->bindValue(1, $uid, SQLITE3_INTEGER);
            $del->execute();
            log_operation($db, $companyId, 'delete_user', "Admin deleted user #$uid");
        }
        header("Location: " . $_SERVER['PHP_SELF'] . "?route=manage_users");
        exit;
    }
    // INSERT / DELETE / UPDATE in route=table
    elseif ($logged_in && isset($_GET['route']) && $_GET['route'] === 'table') {
        $table_name = $_GET['table_name'] ?? '';
        $app_id     = (int)($_GET['app_id'] ?? 0);
        $s1 = $db->prepare("SELECT id FROM company_applications WHERE id=? AND company_id=?");
        $s1->bindValue(1, $app_id, SQLITE3_INTEGER);
        $s1->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
        $oapp = $s1->execute()->fetchArray(SQLITE3_ASSOC);
        if (!$oapp) {
            header("Location: " . $_SERVER['PHP_SELF']);
            exit;
        }
        $s2 = $db->prepare("SELECT id FROM company_tables WHERE application_id=? AND table_name=?");
        $s2->bindValue(1, $app_id, SQLITE3_INTEGER);
        $s2->bindValue(2, $table_name, SQLITE3_TEXT);
        $trow = $s2->execute()->fetchArray(SQLITE3_ASSOC);
        if (!$trow) {
            header("Location: " . $_SERVER['PHP_SELF']);
            exit;
        }
        $table_id = $trow['id'];
        $prefixed = get_prefixed_tablename($db, $table_id);
        $act = $_POST['action'] ?? '';
        // 1) We locate the block that processes each column for insertion (or update).
			//    Something like:

			if ($act === 'insert' || $act === 'update') {
				 $defs = [];
				 $sdef = $db->prepare("SELECT * FROM company_table_columns WHERE table_id=?");
				 $sdef->bindValue(1, $table_id, SQLITE3_INTEGER);
				 $rdef = $sdef->execute();
				 while ($cd = $rdef->fetchArray(SQLITE3_ASSOC)) {
					  $defs[] = $cd;
				 }

				 $insertData = [];

				 foreach ($defs as $cd) {
					  $colN     = $cd['column_name'];
					  if ($colN === 'id') continue;
					  $isM      = (int)$cd['is_multiple'];
					  $isF      = (int)$cd['is_foreign'];
					  $inputType= $cd['input_type'];

					  // The posted param name is base64-encoded column name
					  $encoded = encode_col_name($colN);

					  if ($isM === 1) {
						   // If multiple => stored as JSON
						   $arrVals = $_POST["multi_" . $encoded] ?? [];
						   $insertData[$colN] = json_encode($arrVals);
					  } else if ($isF === 1) {
						   // This is the foreign-key column. We'll check for "0".
						   $val = $_POST["val_" . $encoded] ?? '';
						   if ($val === '0') {
						       // user did not select anything => store NULL
						       $insertData[$colN] = null;
						   } else {
						       // user selected some integer ID => store it as integer
						       $insertData[$colN] = (int)$val;
						   }
					  } 
					  else {
						   // Normal columns or file uploads
						   if ($inputType === 'file') {
						       // (existing code for file uploads)
						   } else {
						       $val = $_POST["val_" . $encoded] ?? '';
						       $insertData[$colN] = $val;
						   }
					  }
				 }

				 // 2) Actually run INSERT or UPDATE
				 //    The easiest approach: for an INSERT we skip "id", for an UPDATE we add "WHERE id=?"
				 if ($act === 'insert') {
					  $cols = array_keys($insertData);
					  $quotedCols = array_map('quote_ident', $cols);
					  $placeholders = implode(',', array_fill(0, count($cols), '?'));
					  $sql = "INSERT INTO " . quote_ident($prefixed)
						    . " (" . implode(',', $quotedCols) . ") VALUES($placeholders)";
					  $pstm = $db->prepare($sql);
					  $i=1;
					  foreach ($insertData as $v) {
						   // If $v===NULL, pass SQLITE3_NULL
						   if (is_null($v)) {
						       $pstm->bindValue($i, null, SQLITE3_NULL);
						   } else {
						       $pstm->bindValue($i, $v, SQLITE3_TEXT);
						   }
						   $i++;
					  }
					  $pstm->execute();
				 } else { // update
					  $row_id = (int)($_POST['row_id'] ?? 0);
					  $cols = array_keys($insertData);
					  $quotedCols = array_map('quote_ident', $cols);
					  $assignments = array_map(fn($c) => "$c=?", $quotedCols);
					  $sql = "UPDATE " . quote_ident($prefixed)
						    . " SET " . implode(', ', $assignments)
						    . " WHERE \"id\"=?";
					  $pstm = $db->prepare($sql);
					  $i=1;
					  foreach ($insertData as $v) {
						   if (is_null($v)) {
						       $pstm->bindValue($i, null, SQLITE3_NULL);
						   } else {
						       $pstm->bindValue($i, $v, SQLITE3_TEXT);
						   }
						   $i++;
					  }
					  $pstm->bindValue($i, $row_id, SQLITE3_INTEGER);
					  $pstm->execute();
				 }
			}

        elseif ($act === 'delete') {
            $rid = (int)($_POST['row_id'] ?? 0);
            if ($rid > 0) {
                $delS = $db->prepare("DELETE FROM " . quote_ident($prefixed) . " WHERE \"id\"=?");
                $delS->bindValue(1, $rid, SQLITE3_INTEGER);
                $delS->execute();
                log_operation($db, $_SESSION['user_id'], 'delete_row', "Deleted row ID: $rid from table ID: $table_id");
            }
        }
        header("Location: " . $_SERVER['PHP_SELF'] . '?route=table&table_name=' . urlencode($table_name) . '&app_id=' . $app_id);
        exit;
    }
} else {
    // LOGOUT
    if (isset($_GET['route']) && $_GET['route'] === 'logout') {
        if (isset($_COOKIE['remember_token'])) {
            $token = $_COOKIE['remember_token'];
            $stmt = $db->prepare("DELETE FROM remember_tokens WHERE token = ?");
            $stmt->bindValue(1, $token, SQLITE3_TEXT);
            $stmt->execute();
            setcookie('remember_token', '', time() - 3600, "/");
            echo '<script>localStorage.removeItem("remember_token");</script>';
        }
        session_unset();
        session_destroy();
        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    }
}
?>


```
## js
**camposdinamicoscreartabla.php**
```php
<script>
    window.onload = function(){
    document.getElementById("show-create-table-form").addEventListener("click", () => {
        const form = document.getElementById("create-table-form");
        form.style.display = (form.style.display==="none") ? "block" : "none";
    });
    document.getElementById("show-create-folder-form").addEventListener("click", () => {
        const form = document.getElementById("create-folder-form");
        form.style.display = (form.style.display==="none") ? "block" : "none";
    });

    const addColumnBtn = document.getElementById("add-column-btn");
    const columnsContainer = document.getElementById("columns-container");

    addColumnBtn.addEventListener("click", () => {
        const newDiv = document.createElement("div");
        newDiv.className = "column-group";
        newDiv.innerHTML = `
            <label>Nombre de columna</label>
            <input type="text" name="columns[]" placeholder="columna" required>

            <label>Tipo de dato</label>
            <select name="data_types[]" required>
                <option value="TEXT">TEXT</option>
                <option value="INTEGER">INTEGER</option>
                <option value="REAL">REAL</option>
                <option value="COLOR">COLOR</option>
            </select>

            <label>Tipo de input</label>
            <select name="input_types[]" required>
                <option value="text">Text</option>
                <option value="number">Number</option>
                <option value="color">Color</option>
                <option value="textarea">Textarea</option>
                <option value="checkbox">Checkbox</option>
                <option value="date">Date</option>
                <option value="email">Email</option>
                <option value="file">File</option>
                <option value="password">Password</option>
                <option value="radio">Radio</option>
                <option value="range">Range</option>
                <option value="tel">Tel</option>
                <option value="time">Time</option>
                <option value="url">URL</option>
                <option value="week">Week</option>
            </select>

            <input type="hidden" name="is_foreign[]" value="0" class="is-foreign-hidden">
            <label>¿Es llave foránea?</label>
            <input type="checkbox" class="is-foreign-checkbox" style="transform:scale(1.3); margin-bottom:8px;">

            <div class="foreign-opts" style="display:none; margin-bottom:8px;">
                <label>Tabla destino:</label>
                <select name="foreign_target[]">
                    <option value="">--Seleccione--</option>
                    <?php
                    foreach($allUserTables as $tinfo) {
                        $appId  = $tinfo['app_id'];
                        $tbl    = $tinfo['table_name'];
                        $label  = $tinfo['app_name'];
                        if ($tinfo['folder_path'] !== '') {
                            $label .= ' - '.$tinfo['folder_path'];
                        }
                        $label .= ' - '.$tbl;
                        $val = $appId.'__'.$tbl;
                        echo '<option value="'.htmlspecialchars($val).'">'
                             .htmlspecialchars($label).'</option>';
                    }
                    ?>
                </select>
            </div>

            <input type="hidden" name="is_multiple[]" value="0" class="is-multiple-hidden">
            <label>¿Multiple?</label>
            <input type="checkbox" class="is-multiple-checkbox" style="transform:scale(1.3);">
        `;
        columnsContainer.appendChild(newDiv);
        attachColumnEvents(newDiv);
    });

    function attachColumnEvents(group) {
        const fcheck = group.querySelector(".is-foreign-checkbox");
        const fopts  = group.querySelector(".foreign-opts");
        const fhid   = group.querySelector(".is-foreign-hidden");
        const mcheck = group.querySelector(".is-multiple-checkbox");
        const mhid   = group.querySelector(".is-multiple-hidden");

        fcheck.addEventListener("change", () => {
            if (fcheck.checked) {
                fopts.style.display = "block";
                fhid.value = "1";
            } else {
                fopts.style.display = "none";
                fhid.value = "0";
            }
        });
        mcheck.addEventListener("change", () => {
            mhid.value = mcheck.checked ? "1" : "0";
        });
    }

    document.querySelectorAll(".column-group").forEach(g => {
        attachColumnEvents(g);
    });
    }
    </script>

```
**creartabla.php**
```php
<script>
window.onload = function(){
    document.getElementById("show-create-table-form").addEventListener("click", () => {
        window.location.href = "<?= $_SERVER['PHP_SELF'].'?route=app&app_id='.$app_id ?>#create-table-form";
    });
    document.getElementById("show-create-folder-form").addEventListener("click", () => {
        window.location.href = "<?= $_SERVER['PHP_SELF'].'?route=app&app_id='.$app_id ?>#create-folder-form";
    });

    const btnNuevo = document.getElementById("nuevo");
    if (btnNuevo) {
        btnNuevo.onclick = function(){
            const tableEl = document.querySelector(".dashboard table");
            if (tableEl) tableEl.style.display = "none";
            const formEl = document.getElementById("formulariocrear");
            if (formEl) formEl.style.display = "block";
            const titleEl = document.getElementById("formtitle");
            if (titleEl) titleEl.style.display = "block";
        }
    }

    document.addEventListener("click", function(e) {
        if (e.target.matches(".add-more-text")) {
            const col = e.target.getAttribute("data-col");
            const container = document.querySelector(".multi-text-" + col);
            if (!container) return;
            const newInput = document.createElement("input");
            newInput.type = "text";
            newInput.name = "multi_<?php echo '"+btoa(col)+"'; ?>[]";
            container.appendChild(newInput);
        } else if (e.target.matches(".add-more-foreign")) {
            const col = e.target.getAttribute("data-col");
            const container = document.querySelector(".multi-items-" + col);
            if (!container) return;
            let existingSelect = container.querySelector("select");
            if (!existingSelect) return;
            let clone = existingSelect.parentNode.cloneNode(true);
            let btnInside = clone.querySelector(".add-more-foreign");
            if (btnInside) {
                btnInside.remove();
            }
            container.appendChild(clone);
        }
    });
}
</script>


```
**edit_fields.js**
```js
// File: /var/www/html/jocarsa-teal/js/edit_fields.js

document.addEventListener('DOMContentLoaded', () => {
    const editableFields = document.querySelectorAll('.editable');

    // Inline editing (text, email, tel, etc.)
    editableFields.forEach(field => {
        field.addEventListener('dblclick', () => {
            const originalContent = field.textContent;
            const inputType = field.getAttribute('data-type') || 'text';
            const input = document.createElement('input');
            input.type = inputType;
            input.value = originalContent;
            input.classList.add('editing-input');
            field.textContent = '';
            field.appendChild(input);
            input.focus();

            input.addEventListener('blur', () => {
                const newContent = input.value.trim();
                if (newContent !== originalContent) {
                    saveFieldChanges(field, newContent);
                }
                field.textContent = newContent;
            });

            input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    input.blur();
                } else if (event.key === 'Escape') {
                    field.textContent = originalContent;
                }
            });
        });
    });

    async function saveFieldChanges(field, newContent) {
        const fieldId = field.getAttribute('data-id');
        const columnName = field.getAttribute('data-column');
        const tableName = field.getAttribute('data-table');
        const appId = field.getAttribute('data-app-id');

        // 'baseUrl' is set in bloques/cabeza.php
        const response = await fetch(baseUrl + "?route=update_field", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ fieldId, columnName, newContent, tableName, appId }),
        });

        if (!response.ok) {
            console.error('Error saving field changes:', response.statusText);
        } else {
            const result = await response.text();
            console.log('Save result:', result);
        }
    }

    // =============== EMAIL MODAL ===============
    const emailModal = document.getElementById('emailModal');
    if (emailModal) {
        const modalToEmail = document.getElementById('modalToEmail');
        const modalSubject = document.getElementById('modalSubject');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModal');
        const emailForm = document.getElementById('emailForm');

        // Show the email modal
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('email-icon')) {
                const emailValue = event.target.getAttribute('data-email') || '';
                modalToEmail.value = emailValue;
                modalSubject.value = '';
                modalMessage.value = '';
                emailModal.style.display = 'block';
            }
        });

        // Close
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                emailModal.style.display = 'none';
            });
        }

        // Send Email (AJAX)
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const toEmail = modalToEmail.value.trim();
            const subject = modalSubject.value.trim();
            const message = modalMessage.value.trim();

            if (!toEmail || !subject || !message) {
                alert('Todos los campos son requeridos.');
                return;
            }

            try {
                const resp = await fetch(baseUrl + "?route=send_email", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ toEmail, subject, message })
                });
                const data = await resp.json();
                if (data.success) {
                    alert('Email enviado exitosamente.');
                    emailModal.style.display = 'none';
                } else {
                    alert('Error al enviar el email: ' + data.error);
                }
            } catch (err) {
                alert('Error inesperado al enviar email.');
                console.error(err);
            }
        });
    }

    // ============ WHATSAPP / PHONE MODAL ============
    const phoneModal = document.getElementById('phoneModal');
    if (phoneModal) {
        const modalToPhone      = document.getElementById('modalToPhone');
        const modalPhoneMessage = document.getElementById('modalPhoneMessage');
        const closePhoneModal   = document.getElementById('closePhoneModal');
        const phoneForm         = document.getElementById('phoneForm');

        // Show phone modal
        document.addEventListener('click', (event) => {
            if (event.target.classList.contains('phone-icon')) {
                const phoneValue = event.target.getAttribute('data-phone') || '';
                modalToPhone.value      = phoneValue;
                modalPhoneMessage.value = '';
                phoneModal.style.display = 'block';
            }
        });

        // Close
        if (closePhoneModal) {
            closePhoneModal.addEventListener('click', () => {
                phoneModal.style.display = 'none';
            });
        }

        // Submit => log in DB + open web.whatsapp.com
        phoneForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let phone   = modalToPhone.value.trim();
            let message = modalPhoneMessage.value.trim();

            if (!phone || !message) {
                alert('Todos los campos son requeridos.');
                return;
            }

            // 1) Log in our DB by calling route=send_whatsapp
            try {
                const resp = await fetch(baseUrl + "?route=send_whatsapp", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, message })
                });
                const data = await resp.json();
                if (!data.success) {
                    console.warn("Advertencia: no se guardó WhatsApp en la BD =>", data.error);
                }
            } catch (err) {
                console.error("Error registrando WhatsApp en BD =>", err);
            }

            // 2) Force open WhatsApp Web in new tab
            let url = "https://web.whatsapp.com/send?phone=" + phone + "&text=" + encodeURIComponent(message);
            window.open(url, '_blank');

            // Hide the modal
            phoneModal.style.display = 'none';
        });
    }
});


```
## log
## rutas
**aplicacion.php**
```php
<?php

 // ... (code for route 'app' remains as in your original file, with similar gear icon additions)
    $app_id = (int)$_GET['app_id'];
    $st = $db->prepare("SELECT id, application_name FROM company_applications WHERE id=? AND company_id=?");
    $st->bindValue(1, $app_id, SQLITE3_INTEGER);
    $st->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
    $appRow = $st->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$appRow) exit("App not found or not yours.");

    $folderTree = build_folder_tree($db, $app_id);
    $allUserTables = get_all_user_tables($db, $_SESSION['user_id']);
    ?>
    <header>
        <?php include "bloques/cabeceraaplicacion.php";?>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings" style="margin-left:10px; font-size:18px; text-decoration:none;">&#9881;</a>
    </header>
    <main>
        <nav>
            <?php include "bloques/navegacionaplicacion.php";?>
        </nav>
        <section class="dashboard">
            <h2>Estructura de la aplicación "<?= htmlspecialchars($appRow['application_name']) ?>"</h2>
            <p>Selecciona una carpeta o tabla existente, o crea algo nuevo:</p>

            <?php include "bloques/definirtabla.php"; ?>
            <?php include "bloques/crearcarpeta.php"; ?>

            <hr>
            <h3>Renombrar / Eliminar Aplicación</h3>
            <form method="post" style="margin-bottom:15px;">
                <input type="hidden" name="application_id" value="<?= (int)$app_id ?>">
                <input type="text" name="new_application_name" placeholder="Nuevo nombre" required>
                <button type="submit" name="action" value="rename_application">Renombrar</button>
            </form>
            <form method="post">
                <input type="hidden" name="application_id" value="<?= (int)$app_id ?>">
                <button type="submit" name="action" value="delete_application" style="background:red;" >
                    Eliminar aplicación
                </button>
            </form>
        </section>
    </main>

    <form method="post" id="rename-folder-form" style="display:none;">
        <input type="hidden" name="action" value="rename_folder">
        <input type="hidden" name="app_id" value="<?php echo (int)$app_id; ?>">
        <input type="hidden" name="folder_id" value="">
        <input type="hidden" name="new_folder_name" value="">
    </form>

```
**crearusuarios.php**
```php
<?php
?>
    <header>
        <h1 class="corporativo">
            <img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal
        </h1>
        <!-- gear icon -->
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings"
           style="margin-right:10px; font-size:18px; text-decoration:none;">
           &#9881;
        </a>

        <a href="<?= $_SERVER['PHP_SELF'].'?route=logout' ?>">
            <span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span>
        </a>
    </header>
    <main style="flex:1; display:flex; align-items:center; justify-content:center; padding:20px;">
        <div class="form-container">
            <h2>Crear Usuario</h2>
            <form method="post" action="<?= $_SERVER['PHP_SELF'] ?>">
                <!-- triggers correct branch in inc/manejadorPost.php -->
                <input type="hidden" name="action" value="create_user">

                <input type="email" name="user_email" placeholder="Email del Usuario" required>
                <input type="password" name="user_password" placeholder="Contraseña" required>

                <label for="user_role">Rol:</label>
                <select name="user_role" id="user_role">
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                </select>
                <button type="submit">Crear usuario</button>
            </form>
        </div>
    </main>
    <?php
?>

```
**enviarmail.php**
```php
<?php
/**
 * NEW: If the route is send_email (and request method is POST),
 * handle it here and exit before any HTML is sent.
 */
if ($logged_in && $route === 'send_email' && $_SERVER['REQUEST_METHOD'] === 'POST') {
    header('Content-Type: application/json');
    $raw = file_get_contents('php://input');
    $data = json_decode($raw, true);
    $toEmail = $data['toEmail'] ?? '';
    $subject = $data['subject'] ?? '';
    $messageBody = $data['message'] ?? '';

    if (!$toEmail || !$subject || !$messageBody) {
        echo json_encode(['success' => false, 'error' => 'Faltan datos']);
        exit;
    }

    try {
        $companyId = (int)$_SESSION['user_id'];
        $fromName  = $_SESSION['company_name'] ?? 'Mi Empresa';

        // Use NULL for user_id if there is no corresponding user row.
        $loggedUserId = null;
        manual_smtp_send($db, $companyId, $fromName, $toEmail, $subject, $messageBody);

        $stm = $db->prepare("INSERT INTO sent_emails (company_id, user_id, recipient_email, subject, message) VALUES (?,?,?,?,?)");
        $stm->bindValue(1, $companyId, SQLITE3_INTEGER);
        $stm->bindValue(2, $loggedUserId, SQLITE3_NULL);
        $stm->bindValue(3, $toEmail, SQLITE3_TEXT);
        $stm->bindValue(4, $subject, SQLITE3_TEXT);
        $stm->bindValue(5, $messageBody, SQLITE3_TEXT);
        $stm->execute();

        echo json_encode(['success' => true]);
    } catch (Exception $ex) {
        echo json_encode(['success' => false, 'error' => $ex->getMessage()]);
    }
    exit;
}
?>

```
**gestionarusuarios.php**
```php
<?php
// 1. company ID
    $companyId = (int)$_SESSION['user_id'];

    // 2. Fetch users
    $stmtUsers = $db->prepare("
        SELECT id, email, role
        FROM users
        WHERE company_id = ?
        ORDER BY email
    ");
    $stmtUsers->bindValue(1, $companyId, SQLITE3_INTEGER);
    $resUsers = $stmtUsers->execute();

    $userRows = [];
    while ($u = $resUsers->fetchArray(SQLITE3_ASSOC)) {
        $userRows[] = $u;
    }

    // If editing a user:
    $edit_id = isset($_GET['edit_id']) ? (int)$_GET['edit_id'] : 0;
    $editData = null;
    if ($edit_id > 0) {
        $stmtOne = $db->prepare("SELECT id, email, role FROM users WHERE id=? AND company_id=?");
        $stmtOne->bindValue(1, $edit_id, SQLITE3_INTEGER);
        $stmtOne->bindValue(2, $companyId, SQLITE3_INTEGER);
        $editData = $stmtOne->execute()->fetchArray(SQLITE3_ASSOC);
        if (!$editData) {
            $edit_id = 0;
        }
    }

    ?>
    <header>
        <h1 class="corporativo">
            <img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal
        </h1>
        <!-- gear icon -->
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings"
           style="margin-right:10px; font-size:18px; text-decoration:none;">
           &#9881;
        </a>

        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=logout">
            <span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span>
        </a>
    </header>

    <main style="padding:20px;">
        <h2>Gestión de Usuarios</h2>

        <!-- List of existing users -->
        <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
            <thead>
                <tr style="background:#ddd;">
                    <th style="padding:8px;">ID</th>
                    <th style="padding:8px;">Email</th>
                    <th style="padding:8px;">Rol</th>
                    <th style="padding:8px;">Acciones</th>
                </tr>
            </thead>
            <tbody>
            <?php foreach ($userRows as $row): ?>
                <tr>
                    <td style="padding:8px;"><?= (int)$row['id'] ?></td>
                    <td style="padding:8px;"><?= htmlspecialchars($row['email']) ?></td>
                    <td style="padding:8px;"><?= htmlspecialchars($row['role']) ?></td>
                    <td style="padding:8px;">
                        <!-- Edit user link -->
                        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=manage_users&edit_id=<?= (int)$row['id'] ?>">
                            <button style="background:orange;">Editar</button>
                        </a>
                        <!-- Delete user form -->
                        <?php if ($row['id'] !== $edit_id): ?>
                            <form method="post" style="display:inline-block"
                                  onsubmit="return confirm('¿Eliminar este usuario?');">
                                <input type="hidden" name="action" value="delete_user">
                                <input type="hidden" name="user_id" value="<?= (int)$row['id'] ?>">
                                <button type="submit" style="background:red;">Borrar</button>
                            </form>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>

        <!-- If editing, show 'Update User' form, else 'Add new user' form -->
        <div class="form-container" style="max-width:400px;">
            <?php if ($edit_id > 0 && $editData): ?>
                <h3>Editar Usuario #<?= (int)$editData['id'] ?></h3>
                <form method="post">
                    <input type="hidden" name="action" value="update_user">
                    <input type="hidden" name="user_id" value="<?= (int)$editData['id'] ?>">

                    <input type="email" name="user_email"
                           value="<?= htmlspecialchars($editData['email']) ?>" required>
                    <input type="text" name="user_password" placeholder="(Opcional) Nueva Contraseña">
                    
                    <label for="role">Rol:</label>
                    <select name="user_role" id="role">
                        <option value="admin" <?= $editData['role']==='admin'?'selected':'' ?>>admin</option>
                        <option value="user"  <?= $editData['role']==='user' ?'selected':'' ?>>user</option>
                    </select>
                    <button type="submit">Actualizar</button>
                </form>
            <?php else: ?>
                <h3>Crear Usuario Nuevo</h3>
                <form method="post">
                    <input type="hidden" name="action" value="create_user_admin">
                    <input type="email" name="user_email" placeholder="Email" required>
                    <input type="password" name="user_password" placeholder="Contraseña" required>
                    
                    <label for="role">Rol:</label>
                    <select name="user_role" id="role">
                        <option value="admin">admin</option>
                        <option value="user">user</option>
                    </select>
                    <button type="submit">Crear</button>
                </form>
            <?php endif; ?>
        </div>
    </main>
    <?php
?>

```
**mailsenviados.php**
```php
<?php
$companyId = (int)$_SESSION['user_id'];
    $q = $db->prepare("SELECT * FROM sent_emails WHERE company_id=? ORDER BY date_sent DESC");
    $q->bindValue(1, $companyId, SQLITE3_INTEGER);
    $res = $q->execute();
    $rows = [];
    while($r = $res->fetchArray(SQLITE3_ASSOC)) {
        $rows[] = $r;
    }
    ?>
    <header>
        <h1 class="corporativo">
            <img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal
        </h1>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings" style="margin-right:10px; font-size:18px; text-decoration:none;">&#9881;</a>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=logout">
            <span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span>
        </a>
    </header>
    <main style="padding:20px;">
        <h2>Emails Enviados</h2>
        <?php if (empty($rows)): ?>
            <p>No hay emails enviados en la base de datos.</p>
        <?php else: ?>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f0f0f0;">
                        <th>ID</th>
                        <th>Para</th>
                        <th>Asunto</th>
                        <th>Mensaje</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                <?php foreach ($rows as $rw): ?>
                    <tr>
                        <td style="border:1px solid #ccc; padding:8px;"><?= $rw['id'] ?></td>
                        <td style="border:1px solid #ccc; padding:8px;"><?= htmlspecialchars($rw['recipient_email']) ?></td>
                        <td style="border:1px solid #ccc; padding:8px;"><?= htmlspecialchars($rw['subject']) ?></td>
                        <td style="border:1px solid #ccc; padding:8px; white-space:pre-wrap;"><?= nl2br(htmlspecialchars($rw['message'])) ?></td>
                        <td style="border:1px solid #ccc; padding:8px;"><?= $rw['date_sent'] ?></td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </main>
    <?php
?>

```
**parametroscompania.php**
```php
<?php
// Company settings form.
    if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') {
        exit("No permission to edit company settings.");
    }
    $cid = (int)$_SESSION['user_id'];
    $stc = $db->prepare("SELECT smtp_server, smtp_port, smtp_user, smtp_pass, imap_server FROM company WHERE id=?");
    $stc->bindValue(1, $cid, SQLITE3_INTEGER);
    $config = $stc->execute()->fetchArray(SQLITE3_ASSOC);
    if (isset($_GET['action']) && $_GET['action']==='save_settings' && $_SERVER['REQUEST_METHOD']==='POST') {
        $smtp_server = $_POST['smtp_server'] ?? '';
        $smtp_port   = (int)($_POST['smtp_port'] ?? 465);
        $smtp_user   = $_POST['smtp_user'] ?? '';
        $smtp_pass   = $_POST['smtp_pass'] ?? '';
        $imap_server = $_POST['imap_server'] ?? '';

        $upd = $db->prepare("UPDATE company SET smtp_server=?, smtp_port=?, smtp_user=?, smtp_pass=?, imap_server=? WHERE id=?");
        $upd->bindValue(1, $smtp_server, SQLITE3_TEXT);
        $upd->bindValue(2, $smtp_port,   SQLITE3_INTEGER);
        $upd->bindValue(3, $smtp_user,   SQLITE3_TEXT);
        $upd->bindValue(4, $smtp_pass,   SQLITE3_TEXT);
        $upd->bindValue(5, $imap_server, SQLITE3_TEXT);
        $upd->bindValue(6, $cid,         SQLITE3_INTEGER);
        $upd->execute();

        log_operation($db, $cid, 'update_company_settings', "Updated SMTP/IMAP config");
        header("Location: ".$_SERVER['PHP_SELF']."?route=company_settings");
        exit;
    }
    ?>
    <header>
        <h1 class="corporativo">
            <img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal
        </h1>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=logout" style="margin-left:10px;">
            <span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span>
        </a>
    </header>
    <main style="padding:20px;">
        <h2>Configuración de la Empresa (SMTP / IMAP)</h2>
        <form method="post" action="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings&action=save_settings">
            <label>SMTP Server:</label>
            <input type="text" name="smtp_server" value="<?= htmlspecialchars($config['smtp_server'] ?? '') ?>" required>

            <label>SMTP Port:</label>
            <input type="number" name="smtp_port" value="<?= htmlspecialchars($config['smtp_port'] ?? '465') ?>" required>

            <label>SMTP User:</label>
            <input type="text" name="smtp_user" value="<?= htmlspecialchars($config['smtp_user'] ?? '') ?>" required>

            <label>SMTP Password:</label>
            <input type="password" name="smtp_pass" value="<?= htmlspecialchars($config['smtp_pass'] ?? '') ?>" required>

            <label>IMAP Server (opcional):</label>
            <input type="text" name="imap_server" value="<?= htmlspecialchars($config['imap_server'] ?? '') ?>">

            <button type="submit">Guardar Configuración</button>
        </form>
    </main>
    <?php
?>

```
**tabla.php**
```php
<?php
// ... (existing code for route=table remains unchanged)
    $table_name = $_GET['table_name'];
    $app_id     = (int)$_GET['app_id'];

    $stApp = $db->prepare("SELECT id, application_name FROM company_applications WHERE id=? AND company_id=?");
    $stApp->bindValue(1, $app_id, SQLITE3_INTEGER);
    $stApp->bindValue(2, $_SESSION['user_id'], SQLITE3_INTEGER);
    $appRow = $stApp->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$appRow) exit('App not found or not yours.');

    $stTab = $db->prepare("SELECT id FROM company_tables WHERE application_id=? AND table_name=?");
    $stTab->bindValue(1, $app_id, SQLITE3_INTEGER);
    $stTab->bindValue(2, $table_name, SQLITE3_TEXT);
    $tRow = $stTab->execute()->fetchArray(SQLITE3_ASSOC);
    if (!$tRow) exit('Table not found in that app.');
    $table_id = $tRow['id'];
    $prefixed = get_prefixed_tablename($db, $table_id);

    $folderTree = build_folder_tree($db, $app_id);

    $colDefs = [];
    $cstm = $db->prepare("SELECT * FROM company_table_columns WHERE table_id=?");
    $cstm->bindValue(1, $table_id, SQLITE3_INTEGER);
    $cr = $cstm->execute();
    $allowedCols = [];
    while($cd=$cr->fetchArray(SQLITE3_ASSOC)) {
        $colDefs[] = $cd;
        $allowedCols[] = $cd['column_name'];
    }

    $sort_col = $_GET['sort_col'] ?? 'id';
    $sort_dir = $_GET['sort_dir'] ?? 'ASC';
    if (!in_array($sort_col, $allowedCols)) {
        $sort_col = 'id';
    }
    $sort_dir = strtoupper($sort_dir);
    if ($sort_dir !== 'ASC' && $sort_dir !== 'DESC') {
        $sort_dir = 'ASC';
    }

    $searchTerm = trim($_GET['search'] ?? '');
    $whereClause = '';
    $bindSearch = false;
    if ($searchTerm !== '') {
        $searchParts = [];
        foreach ($colDefs as $cd) {
            $cn = $cd['column_name'];
            if ($cn === 'id') continue;
            $searchParts[] = quote_ident($cn)." LIKE :searchVal";
        }
        if (!empty($searchParts)) {
            $whereClause = "WHERE (".implode(" OR ", $searchParts).")";
            $bindSearch = true;
        }
    }

    $page = max(1, (int)($_GET['page'] ?? 1));
    $limit = 50;
    $offset = ($page - 1) * $limit;

    $countSql = "SELECT COUNT(*) as cnt FROM ".quote_ident($prefixed)." ".$whereClause;
    $stmtCount = $db->prepare($countSql);
    if ($bindSearch) {
        $stmtCount->bindValue(':searchVal','%'.$searchTerm.'%', SQLITE3_TEXT);
    }
    $countRes = $stmtCount->execute()->fetchArray(SQLITE3_ASSOC);
    $totalRows = $countRes ? $countRes['cnt'] : 0;
    $totalPages = ceil($totalRows / $limit);

    $mainSql = "SELECT * FROM ".quote_ident($prefixed).
                " $whereClause
                ORDER BY ".quote_ident($sort_col)." $sort_dir
                LIMIT $limit OFFSET $offset";
    $mainStmt = $db->prepare($mainSql);
    if ($bindSearch) {
        $mainStmt->bindValue(':searchVal','%'.$searchTerm.'%', SQLITE3_TEXT);
    }
    $qr = @$mainStmt->execute();

    $rows = [];
    if ($qr) {
        while($rw=$qr->fetchArray(SQLITE3_ASSOC)) {
            $rows[] = $rw;
        }
    }

    $editing = false;
    $editData = [];
    $edit_id = isset($_GET['edit_id']) ? (int)$_GET['edit_id'] : 0;
    if ($edit_id > 0) {
        $stmtEdit = $db->prepare("SELECT * FROM " . quote_ident($prefixed) . " WHERE \"id\"=?");
        $stmtEdit->bindValue(1, $edit_id, SQLITE3_INTEGER);
        $resEdit = $stmtEdit->execute();
        $tmpData = $resEdit->fetchArray(SQLITE3_ASSOC);
        if ($tmpData) {
            $editing = true;
            $editData = $tmpData;
        }
    }
?>

```
**whatsappsenviados.php**
```php
<?php
$companyId = (int)$_SESSION['user_id'];
    $q = $db->prepare("SELECT * FROM sent_whatsapp WHERE company_id=? ORDER BY date_sent DESC");
    $q->bindValue(1, $companyId, SQLITE3_INTEGER);
    $res = $q->execute();
    $rows = [];
    while($r = $res->fetchArray(SQLITE3_ASSOC)) {
        $rows[] = $r;
    }
    ?>
    <header>
        <h1 class="corporativo">
            <img src="https://static.jocarsa.com/logos/teal.png" id="logo">jocarsa | teal
        </h1>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=company_settings" style="margin-right:10px; font-size:18px; text-decoration:none;">&#9881;</a>
        <a href="<?= $_SERVER['PHP_SELF'] ?>?route=logout">
            <span class="jocarsa-icon jocarsa-icon-cerrarsesion"></span>
        </a>
    </header>
    <main style="padding:20px;">
        <h2>WhatsApp Enviados</h2>
        <?php if (empty($rows)): ?>
            <p>No hay WhatsApps enviados en la base de datos.</p>
        <?php else: ?>
            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f0f0f0;">
                        <th>ID</th>
                        <th>Teléfono</th>
                        <th>Mensaje</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                <?php foreach ($rows as $rw): ?>
                    <tr>
                        <td style="border:1px solid #ccc; padding:8px;"><?= $rw['id'] ?></td>
                        <td style="border:1px solid #ccc; padding:8px;"><?= htmlspecialchars($rw['phone']) ?></td>
                        <td style="border:1px solid #ccc; padding:8px; white-space:pre-wrap;">
                            <?= nl2br(htmlspecialchars($rw['message'])) ?>
                        </td>
                        <td style="border:1px solid #ccc; padding:8px;"><?= $rw['date_sent'] ?></td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </main>
    <?php
?>

```
## static
**report.css**
```css
/* Reset some basic elements */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Overall body styling */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f2f2f2;
  color: #333;
  line-height: 1.6;
  padding-bottom: 40px;
}

/* Header styling */
header {
  background-color: #00796b;
  color: #fff;
  padding: 15px 20px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
}

header h1 {
  margin: 5px 0;
  font-size: 1em;
}

header h1#nombretabla a {
  color: #e0f2f1;
  text-decoration: none;
}

header h1#nombretabla a:hover {
  text-decoration: underline;
}

/* Logo and secondary header */
header h1 img#logo {
  height: 40px;
  vertical-align: middle;
  margin-right: 10px;
}

/* Header links */
header a {
  color: #fff;
  text-decoration: none;
  margin-left: 15px;
  font-weight: bold;
  transition: opacity 0.3s ease;
}

header a:hover {
  opacity: 0.8;
}

/* Main container */
main {
  padding: 20px;
  max-width: 95%;
  margin: 30px auto;
  background: #fff;
  border-radius: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

/* Report title */
main h2 {
  margin-bottom: 20px;
  color: #00796b;
  border-bottom: 2px solid #00796b;
  padding-bottom: 8px;
  font-size: 1.3em;
}

/* Primary table styling */
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}
table{
	width:100% !important;
}
table tr {
  border-bottom: 1px solid #ccc;
}

table th,
table td {
  padding: 10px;
  text-align: left;
  vertical-align: top;
}

/* Header cells in main table */
table th {
  background: #f9f9f9;
  font-weight: bold;
}

/* Nested inner tables (for Alumno, Empresa details) */
table table {
  width: 100%;
  border: 1px solid #ccc;
  border-collapse: collapse;
  margin-top: 5px;
  font-size: 0.9em;
}

table table th,
table table td {
  padding: 8px;
  border: none;
}

table table th {
  background: #f1f1f1;
  width: 35%;
}

/* Example styling for the color preview div */
table td div {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 1px solid #000;
  margin-right: 8px;
}

/* Additional utility for icons (if needed) */
.jocarsa-icon {
  font-size: 1.2em;
}


```
**styles.css**
```css
@import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap');

/* Basic Reset */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

/* Global Styles */
body {
    font-family: 'Ubuntu', Arial, sans-serif;
    background: #f3f4f6;
    color: #333;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

a {
    text-decoration: none;
    color: inherit;
    transition: color 0.2s;
}

a:hover {
    color: #004C4C;
}

/* Header */
header {
    background: teal;
    color: #ffffff;
    padding: 15px 30px;
    font-size: 1.5rem;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position:relative;
    gap:20px;
}
header * {
    font-size:18px;
}

header h1 {
    display: flex;
    align-items: center;
    gap: 20px;
}

header #logo {
    width: 70px;
}

header a {
    color: white;
    font-size: 1rem;
    font-weight: normal;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background 0.3s;
}

header a:hover {
    background: rgba(255,255,255,0.2);
}

/* Main Layout */
main {
    display: flex;
    flex: 1;
}

/* Navigation */
nav {
    width: 350px;
    background: teal;
    color: #ffffff;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    position:relative;
    z-index:1000;
    justify-content: space-between;
}

nav h2 {
    font-size: 1.2rem;
    margin-bottom: 10px;
    font-weight: 500;
}

nav a button {
    display: block;
    width: 100%;
    text-align: left;
    background: #20B2AA;
    background:none !important;
    border: none;
    padding: 3px 15px;
    font-size: 1rem;
    font-weight: 500;
    color: #ffffff;
    border-radius: 4px;
    margin-top: 0;
    transition: background 0.3s, transform 0.1s;
    cursor: pointer;
}

nav a button:hover {
    background: #008080;
    transform: translateY(-1px);
}

nav #create-table-btn,
nav #show-create-table-form,
nav #create-folder-btn,
nav #show-create-folder-form {
    margin-top: 10px;
}

/* Button Styles */
button {
    padding: 12px 15px;
    font-size: 1rem;
    font-weight: 600;
    color: #ffffff;
    background: #20B2AA;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s, transform 0.1s;
    margin-top: 10px;
    width:100%;
}

button:hover {
    background: #008080;
    transform: translateY(-1px);
}

/* Dashboard */
.dashboard {
    flex: 1;
    padding: 30px;
    background: #ffffff;
    border-radius: 4px;
    margin: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position:relative;
}

.dashboard h2 {
    font-size: 1.4rem;
    color: #23282d;
    margin-bottom: 20px;
    font-weight: 500;
}

.dashboard table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    font-size: 0.95rem;
}

.dashboard table th,
.dashboard table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}

.dashboard table th {
    background-color: #f4f4f4;
    color: #333;
    font-weight: 600;
}

.dashboard table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.dashboard table tr:hover {
    background-color: #f1f1f1;
}

.dashboard form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Form Elements */
input, select, textarea {
    padding: 10px;
    font-size: 0.9rem;
    border: 1px solid #ccd0d4;
    border-radius: 4px;
    background: #f9f9f9;
    transition: border-color 0.2s, background-color 0.2s;
    width: 100%;
    /*margin-bottom:10px;*/
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #20B2AA;
    background: #ffffff;
}

.column-definition,
.column-group {
    display: flex;
    flex-direction: column;
    background: #f9f9f9;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 4px;
}

.column-group > label {
    font-weight: 500;
    margin: 5px 0 2px;
    color:teal;
}

.column-group .foreign-opts {
    margin-top: 10px;
    padding: 10px;
    background: #f0f8f8;
    border: 1px solid #cceeee;
    border-radius: 4px;
}

.column-group .foreign-opts label {
    margin-top: 8px;
    font-weight: 500;
}

.column-group .is-foreign-checkbox {
    margin-left: 10px;
    transform: scale(1.2);
    vertical-align: middle;
}

.columns-container {
    display: grid;
    grid-template-columns: auto auto auto;
    column-count:2;
    gap: 10px;
}

.dashboard form button {
    align-self: flex-start;
}

/* Login / Signup Forms */
.formularios {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    padding: 20px;
    background: #f3f4f6;
}

.formularios img {
    width: 200px;
    margin-bottom: 20px;
}

.formularios h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    color: teal;
    font-weight: 700;
}

.formularios h2 {
    margin-bottom: 20px;
    color: #333;
    font-weight: 500;
}

.form-container {
    background: #ffffff;
    border: 1px solid #dcdcdc;
    border-radius: 6px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin: 20px;
    width: 100%;
    max-width: 400px;
}

.form-container h2 {
    font-size: 1.2rem;
    margin-bottom: 20px;
    font-weight: 500;
    color: #333;
}

.form-container input {
    width: 100%;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

/* Additional Styles for Buttons inside form-container */
.form-container button {
    width: 100%;
    margin: 15px 0 0;
}

/* Custom Logo and Table Title */
#nombretabla {
    background: white;
    color: teal !important;
    padding: 10px 50px;
    border-radius: 50px;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
#nombretabla a{
	color: teal !important;
}

/* Nested UL for folder-tree */
nav ul li {
    margin-bottom: 4px;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    main {
        flex-direction: column;
    }

    nav {
        
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
    }

    nav h2 {
        width: 100%;
    }

    .dashboard {
        margin: 20px 0;
    }

    .form-container {
        margin: 20px 0;
    }
}

/* Dynamic color override */
header {
    background: var(--main-color);
}

nav {
    background: var(--main-color);
}

nav a button {
    background: #20B2AA;
}

button {
    background: #20B2AA;
}

nav li form{
    float:right;
}
.acciones{
    width:150px;
    text-align:center !important;

}
.acciones .contieneacciones{
	 display:flex;
    gap:10px;
}
.acciones form{
    text-align:center !important;
}
.acciones .contieneacciones form button,
.acciones .contieneacciones form a{
display:block;
	width:30px !important;
	height:30px !important;
	margin:auto !important;
}
nav li form button, .botoneditar{
    width:20px;
    height:20px;
}
nav li form button span,.botoneditar span,.botoneliminar span{
    width:100% !important;
    height:100% !important;
}
.conjuntocampos{
    padding:30px;
    box-sizing:border-box;
    border-radius:10px;
    border:1px solid lightgrey;
    column-count:2;
    column-gap:40px;
}
.botoneliminar{
    width:20px;
    height:20px;
    padding: 5px;
    line-height: 9px;
    margin:auto;
}
.naveliminar{
    opacity:0.2;
}
.naveliminar:hover{
    opacity:1;
    background:red !important;
}
#registrate{
	display:none;
}
header form button{
	display:none;
}
#nuevo{
	position:absolute;
	bottom:20px;
	right:20px;
	width:50px;
	height:50px;
	border-radius:50px;
	background:teal;
	color:white;
	font-size:50px;
	text-align:center;
	line-height:36px;
	font-weight:bold;
	border:5px solid white;
	box-sizing:border-box;
	box-shadow:0px 5px 10px teal;
}
col {
    width: 1fr; /* Set equal width for each column */
  }
  section table table{
  	table-layout: fixed;
  }
  .corporativo{
  	width:350px;
  }
  thead tr th{
  	background:teal !important;
  	color:white !important;
  }

  thead tr th a{
  	color:white !important;
  	text-decoration:none !important;
  }

/* Print Styles */
@media print {
    header form,nav,header>a {
        display: none !important;
    }
    main {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
    }
    body {
        background: #fff !important;
    }
    #nombretabla {
        display: block !important;
        position: relative !important;
        margin-top: 20px !important;
    }
    .dashboard h2 {
        display: block !important;
        margin-top: 20px !important;
    }
}
/* ================================
   ADDITIONAL/EXTENDED STYLES
   FOR USER MANAGEMENT
   ================================ */

/* Section / container that holds the user management content */
.manage-users-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  background: #ffffff;
  border-radius: 4px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Title for user management sections */
.manage-users-container h2 {
  font-size: 1.5rem;
  color: #23282d;
  margin-bottom: 20px;
  font-weight: 500;
}

/* For the table listing users */
.manage-users-container table.user-list-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.manage-users-container table.user-list-table thead tr {
  background: #ddd;
}

.manage-users-container table.user-list-table thead th,
.manage-users-container table.user-list-table tbody td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: left;
}

.manage-users-container table.user-list-table tbody tr:nth-child(even) {
  background: #f9f9f9;
}

.manage-users-container table.user-list-table tbody tr:hover {
  background: #f1f1f1;
}

/* Action buttons in each row (Edit, Delete) */
.manage-users-container td form,
.manage-users-container td a {
  display: inline-block;
  margin: 0 2px;
}

.manage-users-container td button {
  padding: 6px 10px;
  font-size: 0.85rem;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  transition: background 0.3s;
}

.manage-users-container td button:hover {
  opacity: 0.8;
}

/* Example color variations for action buttons */
.manage-users-container td button[style*="background:orange"] {
  background: #FFA500; /* “Editar” button */
  color: #fff;
}

.manage-users-container td button[style*="background:red"] {
  background: #e53935; /* “Borrar” button */
  color: #fff;
}

/* The .form-container for creating/editing users */
.manage-users-container .form-container {
  background: #fff;
  border: 1px solid #dcdcdc;
  border-radius: 6px;
  box-shadow: none; /* We can keep or remove a shadow if we want a simpler look */
  padding: 20px;
  width: 100%;
  max-width: 400px;
}

/* Titles in the form container */
.manage-users-container .form-container h3 {
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 1.1rem;
  color: #333;
}

/* Inputs in the user form (email, password, etc.) */
.manage-users-container .form-container input,
.manage-users-container .form-container select {
  width: 100%;
  margin-bottom: 15px;
  font-size: 0.9rem;
  padding: 10px;
  border: 1px solid #ccd0d4;
  border-radius: 4px;
  background: #f9f9f9;
  transition: border-color 0.2s, background-color 0.2s;
}

.manage-users-container .form-container input:focus,
.manage-users-container .form-container select:focus {
  outline: none;
  border-color: #20B2AA;
  background: #ffffff;
}

/* The “Crear / Actualizar” button in the form */
.manage-users-container .form-container button {
  width: auto;
  background: #20B2AA;
  color: #fff;
  padding: 10px 15px;
  margin-top: 5px;
  border: none;
  border-radius: 4px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s, transform 0.1s;
}

.manage-users-container .form-container button:hover {
  background: #008080;
  transform: translateY(-1px);
}

/* A bit more spacing between the table and the form container if needed */
.manage-users-container .form-container {
  margin-top: 30px;
}

/* If you need a custom style specifically for an “Update” button, you can do: */
.manage-users-container .form-container button.update-btn {
  background: orange;
}
.manage-users-container .form-container button.update-btn:hover {
  background: darkorange;
}
.aplicacion h3{
	font-size:120px;
}
nav .botoneditar{
	opacity:0.0;
	transition:all 1s;
}
nav .botoneditar:hover{
	opacity:1;
	transition:all 1s;
}
.email-icon {
  margin-left: 8px;
  cursor: pointer;
  font-size: 1.2em;
}

/* Basic modal styling (in addition to inline styles in tabla.php):
   You can also put the style here instead of inline. */
#emailModal {
  display: none; 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%);
  background: #fff; 
  border: 2px solid #333; 
  padding: 20px; 
  z-index: 9999; 
  width: 400px; 
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
}
#emailModal h3 {
  margin-bottom: 10px;
}
#emailModal form input,
#emailModal form textarea {
  width: 100%;
  margin-bottom: 10px;
}
.phone-icon {
  margin-left: 8px;
  cursor: pointer;
  font-size: 1.2em;
}


```
### uploads